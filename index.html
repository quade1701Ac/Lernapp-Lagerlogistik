<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lernapp Lagerlogistik</title>
  <link rel="icon" href="https://ebqfupcivmkbuadbbnwg.supabase.co/storage/v1/object/public/app-assets/logo.png" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg: #0b0e14;
      --panel: rgba(25,28,35,.9);
      --text: #e9edf3;
      --muted: #a9b2c0;
      --brand: #2eaadc;
      --brand2:#ff9e3b;
      --line: rgba(255,255,255,.06);
      --shadow: 0 10px 28px rgba(0,0,0,.35);
    }
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text); font:15px/1.5 system-ui,Segoe UI,Roboto,Arial;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .topbar{
      display:flex; align-items:center; gap:18px;
      padding:12px 16px; position:sticky; top:0; z-index:10;
      background: linear-gradient(180deg, rgba(11,14,20,.95), rgba(11,14,20,.75));
      border-bottom:1px solid var(--line);
      backdrop-filter: saturate(140%) blur(8px);
    }
    .topbar img{height:28px; width:28px; border-radius:6px}
    .topbar h1{font-size:16px; margin:0; font-weight:700}
    .nav{margin-left:auto; display:flex; flex-wrap:wrap; gap:8px}
    .btn{
      padding:8px 12px; border-radius:999px; border:1px solid var(--line);
      background:#12151c; color:var(--text); cursor:pointer;
    }
    .btn:hover{border-color:#2d3748}
    .btn--brand{background:linear-gradient(90deg,#43b6f0,#2eaadc); border-color:transparent}
    .btn--ghost{background:transparent}
    .container{max-width:1100px; margin:22px auto; padding:0 16px}
    .panel{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:14px; box-shadow:var(--shadow);
      padding:18px; margin-bottom:16px;
    }
    .panel h2{margin:0 0 10px; font-size:18px}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    label{font-size:13px; color:var(--muted)}
    input,select,textarea{
      background:#12151c; border:1px solid var(--line); color:var(--text);
      border-radius:10px; padding:8px 10px; outline:none;
    }
    select option{background:#12151c; color:var(--text)}
    .muted{color:var(--muted)}
    .hide{display:none}

    /* Fortschrittskarten (wie im Snippet) */
    .progress-card{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius:14px;
      padding:16px 18px; margin:12px 0;
      box-shadow: var(--shadow);
    }
    .progress-card__header{display:flex; justify-content:space-between; align-items:center; margin-bottom:10px}
    .progress-card__title{font-weight:600}
    .progress-card__numbers{color:var(--muted); font-size:14px}
    .progress-bar{margin:10px 0 6px}
    .progress-bar__label{
      display:flex; justify-content:space-between; align-items:center;
      font-size:12px; color:var(--muted); margin-bottom:6px
    }
    .progress-bar__track{height:8px; border-radius:999px; background:#2b3140; overflow:hidden}
    .progress-bar__fill{height:100%; width:0; border-radius:999px; transition:width .4s ease; background:linear-gradient(90deg,#5cc2ff,#2eaadc)}
    .progress-bar--coverage .progress-bar__fill{background:linear-gradient(90deg,#ffd27a,#ff9e3b)}

    /* Karten / Fragen */
    .card{background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:14px; margin-bottom:10px}
    .chip{display:inline-block; padding:3px 10px; border-radius:999px; background:#141824; border:1px solid var(--line); color:var(--muted); font-size:12px}
    .space{height:12px}
    .danger{color:#ff6b6b}
    .success{color:#44d58a}
    .divider{height:1px; background:var(--line); margin:12px 0}
    .right{margin-left:auto}
  </style>
</head>
<body>

  <header class="topbar">
    <img src="https://ebqfupcivmkbuadbbnwg.supabase.co/storage/v1/object/public/app-assets/logo.png" alt="logo">
    <h1>Lernapp Lagerlogistik</h1>
    <nav class="nav">
      <button class="btn btn--ghost" data-view="learn">Lernkarten</button>
      <button class="btn btn--ghost" data-view="adaptive">Adaptiv</button>
      <button class="btn btn--ghost" data-view="exam">Prüfung</button>
      <button class="btn btn--ghost" data-view="progress">Fortschritt</button>
      <button class="btn btn--ghost hide" id="btnAdmin" data-view="admin">Admin</button>
      <button class="btn btn--ghost hide" id="btnSettings" data-view="settings">Einstellungen</button>
      <button class="btn btn--brand" id="btnLogin">Login</button>
    </nav>
  </header>

  <main class="container">

    <!-- LERNEN -->
    <section id="view-learn" class="panel">
      <h2>Lernkarten</h2>
      <div class="row">
        <label for="selCategory">Kategorie</label>
        <select id="selCategory"></select>
        <button class="btn" id="btnLoad">Laden</button>
        <span class="muted" id="catCount"></span>
      </div>
      <div id="learnList" class="space"></div>
    </section>

    <!-- ADAPTIV -->
    <section id="view-adaptive" class="panel hide">
      <h2>Adaptiv</h2>
      <div class="muted">Fragen werden anhand deiner letzten Antworten priorisiert.</div>
      <div id="adaptiveList" class="space"></div>
    </section>

    <!-- PRÜFUNG -->
    <section id="view-exam" class="panel hide">
      <h2>Prüfung</h2>
      <div class="row">
        <label for="selExamCategory">Kategorie</label>
        <select id="selExamCategory"></select>
        <label for="inpExamCount">Anzahl Fragen</label>
        <input type="number" id="inpExamCount" min="5" max="100" value="20" style="width:90px">
        <button class="btn" id="btnStartExam">Start</button>
      </div>
      <div id="examBox" class="space"></div>
    </section>

    <!-- FORTSCHRITT -->
    <section id="view-progress" class="panel hide">
      <h2>Dein Fortschritt</h2>
      <div class="row">
        <button class="btn" id="btnResetLocal">Lokalen Fortschritt zurücksetzen</button>
        <span class="muted right" id="lblUser"></span>
      </div>
      <div id="progressLocal" class="card">
        <strong>Letzte Sitzung (lokal)</strong>
        <div class="muted" id="localStats">—</div>
      </div>
      <div class="divider"></div>
      <div id="progressByCat"></div>
    </section>

    <!-- ADMIN -->
    <section id="view-admin" class="panel hide">
      <h2>Admin</h2>

      <div class="card">
        <strong>Kategorie verwalten</strong>
        <div class="row" style="margin-top:8px">
          <select id="selAdminCategory" style="min-width:320px"></select>
          <input id="inpRename" placeholder="Neue Kategorie (umbenennen/zusammenführen)" />
          <button class="btn" id="btnApplyRename">Anwenden</button>
        </div>
      </div>

      <div class="card">
        <strong>Duplikate scannen & bereinigen</strong>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="btnScanDup">Scan starten</button>
          <button class="btn" id="btnFixDup">Duplikate fixen (Auto)</button>
          <button class="btn" id="btnCleanCats">Kategorien bereinigen (Auto)</button>
          <span class="muted" id="lblDupResult">Fertig.</span>
        </div>
      </div>

      <div class="card">
        <strong>Import</strong>
        <div class="row" style="margin-top:8px">
          <input type="file" id="fileImport" accept="application/json" />
          <button class="btn" id="btnDoImport">Import starten</button>
          <span class="muted" id="lblImport">—</span>
        </div>
        <div class="muted" style="margin-top:6px">
          Erwartetes Format: Array von Fragenobjekten <code>{ id?, category, q, a, b, c, correct, explain? }</code>
        </div>
      </div>

      <div class="card">
        <strong>Neue Frage</strong>
        <div class="row" style="margin-top:8px; gap:10px">
          <input id="inpNewCat" placeholder="z.B. LL01/2 – Güter kontrollieren" style="min-width:260px" />
          <input id="inpQ" placeholder="Frage" style="flex:1 1 280px" />
          <input id="inpA" placeholder="***Korrekt" />
          <input id="inpB" placeholder="Falsch 1" />
          <input id="inpC" placeholder="Falsch 2" />
          <input id="inpExplain" placeholder="Erklärung (optional)" style="flex:1 1 240px" />
          <button class="btn" id="btnSaveQ">Speichern (DB)</button>
        </div>
      </div>

      <div id="adminList" class="space"></div>
    </section>

    <!-- EINSTELLUNGEN -->
    <section id="view-settings" class="panel hide">
      <h2>Einstellungen</h2>
      <div class="row">
        <label><input type="checkbox" id="chkImmediateReveal"> Lösung sofort nach Auswahl zeigen</label>
        <label><input type="checkbox" id="chkShuffle"> Antworten mischen</label>
        <button class="btn" id="btnSaveSettings">Speichern</button>
      </div>
    </section>

  </main>

  <script>
    /**********************
     * Supabase Setup
     **********************/
    const SUPABASE_URL = "https://ebqfupcivmkbuadbbnwg.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVicWZ1cGNpdm1rYnVhZGJibndnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MDA5ODIsImV4cCI6MjA3MDQ3Njk4Mn0.P6IiwjFSpqVmObRbvxvY46l6vJlPsxPAc-wbr15Dhl0";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // Tabellen-Namen (ggf. anpassen)
    const TABLE = "questions"; // Felder: id, category, q, a, b, c, correct ('a'|'b'|'c'), explain?

    // Admin-Mail
    const ADMIN_EMAIL = "mario1986ac@hotmail.de";

    /**********************
     * State
     **********************/
    let user = null;
    let allQuestions = []; // gesamt (bereits normalisierte Kategorien)
    let categories = [];   // dedupliziert & sortiert
    const settings = loadSettings();

    /**********************
     * UI Helpers
     **********************/
    const $ = sel => document.querySelector(sel);
    const el = (html) => {
      const t = document.createElement("template");
      t.innerHTML = html.trim();
      return t.content.firstElementChild;
    };
    function show(viewId){
      ["learn","adaptive","exam","progress","admin","settings"].forEach(v=>{
        $("#view-"+v).classList.toggle("hide", v!==viewId);
      });
    }
    document.querySelectorAll("[data-view]").forEach(btn=>{
      btn.addEventListener("click",()=> show(btn.dataset.view));
    });

    /**********************
     * Kategorie-Normalisierung & Deduplikation
     **********************/
    function normalizeCategoryName(name){
      if(!name) return "";
      let s = name.trim();

      // häufige Varianten angleichen
      s = s
        .replace(/–/g,"-")
        .replace(/\s{2,}/g," ")
        .replace(/Teil\s*1/i, "Teil 1")
        .replace(/Teil\s*2/i, "Teil 2")
        .replace(/Teil\s*3/i, "Teil 3")
        .replace(/Güter lagern Teil (\d)/i, "Güter lagern - Teil $1")
        .replace(/Güter Lagern/i, "Güter lagern")
        .replace(/Lager einrichtungen|Lagereinrichtungen/i, "Lagereinrichtungen")
        .replace(/gef[aä]hrlichen?\s*Stoffe?/i, "Gefährliche Stoffe")
      ;

      // Spezialfälle LL02/1..3
      s = s
        .replace(/^LL02\/1[^–-]*/i, "LL02/1")
        .replace(/^LL02\/2[^–-]*/i, "LL02/2")
        .replace(/^LL02\/3[^–-]*/i, "LL02/3");

      // Ziel-Bezeichnungen:
      s = s
        .replace(/^LL02\/1.*/i, "LL02/1 – Güter lagern - Teil 1: Grundlagen")
        .replace(/^LL02\/2.*/i, "LL02/2 – Güter lagern - Teil 2: Lagereinrichtungen")
        .replace(/^LL02\/3.*/i, "LL02/3 – Güter lagern - Teil 3: Gefährliche Stoffe");

      // vereinheitliche Langstriche
      s = s.replace(/\s*-\s*/g, " – ");

      return s;
    }

    function dedupeSorted(arr){
      return [...new Set(arr)].sort((a,b)=> a.localeCompare(b,'de'));
    }

    /**********************
     * Laden & Initialisieren
     **********************/
    init();
    async function init(){
      await fetchUser();
      await loadQuestions();
      buildCategorySelects();
      renderAdminCategorySelect();
      renderProgress();
      applyAuthVisibility();
      restoreSettings();
      show("learn");
    }

    async function fetchUser(){
      const { data:{ user: u } } = await sb.auth.getUser();
      user = u;
      $("#lblUser").textContent = user ? `Eingeloggt: ${user.email}` : "Nicht eingeloggt";
      $("#btnLogin").textContent = user ? "Logout" : "Login";
    }

    function applyAuthVisibility(){
      const isAdmin = user?.email?.toLowerCase() === ADMIN_EMAIL.toLowerCase();
      $("#btnAdmin").classList.toggle("hide", !isAdmin);
      $("#btnSettings").classList.toggle("hide", !user); // Einstellungen nur für eingeloggte
    }

    async function loadQuestions(){
      const { data, error } = await sb.from(TABLE).select("*").order("id");
      if(error){ console.error(error); allQuestions=[]; return }
      // normalisieren
      allQuestions = data.map(q => ({...q, category: normalizeCategoryName(q.category)}));
      categories = dedupeSorted(allQuestions.map(q=>q.category));
    }

    function buildCategorySelects(){
      const sel = $("#selCategory");
      const sel2 = $("#selExamCategory");
      sel.innerHTML = ""; sel2.innerHTML = "";
      categories.forEach(c=>{
        const opt = el(`<option>${c}</option>`);
        const opt2= el(`<option>${c}</option>`);
        sel.appendChild(opt);
        sel2.appendChild(opt2);
      });
      $("#catCount").textContent = `${categories.length} Kategorien`;
    }

    /**********************
     * Lernen (einfach)
     **********************/
    $("#btnLoad").addEventListener("click", ()=>{
      const cat = $("#selCategory").value;
      const list = $("#learnList");
      const qs = allQuestions.filter(q=>q.category===cat);
      list.innerHTML = "";
      qs.forEach(q=>{
        const card = el(`<div class="card">
          <div class="row">
            <span class="chip">${q.category}</span>
            <span class="muted right">ID: ${q.id ?? "-"}</span>
          </div>
          <div style="margin:8px 0 10px">${q.q}</div>
          <div class="row" style="gap:8px; flex-wrap:wrap">
            ${renderAnswerBtn("a", q.a)}
            ${renderAnswerBtn("b", q.b)}
            ${renderAnswerBtn("c", q.c)}
          </div>
          <div class="muted" id="exp-${q.id}" style="margin-top:8px; display:none">${q.explain||""}</div>
        </div>`);
        card.querySelectorAll("[data-answer]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const pick = btn.dataset.answer;
            const ok = (pick === q.correct);
            storeAnswer(q, ok);
            // Reveal?
            if($("#chkImmediateReveal").checked){
              const exp = $("#exp-"+q.id);
              if(exp){ exp.style.display = "block"; }
              btn.classList.add(ok ? "success" : "danger");
            }
          });
        });
        list.appendChild(card);
      });
    });

    function renderAnswerBtn(key, text){
      const label = ["a","b","c"].includes(key) ? key.toUpperCase() : key;
      if(!text) return "";
      return `<button class="btn" data-answer="${key}">${label}: ${text}</button>`;
    }

    /**********************
     * Adaptiv (Minimal)
     **********************/
    $("#view-adaptive").addEventListener("show", renderAdaptive);
    function renderAdaptive(){
      const list = $("#adaptiveList");
      // einfache Heuristik: Fragen mit geringer Quote zuerst
      const perf = loadPerf();
      const scoreById = new Map(Object.entries(perf).map(([id,arr])=>[+id, ratio(arr)]));
      const items = allQuestions
        .map(q=>({q, r: scoreById.has(q.id) ? scoreById.get(q.id) : 0.5}))
        .sort((x,y)=> (x.r - y.r))
        .slice(0, 30);

      list.innerHTML = "";
      items.forEach(({q,r})=>{
        const card = el(`<div class="card">
          <div class="row">
            <span class="chip">${q.category}</span>
            <span class="muted right">${Math.round(r*100)}%</span>
          </div>
          <div style="margin:8px 0 10px">${q.q}</div>
          <div class="row" style="gap:8px">
            ${renderAnswerBtn("a", q.a)}
            ${renderAnswerBtn("b", q.b)}
            ${renderAnswerBtn("c", q.c)}
          </div>
        </div>`);
        card.querySelectorAll("[data-answer]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const ok = (btn.dataset.answer===q.correct);
            storeAnswer(q, ok);
            btn.classList.add(ok ? "success":"danger");
          });
        });
        list.appendChild(card);
      });
    }

    /**********************
     * Prüfung (Minimal)
     **********************/
    $("#btnStartExam").addEventListener("click", ()=>{
      const cat = $("#selExamCategory").value;
      const n = Math.max(5, Math.min(100, +$("#inpExamCount").value||20));
      const pool = allQuestions.filter(q=>q.category===cat);
      const qs = shuffle([...pool]).slice(0,n);
      const box = $("#examBox");
      box.innerHTML = "";
      let correct=0, seen=0;
      qs.forEach((q,i)=>{
        const card = el(`<div class="card">
          <div class="row"><span class="chip">${cat}</span><span class="muted right">Frage ${i+1}/${qs.length}</span></div>
          <div style="margin:8px 0 10px">${q.q}</div>
          <div class="row" style="gap:8px">
            ${renderAnswerBtn("a", q.a)}
            ${renderAnswerBtn("b", q.b)}
            ${renderAnswerBtn("c", q.c)}
          </div>
        </div>`);
        card.querySelectorAll("[data-answer]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const ok = (btn.dataset.answer===q.correct);
            storeAnswer(q, ok);
            seen++; if(ok) correct++;
            btn.classList.add(ok ? "success":"danger");
            if(seen===qs.length){
              const res = el(`<div class="card"><strong>Ergebnis:</strong> ${correct}/${qs.length} (${Math.round(correct/qs.length*100)}%)</div>`);
              box.appendChild(res);
            }
          });
        });
        box.appendChild(card);
      });
    });

    /**********************
     * Fortschritt
     **********************/
    $("#btnResetLocal").addEventListener("click", ()=>{
      localStorage.removeItem("perf");
      renderProgress();
      alert("Lokaler Fortschritt wurde zurückgesetzt.");
    });

    function renderProgress(){
      // letzte Sitzung (lokal)
      const perf = loadPerf();
      const flat = Object.values(perf).flat();
      const seen = flat.length;
      const correct = flat.filter(x=>x).length;
      const quote = seen ? Math.round(correct/seen*100) : 0;
      $("#localStats").textContent = `Beantwortet: ${seen} · Richtig: ${correct} · Quote: ${quote}%`;

      // pro Kategorie
      const byCat = computeProgressByCategory(allQuestions, perf);
      const host = $("#progressByCat");
      host.innerHTML = "";
      byCat.forEach(row=>{
        host.appendChild(renderProgressCard(row));
      });
    }

    function renderProgressCard(row){
      const q = row.quotePct;     // Quote (richtig / beantwortet)
      const c = row.coverPct;     // Abdeckung (gesehen / gesamt)
      const card = el(`<div class="progress-card">
        <div class="progress-card__header">
          <span class="progress-card__title">${row.category}</span>
          <span class="progress-card__numbers">${c}%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-bar__label"><span>Quote</span><span class="progress-bar__value">${q}%</span></div>
          <div class="progress-bar__track"><div class="progress-bar__fill" style="width:${q}%"></div></div>
        </div>
        <div class="progress-bar progress-bar--coverage">
          <div class="progress-bar__label"><span>Abdeckung</span><span class="progress-bar__value">${c}%</span></div>
          <div class="progress-bar__track"><div class="progress-bar__fill" style="width:${c}%"></div></div>
        </div>
      </div>`);
      return card;
    }

    // Kern: saubere Berechnung (Quote != Abdeckung)
    function computeProgressByCategory(qs, perf){
      const byCat = new Map();
      const sizeByCat = new Map();
      qs.forEach(q=>{
        const cat = q.category;
        sizeByCat.set(cat, (sizeByCat.get(cat)||0)+1);
        if(!byCat.has(cat)) byCat.set(cat, {seen:0, correct:0});
        const arr = perf[q.id];
        if(Array.isArray(arr) && arr.length){
          byCat.get(cat).seen += arr.length > 0 ? 1 : 0;    // Abdeckung: Frage gesehen?
          byCat.get(cat).correct += arr.some(x=>x===true) ? 1 : 0; // mind. 1x korrekt beantwortet
        }
      });

      const rows = [];
      for(const cat of dedupeSorted([...sizeByCat.keys()])){
        const total = sizeByCat.get(cat)||0;
        const stat = byCat.get(cat)||{seen:0, correct:0};
        const quote = stat.seen ? Math.round((stat.correct/stat.seen)*100) : 0;
        const cover = total ? Math.round((stat.seen/total)*100) : 0;
        rows.push({category:cat, total, seen:stat.seen, correct:stat.correct, quotePct:quote, coverPct:cover});
      }
      return rows;
    }

    /**********************
     * Admin: Kategorien, Duplikate, Import
     **********************/
    function renderAdminCategorySelect(){
      const sel = $("#selAdminCategory");
      sel.innerHTML = categories.map(c=>`<option>${c}</option>`).join("");
    }
    $("#btnApplyRename").addEventListener("click", async()=>{
      const from = $("#selAdminCategory").value;
      const toRaw = $("#inpRename").value.trim();
      if(!from || !toRaw){ alert("Bitte Quell- und Zielkategorie angeben."); return; }
      const to = normalizeCategoryName(toRaw);
      const { error } = await sb.from(TABLE).update({category: to}).eq("category", from);
      if(error){ alert("Fehler beim Umbenennen: "+error.message); return; }
      await loadQuestions(); buildCategorySelects(); renderAdminCategorySelect(); renderProgress();
      alert(`Kategorie "${from}" → "${to}" aktualisiert.`);
    });

    $("#btnScanDup").addEventListener("click", ()=>{
      const map = new Map();
      allQuestions.forEach(q=>{
        const key = `${q.category}|${q.q}`.toLowerCase();
        map.set(key, (map.get(key)||0)+1);
      });
      const dups = [...map.values()].filter(n=>n>1).length;
      $("#lblDupResult").textContent = dups ? `Mögliche Duplikate: ${dups}` : "Keine Duplikate per Fragentext gefunden.";
    });

    $("#btnFixDup").addEventListener("click", async()=>{
      // einfache Auto-Fix-Strategie: (cat, q) unique – wir löschen doppelte IDs (höhere ID bleibt)
      const byKey = new Map();
      const toDelete = [];
      allQuestions.forEach(q=>{
        const key = `${q.category}|${q.q}`.toLowerCase();
        if(!byKey.has(key)) byKey.set(key, q);
        else{
          // behalte die niedrigste ID -> höhere ID löschen
          const keep = byKey.get(key);
          const del = (q.id>keep.id) ? q : keep;
          const stay= (q.id>keep.id) ? keep : q;
          byKey.set(key, stay);
          toDelete.push(del.id);
        }
      });
      if(!toDelete.length){ $("#lblDupResult").textContent = "Keine Duplikate gefunden."; return; }
      const { error } = await sb.from(TABLE).delete().in("id", toDelete);
      if(error){ alert("Fehler beim Löschen: "+error.message); return; }
      await loadQuestions(); buildCategorySelects(); renderAdminCategorySelect(); renderProgress();
      $("#lblDupResult").textContent = `Duplikate gelöscht: ${toDelete.length}`;
    });

    $("#btnCleanCats").addEventListener("click", async()=>{
      // normalisieren aller Kategorien
      const updates = [];
      allQuestions.forEach(q=>{
        const norm = normalizeCategoryName(q.category);
        if(norm !== q.category){
          updates.push({id:q.id, category:norm});
        }
      });
      if(!updates.length){ alert("Kategorien bereits sauber."); return; }
      // Batch upsert
      const { error } = await sb.from(TABLE).upsert(updates);
      if(error){ alert("Fehler beim Bereinigen: "+error.message); return; }
      await loadQuestions(); buildCategorySelects(); renderAdminCategorySelect(); renderProgress();
      alert(`Kategorien bereinigt. Geänderte Einträge: ${updates.length}`);
    });

    // Import
    let importFile = null;
    $("#fileImport").addEventListener("change", (e)=> importFile = e.target.files?.[0] || null);
    $("#btnDoImport").addEventListener("click", async()=>{
      if(!importFile){ alert("Bitte eine JSON-Datei wählen."); return; }
      try{
        const txt = await importFile.text();
        const arr = JSON.parse(txt);
        if(!Array.isArray(arr)){ throw new Error("Top-Level ist kein Array."); }
        // normalize + shape
        const rows = arr.map((r,i)=> ({
          id: r.id ?? undefined,
          category: normalizeCategoryName(r.category || r.kategorie || r.cat || "Unbekannt"),
          q: r.q || r.frage || "",
          a: r.a || r.korrekt || r.richtig || r.answerA || "",
          b: r.b || r.falsch1 || r.answerB || "",
          c: r.c || r.falsch2 || r.answerC || "",
          correct: (r.correct || r.loesung || "a").toString().trim().toLowerCase(),
          explain: r.explain || r.erklaerung || r.erklärung || ""
        })).filter(x=>x.q && x.a && x.b && x.c);

        if(!rows.length){ alert("Keine validen Fragen gefunden."); return; }
        // upsert
        const { error } = await sb.from(TABLE).upsert(rows, { onConflict:"id" });
        if(error) throw error;
        $("#lblImport").textContent = `Import fertig. Erfolgreich: ${rows.length} · Fehler: 0`;
        await loadQuestions(); buildCategorySelects(); renderAdminCategorySelect(); renderProgress();
        alert(`Import fertig. Erfolgreich: ${rows.length} · Fehler: 0`);
      }catch(e){
        console.error(e);
        $("#lblImport").textContent = `Fehler: ${e.message}`;
        alert("Fehler beim Import: "+e.message);
      }
    });

    // neue Frage schnell speichern
    $("#btnSaveQ").addEventListener("click", async()=>{
      const row = {
        category: normalizeCategoryName($("#inpNewCat").value.trim()),
        q: $("#inpQ").value.trim(),
        a: $("#inpA").value.trim(),
        b: $("#inpB").value.trim(),
        c: $("#inpC").value.trim(),
        correct: "a",
        explain: $("#inpExplain").value.trim()
      };
      if(!row.category || !row.q || !row.a || !row.b || !row.c){ alert("Bitte Kategorie, Frage und 3 Antworten angeben."); return; }
      const { error } = await sb.from(TABLE).insert([row]);
      if(error){ alert("Fehler: "+error.message); return; }
      await loadQuestions(); buildCategorySelects(); renderAdminCategorySelect(); renderProgress();
      alert("Gespeichert.");
      ["#inpQ","#inpA","#inpB","#inpC","#inpExplain"].forEach(id=> $(id).value="");
    });

    /**********************
     * Einstellungen
     **********************/
    function loadSettings(){
      try{ return JSON.parse(localStorage.getItem("settings")||"{}"); } catch{ return {}; }
    }
    function saveSettings(){
      localStorage.setItem("settings", JSON.stringify(settings));
    }
    function restoreSettings(){
      $("#chkImmediateReveal").checked = !!settings.immediateReveal;
      $("#chkShuffle").checked = !!settings.shuffle;
    }
    $("#btnSaveSettings").addEventListener("click", ()=>{
      settings.immediateReveal = $("#chkImmediateReveal").checked;
      settings.shuffle = $("#chkShuffle").checked;
      saveSettings();
      alert("Einstellungen gespeichert.");
    });

    /**********************
     * Login / Logout
     **********************/
    $("#btnLogin").addEventListener("click", async()=>{
      if(user){
        await sb.auth.signOut();
        user = null;
        applyAuthVisibility();
        $("#btnLogin").textContent = "Login";
        $("#lblUser").textContent = "Nicht eingeloggt";
        alert("Abgemeldet.");
      }else{
        const email = prompt("E-Mail für Magic Link Login:");
        if(!email) return;
        const { error } = await sb.auth.signInWithOtp({ email, options:{ emailRedirectTo: location.href } });
        if(error){ alert("Login-Fehler: "+error.message); return; }
        alert("Magic Link gesendet. Bitte E-Mail prüfen.");
      }
    });

    /**********************
     * Local Progress Storage
     **********************/
    function loadPerf(){
      try{ return JSON.parse(localStorage.getItem("perf")||"{}"); } catch{ return {}; }
    }
    function storePerf(perf){ localStorage.setItem("perf", JSON.stringify(perf)); }
    function storeAnswer(q, ok){
      const perf = loadPerf();
      const arr = perf[q.id] || [];
      arr.push(!!ok);
      perf[q.id] = arr.slice(-20); // nicht endlos wachsen lassen
      storePerf(perf);
      // Fortschritt-Ansicht live aktualisieren (wenn sichtbar)
      if(!$("#view-progress").classList.contains("hide")) renderProgress();
    }
    function ratio(arr){ if(!arr?.length) return 0; const c = arr.filter(x=>x).length; return c/arr.length; }

    /**********************
     * Utils
     **********************/
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }

    // Custom event, wenn ein View sichtbar wird
    const observer = new MutationObserver(()=>{
      document.querySelectorAll("section[id^='view-']").forEach(sec=>{
        if(!sec.classList.contains("hide")) sec.dispatchEvent(new Event("show"));
      });
    });
    observer.observe(document.body, { attributes:true, subtree:true, attributeFilter:["class"] });
  </script>
</body>
</html>
