<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Lernapp Lagerlogistik</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
:root{
  --line:rgba(255,255,255,.12);
  --text:#E5E7EB;
  --muted:#A7B0C3;
  --primary:#60A5FA;
  --panel:rgba(255,255,255,.06);
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:#0b1020;color:var(--text)}
.topbar{position:sticky;top:0;display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--line);background:rgba(10,14,28,.85);backdrop-filter:blur(8px);z-index:10}
.brand{display:flex;gap:10px;align-items:center}
.brand .logo{height:36px;width:36px;border-radius:8px;background:conic-gradient(from 0deg,#60A5FA,#F59E0B,#60A5FA);border:1px solid var(--line)}
.nav{display:flex;gap:8px;flex-wrap:wrap}
.nav button{background:transparent;color:var(--text);border:1px solid var(--line);padding:6px 10px;border-radius:10px;cursor:pointer}
.container{max-width:1000px;margin:0 auto;padding:20px}
.view{display:none}.view.active{display:block}
.panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
.cards{display:grid;gap:14px}
.card{border:1px solid var(--line);border-radius:12px;padding:12px;background:rgba(255,255,255,.04)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
input,select,textarea{background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line);border-radius:10px;padding:8px 10px}
.btn{border-radius:10px;padding:8px 12px;cursor:pointer;border:1px solid var(--line);background:transparent;color:var(--text)}
.btn.primary{background:#2563EB;border-color:#2563EB;color:#fff}
.option{display:grid;grid-template-columns:22px 1fr;gap:8px;padding:10px;border:1px solid var(--line);border-radius:10px;cursor:pointer;background:rgba(255,255,255,.02)}
.option.selected{outline:2px solid var(--primary);background:rgba(96,165,250,.1)}
.options.locked{pointer-events:none;opacity:.85}
.reveal{margin-top:8px;padding:8px 10px;border-radius:10px;border:1px solid var(--line)}
.reveal.ok{background:rgba(34,197,94,.13)}.reveal.err{background:rgba(239,68,68,.15)}
.alert{border:1px dashed var(--line);background:rgba(255,255,255,.03);padding:10px;border-radius:10px}
/* Ergebnis-Modal: blickdicht + eigener Scroll */
.modal{
  position:fixed; inset:0;
  background:#0b1020e6;        /* dunkel & blickdicht */
  backdrop-filter: blur(6px);
  display:none; align-items:center; justify-content:center;
  z-index:9999;
}
.modal.show{display:flex}
.modal .box{
  width:min(920px,calc(100% - 32px));
  background:#0f1427;
  border:1px solid var(--line);
  border-radius:12px;
  padding:14px;
  max-height:85vh;
  overflow:auto;
  box-shadow:0 22px 70px rgba(0,0,0,.55);
  position:relative;
}
.kpi{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:12px}
.kpi .k{border:1px solid var(--line);border-radius:10px;padding:10px;background:rgba(255,255,255,.04)}
.k .t{font-size:12px;color:var(--muted)}
.k .v{font-size:24px;font-weight:700}
.k .bar{height:6px;border-radius:999px;background:rgba(255,255,255,.08);margin-top:8px;overflow:hidden}
.k .bar>span{display:block;height:100%;background:#60A5FA}
.result h4{margin:8px 0}
.result .grp{border:1px solid var(--line);border-radius:10px;padding:10px;background:rgba(255,255,255,.03);margin-top:8px}
.result .row .btn{min-width:160px}
#btn-exam-pdf{border-color:#38bdf8;color:#38bdf8}
#btn-exam-pdf:hover{background:#0b2530}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand"><div class="logo"></div><div><b>Lernapp Lagerlogistik</b><div style="font-size:12px;color:var(--muted)">Supabase • Login • Cloud</div></div></div>
    <div class="nav">
      <button data-view="login">Login</button>
      <button data-view="flashcards">Lernkarten</button>
      <button data-view="exam">Prüfung</button>
      <button data-view="progress">Fortschritt</button>
      <button data-view="admin">Admin</button>
      <button id="btn-settings">Einstellungen</button>
    </div>
  </header>

  <div class="container">
    <!-- Settings -->
    <div id="settings-modal" class="modal">
      <div class="box">
        <h3>Supabase & Branding</h3>
        <div class="row">
          <label style="flex:1">Project URL<br/><input id="cfg-url" /></label>
          <label style="flex:1">Anon public key<br/><input id="cfg-key" /></label>
        </div>
        <label>Logo URL / Data‑URI<br/><input id="cfg-logo" placeholder="https://... oder data:image/png;base64,..."/></label>
        <div class="row" style="margin-top:8px">
          <button id="cfg-save" class="btn primary">Speichern</button>
          <button id="cfg-close" class="btn">Schließen</button>
          <span id="cfg-state" style="color:var(--muted)"></span>
        </div>
      </div>
    </div>

    <!-- Login -->
    <section id="view-login" class="view active">
      <div class="panel">
        <h3>Anmelden</h3>
        <div class="row">
          <input id="email" type="email" placeholder="dein.name@example.com"/>
          <input id="password" type="password" placeholder="••••••••"/>
          <button id="btn-signup" class="btn">Registrieren</button>
          <button id="btn-login" class="btn primary">Einloggen</button>
          <button id="btn-logout" class="btn" disabled>Abmelden</button>
          <span id="auth-state" style="color:var(--muted)"></span>
        </div>
        <div id="login-empty-info" class="alert" style="display:none;margin-top:10px"></div>
      </div>
    </section>

    <!-- Lernkarten -->
    <section id="view-flashcards" class="view">
      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <h3>Lernkarten</h3>
          <div class="row">
            <select id="fc-category"></select>
            <button id="fc-load" class="btn primary">Laden</button>
            <span id="fc-stats" style="color:var(--muted)"></span>
          </div>
        </div>
        <div id="fc-area" class="cards"></div>
        <div id="fc-empty" class="alert" style="display:none;margin-top:10px"></div>
      </div>
    </section>

    <!-- Prüfung -->
    <section id="view-exam" class="view">
      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <h3>Prüfungssimulation</h3>
          <div class="row">
            <select id="exam-categories" multiple></select>
            <input id="exam-count" type="number" value="40" min="5" max="100" style="width:80px"/>
            <input id="exam-minutes" type="number" value="60" min="5" max="180" style="width:80px"/>
            <button id="exam-start" class="btn primary">Start</button>
            <button id="exam-reset" class="btn">Reset</button>
          </div>
        </div>
        <div class="row" style="gap:6px;color:var(--muted)" id="exam-meta"></div>
        <div id="exam-area" class="cards"></div>
      </div>
    </section>

    <!-- Fortschritt -->
    <section id="view-progress" class="view">
      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <h3>Dein Fortschritt</h3>
          <button id="reset-progress" class="btn">Lokalen Fortschritt zurücksetzen</button>
        </div>
        <div id="progress-summary" class="cards"></div>
      </div>
    </section>

    <!-- Admin -->
    <section id="view-admin" class="view">
      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <h3>Admin</h3>
          <div class="row">
            <button id="admin-export" class="btn">Export JSON</button>
            <input type="file" id="admin-import" accept="application/json"/>
          </div>
        </div>
        <form id="admin-form" onsubmit="return false;">
          <h4>Neue Frage</h4>
          <input id="ad-category" placeholder="z.B. LL01/2 – Güter kontrollieren" required/>
          <textarea id="ad-question" rows="2" placeholder="Frage" required></textarea>
          <textarea id="ad-options" rows="4" placeholder="***Korrekt
Falsch 1
Falsch 2" required></textarea>
          <textarea id="ad-expl" rows="2" placeholder="Erklärung (optional)"></textarea>
          <div class="row"><button id="admin-save" class="btn primary">Speichern (DB)</button></div>
        </form>
        <div id="admin-list" class="cards"></div>
      </div>
    </section>

    <!-- Ergebnis-Modal -->
    <div id="result-modal" class="modal">
      <div class="box result">
        <h3>Prüfungsergebnis</h3>
        <div class="kpi">
          <div class="k">
            <div class="t">Gesamt richtig</div>
            <div class="v" id="r-total">-</div>
            <div class="bar"><span id="r-bar" style="width:0%"></span></div>
          </div>
          <div class="k">
            <div class="t">Quote</div>
            <div class="v" id="r-quote">-</div>
          </div>
          <div class="k">
            <div class="t">Erstellt</div>
            <div class="v" id="r-created">-</div>
          </div>
        </div>
        <h4>Nach Kategorie</h4>
        <div id="r-groups"></div>
        <div class="row" style="justify-content:flex-end;margin-top:12px">
          <button id="btn-exam-new" class="btn">Neue Prüfung starten</button>
          <button id="btn-exam-close" class="btn">Schließen</button>
          <button id="btn-exam-pdf" class="btn">PDF herunterladen</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ---------- Navigation ---------- */
const views=['login','flashcards','exam','progress','admin'];
document.querySelectorAll('.nav button[data-view]').forEach(b=>{
  b.onclick=()=>views.forEach(v=>document.getElementById('view-'+v).classList.toggle('active',v===b.dataset.view));
});
const shuffle=a=>{const b=a.slice();for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]];}return b;};

/* ---------- Branding & Settings ---------- */
const KEY_URL='supabase_url', KEY_ANON='supabase_anon', KEY_LOGO='app_logo_url'; 
let supa=null;

function applyBranding(){
  const logo = localStorage.getItem(KEY_LOGO);
  const el = document.querySelector('.brand .logo');
  if (logo) {
    el.style.background='none';
    el.style.backgroundImage=`url(${logo})`;
    el.style.backgroundSize='cover';
    el.style.backgroundPosition='center';
  }
}
document.getElementById('btn-settings').onclick=()=>{document.getElementById('settings-modal').classList.add('show');
  document.getElementById('cfg-url').value=localStorage.getItem(KEY_URL)||'https://ebqfupcivmkbuadbbnwg.supabase.co';
  document.getElementById('cfg-key').value=localStorage.getItem(KEY_ANON)||'';
  document.getElementById('cfg-logo').value=localStorage.getItem(KEY_LOGO)||'';
};
document.getElementById('cfg-close').onclick=()=>document.getElementById('settings-modal').classList.remove('show');
document.getElementById('cfg-save').onclick=()=>{localStorage.setItem(KEY_URL, document.getElementById('cfg-url').value.trim());
  localStorage.setItem(KEY_ANON, document.getElementById('cfg-key').value.trim());
  const logo=document.getElementById('cfg-logo').value.trim();
  if(logo) localStorage.setItem(KEY_LOGO, logo); else localStorage.removeItem(KEY_LOGO);
  applyBranding();
  document.getElementById('cfg-state').textContent='Gespeichert. Seite lädt neu...';
  setTimeout(()=>location.reload(),400);
};

/* ---------- Supabase Init ---------- */
async function initClient(){
  const url=localStorage.getItem(KEY_URL)||'https://ebqfupcivmkbuadbbnwg.supabase.co';
  const anon=localStorage.getItem(KEY_ANON)||'';
  if(!url || !anon){ console.warn('Supabase: fehlende URL/Anon'); }
  supa = supabase.createClient(url, anon);
  applyBranding();
  renderLocalProgress();
  refreshAuthUI(); await refreshSelectors(); await refreshExamCategories(); await renderAdminList(); await showEmptyHints();
  if(location.hash.includes('progress')) loadCloudStats(); // erster Wurf
}
function getClient(){ return supa; }
async function getUser(){ try{ const {data:{user}}=await supa.auth.getUser(); return user||null; } catch{ return null; } }

/* ---------- Auth ---------- */
const email=document.getElementById('email'), password=document.getElementById('password');
const btnSignup=document.getElementById('btn-signup'), btnLogin=document.getElementById('btn-login'), btnLogout=document.getElementById('btn-logout');
const authState=document.getElementById('auth-state'), loginEmptyInfo=document.getElementById('login-empty-info');
async function refreshAuthUI(){ const {data:{user}}=await supa.auth.getUser();
  if(user){btnLogout.disabled=false;btnLogin.disabled=true;btnSignup.disabled=true;authState.textContent=`Eingeloggt: ${user.email}`;} else {
    btnLogout.disabled=true;btnLogin.disabled=false;btnSignup.disabled=false;authState.textContent='Nicht eingeloggt';} }
btnSignup.onclick=async()=>{const {error}=await supa.auth.signUp({email:email.value,password:password.value}); if(error) alert(error.message); else alert('Registriert. Prüfe dein Postfach.'); refreshAuthUI();};
btnLogin.onclick=async()=>{const {error}=await supa.auth.signInWithPassword({email:email.value,password:password.value}); if(error) alert(error.message); await refreshAuthUI();};
btnLogout.onclick=async()=>{await supa.auth.signOut(); await refreshAuthUI();};

/* ---------- Data helpers ---------- */
async function fetchQuestions(){ const {data,error}=await supa.from('questions').select('*').order('category',{ascending:true}); if(error){alert(error.message); return [];} return data||[]; }
async function fetchCategories(){ const q=await fetchQuestions(); return [...new Set(q.map(x=>x.category))].sort(); }

/* ---------- Lernkarten ---------- */
const fcCategory=document.getElementById('fc-category'), fcArea=document.getElementById('fc-area'), fcStats=document.getElementById('fc-stats'), fcEmpty=document.getElementById('fc-empty');
document.getElementById('fc-load').onclick=loadFlashcards;
async function refreshSelectors(){ const cats=await fetchCategories(); fcCategory.innerHTML=cats.map(c=>`<option>${c}</option>`).join(''); }
async function loadFlashcards(){ const all=await fetchQuestions(); const cat=fcCategory.value; const cards=all.filter(x=>x.category===cat);
  fcArea.innerHTML=''; if(cards.length===0){ fcEmpty.style.display='block'; fcEmpty.textContent='Keine Fragen in dieser Kategorie. Admin → Import nutzen.'; fcStats.textContent='0 Karten'; return;} else fcEmpty.style.display='none';
  let n=0; cards.forEach(card=>{ const wrap=document.createElement('div'); wrap.className='card';
    const opts=shuffle(card.options.map((t,i)=>({text:t,correct:i===card.correct_index})));
    wrap.innerHTML=`<div class="row" style="justify-content:space-between"><div><span style="font-size:12px;color:var(--muted)">${card.category}</span></div><div style="color:var(--muted)">ID: ${card.id}</div></div>
      <div><b>${card.question}</b></div><div class="options"></div>
      <div class="row" style="margin-top:8px"><button class="btn primary check" disabled>Prüfen</button><button class="btn next">Weiter</button></div>
      <div class="reveal" style="display:none"></div>`;
    const box=wrap.querySelector('.options'); let selected=-1;
    opts.forEach((o,i)=>{ const d=document.createElement('div'); d.className='option'; d.innerHTML=`<input type="radio"/><span><b>${String.fromCharCode(65+i)}.</b> ${o.text}</span>`;
      d.onclick=()=>{ selected=i; [...box.children].forEach(c=>c.classList.remove('selected')); d.classList.add('selected'); wrap.querySelector('.check').disabled=false; }; box.appendChild(d); });
    wrap.querySelector('.check').onclick=async()=>{ if(selected<0) return alert('Bitte wählen.'); 
      const chosen=opts[selected]; const solution=opts.find(o=>o.correct)?.text; const reveal=wrap.querySelector('.reveal');
      reveal.style.display='block'; reveal.textContent = chosen.correct ? '✅ Richtig!' : `❌ Falsch. Richtig: ${solution}`;
      reveal.classList.toggle('ok',chosen.correct); reveal.classList.toggle('err',!chosen.correct);
      bumpProgress(1, chosen.correct?1:0);
      const user=await getUser(); if(user) await supa.from('reviews').insert({user_id:user.id,question_id:card.id,correct:chosen.correct});
    };
    wrap.querySelector('.next').onclick=()=>wrap.remove();
    fcArea.appendChild(wrap); n++; }); fcStats.textContent=`${n} Karten geladen`;
}

/* ---------- IHK-Prüfung ---------- */
const examCategories=document.getElementById('exam-categories'), examCount=document.getElementById('exam-count'), examMinutes=document.getElementById('exam-minutes');
const examStart=document.getElementById('exam-start'), examReset=document.getElementById('exam-reset'), examArea=document.getElementById('exam-area'), examMeta=document.getElementById('exam-meta');

let currentExam=[], currentExamItems=[], timerId=null, timeLeft=0, ihkRunning=false;

async function refreshExamCategories(){ const cats=await fetchCategories(); examCategories.innerHTML=cats.map(c=>`<option value="${c}" selected>${c}</option>`).join(''); }
function pickN(a,n){ const b=shuffle(a); return b.slice(0,Math.max(0,Math.min(n,b.length))); }

examStart.onclick=async()=>{
  const all=await fetchQuestions(); const chosen=[...examCategories.selectedOptions].map(o=>o.value); const pool=all.filter(q=>chosen.includes(q.category));
  const n=Math.max(5,Math.min(Number(examCount.value||40),100)); currentExam=pickN(pool,n);
  if(currentExam.length===0) return alert('Keine Fragen gefunden. Importiere zuerst.');
  examArea.innerHTML=''; currentExamItems=[]; ihkRunning=true;

  // Timer
  timeLeft = (Number(examMinutes.value||60))*60; // Sekunden
  renderExamMeta();
  if(timerId) clearInterval(timerId);
  timerId=setInterval(()=>{ timeLeft--; renderExamMeta(); if(timeLeft<=0){ doIhkFinish(); } },1000);

  // Render Fragen
  currentExam.forEach((q,idx)=>renderExamQuestion(q,idx,n));
};

function renderExamMeta(){
  const answered = currentExamItems.length;
  const total = currentExam.length||Number(examCount.value||40);
  const mm = Math.max(0,Math.floor(timeLeft/60)).toString().padStart(2,'0');
  const ss = Math.max(0,timeLeft%60).toString().padStart(2,'0');
  examMeta.textContent = `IHK‑Start (${answered}/${total}) • Restzeit ${mm}:${ss}`;
}
function renderExamQuestion(q,idx,total){
  const el=document.createElement('div'); el.className='card'; const opts=shuffle(q.options.map((t,i)=>({text:t,correct:i===q.correct_index})));
  el.innerHTML=`<div class="row" style="justify-content:space-between"><div><span style="font-size:12px;color:var(--muted)">${q.category}</span></div><div style="color:var(--muted)">Frage ${idx+1}/${total}</div></div>
    <div><b>${q.question}</b></div><div class="options"></div><div class="row" style="margin-top:8px"><button class="btn primary check" disabled>Antwort prüfen</button></div><div class="reveal" style="display:none"></div>`;
  const box=el.querySelector('.options'); let selected=-1,locked=false;
  opts.forEach((o,i)=>{ const d=document.createElement('div'); d.className='option'; d.innerHTML=`<input type="radio"/><span><b>${String.fromCharCode(65+i)}.</b> ${o.text}</span>`;
    d.onclick=()=>{ if(locked) return; selected=i; [...box.children].forEach(c=>c.classList.remove('selected')); d.classList.add('selected'); el.querySelector('.check').disabled=false; }; box.appendChild(d); });
  el.querySelector('.check').onclick=async()=>{ if(locked) return; if(selected<0) return alert('Bitte wählen.');
    locked=true; box.classList.add('locked'); box.querySelectorAll('input[type=radio]').forEach(r=>r.disabled=true);
    const chosen=opts[selected]; const reveal=el.querySelector('.reveal'); reveal.style.display='block'; reveal.textContent=chosen.correct?'✅ Richtig':'❌ Falsch';
    reveal.classList.toggle('ok',chosen.correct); reveal.classList.toggle('err',!chosen.correct);
    currentExamItems.push({qid:q.id,cat:q.category,correct:chosen.correct});
    bumpProgress(1, chosen.correct?1:0);
    const user=await getUser(); if(user) await supa.from('reviews').insert({user_id:user.id,question_id:q.id,correct:chosen.correct});
    renderExamMeta();
    if(currentExamItems.length===currentExam.length) doIhkFinish();
  };
  examArea.appendChild(el);
}
examReset.onclick=()=>{ if(timerId) clearInterval(timerId); ihkRunning=false; examArea.innerHTML=''; examMeta.textContent=''; };

/* Ergebnis-Panel (KEIN PDF hier) */
function groupByCategory(items){
  const map=new Map();
  items.forEach(x=>{
    const g=map.get(x.cat)||{cat:x.cat,total:0,correct:0};
    g.total++; if(x.correct) g.correct++; map.set(x.cat,g);
  });
  return [...map.values()].sort((a,b)=>a.cat.localeCompare(b.cat));
}
async function doIhkFinish(){
  if(!ihkRunning) return;
  ihkRunning=false; clearInterval(timerId);
  const total = currentExam.length;
  const correct = currentExamItems.filter(x=>x.correct).length;
  // DB: Session speichern (wenn eingeloggt)
  const user = await getUser();
  if (user) {
    await supa.from('exam_sessions').insert({
      user_id: user.id,
      total, correct, detail: currentExamItems
    });
  }
  renderExamPanel(total, correct, groupByCategory(currentExamItems));
}
function renderExamPanel(total,correct,byCat){
  const modal=document.getElementById('result-modal');
  const q = total? Math.round(correct/total*100) : 0;
  document.getElementById('r-total').textContent = `${correct} / ${total}`;
  document.getElementById('r-quote').textContent = `${q}%`;
  document.getElementById('r-created').textContent = new Date().toLocaleString();
  document.getElementById('r-bar').style.width=`${q}%`;
  const g=document.getElementById('r-groups');
  g.innerHTML = byCat.map(c=>{
    const pc = Math.round((c.correct/c.total)*100);
    return `<div class="grp"><b>${c.cat}</b><div>${c.correct}/${c.total} (${pc}%)</div></div>`;
  }).join('') || '<div class="grp">Kein Ergebnis.</div>';
  modal.classList.add('show');
}
document.getElementById('btn-exam-close').onclick=()=>document.getElementById('result-modal').classList.remove('show');
document.getElementById('btn-exam-new').onclick=()=>{ document.getElementById('result-modal').classList.remove('show'); examReset.click(); window.location.hash='#exam'; };

/* PDF nur auf Button */
document.getElementById('btn-exam-pdf').onclick=async ()=>{
  const user = await getUser();
  const email = user?.email || '(nicht eingeloggt)';
  const name  = user?.user_metadata?.full_name || '';
  const total = currentExam.length;
  const correct = currentExamItems.filter(x=>x.correct).length;
  const quote   = total? Math.round(correct/total*100) : 0;
  const created = new Date().toLocaleString();
  const byCat   = groupByCategory(currentExamItems);

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y=14;

  doc.setFontSize(14); doc.text("Prüfungsergebnis – Lernapp Lagerlogistik", 14, y); y+=8;
  doc.setFontSize(10); doc.text(`Erstellt: ${created}`, 14, y); y+=6;
  doc.text(`Prüfling: ${name}    E-Mail: ${email}`, 14, y); y+=10;

  doc.setFontSize(12); doc.text(`Gesamt richtig: ${correct} / ${total}   |   Quote: ${quote}%`, 14, y); y+=10;

  doc.setFontSize(11); doc.text("Nach Kategorie:", 14, y); y+=6;
  doc.setFontSize(10);
  byCat.forEach(c=>{
    if (y>276) { doc.addPage(); y=14; }
    doc.text(`• ${c.cat}: ${c.correct}/${c.total} (${Math.round((c.correct/c.total)*100)}%)`, 16, y); y+=6;
  });

  doc.save(`Pruefung_${created.replaceAll(/[\s:.]/g,'-')}.pdf`);
};

/* ---------- Fortschritt (lokal + Cloud) ---------- */
function bumpProgress(seenDelta, correctDelta){
  const p = JSON.parse(localStorage.getItem('progress_local') || '{"seen":0,"correct":0}');
  p.seen += seenDelta; p.correct += correctDelta;
  localStorage.setItem('progress_local', JSON.stringify(p));
  renderLocalProgress();
}
function renderLocalProgress(){
  const p = JSON.parse(localStorage.getItem('progress_local') || '{"seen":0,"correct":0}');
  const acc = p.seen ? Math.round(p.correct/p.seen*100) : 0;
  document.getElementById('progress-summary').innerHTML = `
    <div class="card"><b>Letzte Sitzung (lokal)</b><div>Beantwortet: <b>${p.seen}</b> • Richtig: <b>${p.correct}</b> • Quote: <b>${acc}%</b></div></div>`;
}
document.getElementById('reset-progress').onclick=()=>{ localStorage.removeItem('progress_local'); renderLocalProgress(); };

async function loadCloudStats(){
  const client = getClient(); const boxHost = document.getElementById('progress-summary');
  if (!client || !client.from) {
    const div=document.createElement('div'); div.className='card'; div.innerHTML='Cloud-Statistik: <b>Supabase-Client nicht gefunden.</b><br>Bitte in den Einstellungen Projekt-URL & Anon Key eintragen und erneut laden.';
    boxHost.appendChild(div); return;
  }
  // Fragen gesamt
  let totalQuestions=0;
  try{ const {count}=await client.from('questions').select('id',{head:true,count:'exact'}); totalQuestions=count||0; } catch{}
  const local = JSON.parse(localStorage.getItem('progress_local')||'{"seen":0,"correct":0}');
  const localQuote = local.seen? Math.round(local.correct/local.seen*100):0;

  const boxLocal=document.createElement('div'); boxLocal.className='card';
  boxLocal.innerHTML=`<b>Letzte Sitzung (lokal)</b><div>Beantwortet: <b>${local.seen}</b> • Richtig: <b>${local.correct}</b> • Quote: <b>${localQuote}%</b></div>`;
  boxHost.appendChild(boxLocal);

  const user = await getUser();
  if(!user){
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`<b>Gesamt (Cloud)</b><div>Fragen gesamt: <b>${totalQuestions}</b></div><div style="margin-top:8px;color:var(--muted)">Für Cloud-Details bitte einloggen.</div>`;
    boxHost.appendChild(card); return;
  }

  let totalAnswers=0, correctAnswers=0, learnedDistinct=0;
  try{
    const all=await client.from('reviews').select('id',{head:true,count:'exact'}).eq('user_id', user.id);
    totalAnswers=all.count||0;
    const ok=await client.from('reviews').select('id',{head:true,count:'exact'}).eq('user_id',user.id).eq('correct',true);
    correctAnswers=ok.count||0;
    const learned=await client.from('reviews').select('question_id',{count:'exact',head:true}).eq('user_id',user.id).eq('correct',true).distinct();
    learnedDistinct=learned.count||0;
  }catch(e){console.warn(e)}

  const open=Math.max(0,totalQuestions-learnedDistinct);
  const quote = totalAnswers? Math.round(correctAnswers/totalAnswers*100):0;

  const card=document.createElement('div'); card.className='card';
  card.innerHTML=`<b>Gesamt (Cloud)</b>
  <div>Fragen gesamt: <b>${totalQuestions}</b></div>
  <div>Antworten gesamt: <b>${totalAnswers}</b> • Richtig: <b>${correctAnswers}</b> • Quote: <b>${quote}%</b></div>
  <div>Gelernt (≥1× richtig): <b>${learnedDistinct}</b> • Offen: <b>${open}</b></div>`;
  boxHost.appendChild(card);

  // Letzte Prüfungen
  try{
    const {data:exams}=await client.from('exam_sessions').select('id, started_at, total, correct').eq('user_id',user.id).order('started_at',{ascending:false}).limit(5);
    const c=document.createElement('div'); c.className='card'; c.innerHTML='<b>Letzte Prüfungen</b>';
    if(exams?.length){
      c.innerHTML += exams.map(x=>{
        const q = x.total? Math.round((x.correct/x.total)*100) : 0;
        const d = x.started_at? new Date(x.started_at).toLocaleString() : '-';
        return `<div>• ${d}: <b>${x.correct}/${x.total}</b> (${q}%)</div>`;
      }).join('');
    }else{
      c.innerHTML += '<div>Keine Prüfungen vorhanden.</div>';
    }
    boxHost.appendChild(c);
  }catch(e){console.warn(e)}
}

/* ---------- Admin ---------- */
const adminList=document.getElementById('admin-list');
async function renderAdminList(){ const q=await fetchQuestions();
  adminList.innerHTML=q.map(x=>`<div class="card"><div class="row" style="justify-content:space-between"><div><span style="font-size:12px;color:var(--muted)">${x.category}</span></div><button data-del="${x.id}" class="btn">Löschen</button></div><div><b>${x.question}</b></div></div>`).join('');
  adminList.querySelectorAll('button[data-del]').forEach(btn=>btn.onclick=async()=>{const id=btn.getAttribute('data-del'); const {error}=await supa.from('questions').delete().eq('id',id); if(error) alert(error.message); else renderAdminList();});
}
document.getElementById('admin-export').onclick=async()=>{const q=await fetchQuestions(); const blob=new Blob([JSON.stringify(q,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='fragen_export_supabase.json'; a.click(); URL.revokeObjectURL(url);};
document.getElementById('admin-import').onchange=async(e)=>{const f=e.target.files?.[0]; if(!f) return; const text=await f.text(); try{const data=JSON.parse(text); if(!Array.isArray(data)) throw new Error('Erwarte Array');
  const cleaned=data.map(x=>{const {deck,correctIndex,...rest}=x||{}; return {...rest, correct_index: rest.correct_index ?? correctIndex};});
  for(const item of cleaned){const {error}=await supa.from('questions').upsert(item,{onConflict:'id'}); if(error) console.warn('Fehler',item.id,error.message);}
  alert('Import abgeschlossen'); renderAdminList(); await refreshSelectors(); await refreshExamCategories();
}catch(err){alert('Import fehlgeschlagen: '+err.message);}};

/* ---------- Hinweise ---------- */
async function showEmptyHints(){ const all=await fetchQuestions(); const hint=document.getElementById('login-empty-info'); if(!all.length){ hint.style.display='block'; hint.innerHTML='Noch keine Fragen in der Datenbank. Admin → Import nutzen.'; } else hint.style.display='none'; }

/* ---------- Startup ---------- */
window.addEventListener('hashchange', ()=>{ if(location.hash.includes('progress')) loadCloudStats(); });
window.addEventListener('DOMContentLoaded', initClient);
</script>
</body>
</html>
