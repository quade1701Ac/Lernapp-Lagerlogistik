<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Lernapp Lagerlogistik</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- jsPDF für den PDF-Export -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --line:rgba(255,255,255,.12);
      --text:#E5E7EB;
      --muted:#A7B0C3;
      --primary:#60A5FA;
      --panel:rgba(255,255,255,.06);
      --panel-strong:#0d1326;
      --panel-hover:rgba(255,255,255,.08);
      --danger:#ef4444;
      --success:#34d399;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:#0b1020;color:var(--text)}
    .hide{ display:none !important; }

    /* Topbar */
    .topbar{
      position:sticky;top:0;display:flex;justify-content:space-between;align-items:center;
      padding:12px 16px;border-bottom:1px solid var(--line);
      background:rgba(10,14,28,.85);backdrop-filter:blur(8px);z-index:5
    }
    .brand{display:flex;gap:10px;align-items:center}
    .brand .logo{height:36px;width:36px;border-radius:8px;background:conic-gradient(from 0deg,#60A5FA,#F59E0B,#60A5FA)}
    .nav{display:flex;gap:8px;flex-wrap:wrap}
    .nav button{background:transparent;color:var(--text);border:1px solid var(--line);padding:6px 10px;border-radius:10px;cursor:pointer}

    /* Layout */
    .container{max-width:1000px;margin:0 auto;padding:20px}
    .view{display:none}.view.active{display:block}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
    .panel:hover{ background:var(--panel-hover); }
    .cards{display:grid;gap:14px}
    .card{border:1px solid var(--line);border-radius:12px;padding:12px;background:rgba(255,255,255,.04)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    /* Inputs */
    input,select,textarea{
      background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line);border-radius:10px;padding:8px 10px;outline:none;
    }
    input:focus,select:focus,textarea:focus{border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.25)}
    .btn{border-radius:10px;padding:8px 12px;cursor:pointer;border:1px solid var(--line);background:transparent;color:var(--text)}
    .btn.primary{background:#2563EB;border-color:#2563EB;color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .chip{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04)}
    .option{display:grid;grid-template-columns:18px 1fr;gap:8px;padding:8px;border:1px solid var(--line);border-radius:8px;background:rgba(255,255,255,.02);cursor:pointer}
    .option.selected{outline:2px solid var(--primary);background:rgba(96,165,250,.10)}
    .muted{color:var(--muted)}
    .alert{border:1px dashed var(--line);background:rgba(255,255,255,.03);padding:10px;border-radius:10px}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:20}
    .modal.show{display:flex}
    .modal .backdrop{position:absolute;inset:0;background:#0b1020e6;backdrop-filter:blur(6px)}
    .modal .box{position:relative;width:min(980px,calc(100% - 32px));max-height:90vh;overflow:auto;background:#0f1427;border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 22px 70px rgba(0,0,0,.55)}

    .stat-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin:8px 0 10px}
    .stat{border:1px solid var(--line);border-radius:10px;padding:10px;background:rgba(255,255,255,.03)}
    .stat .val{font-size:22px;font-weight:800;margin-top:4px}

    /* Sticky-Abgeben-Button */
    #exam-submit-sticky{position:fixed;right:20px;bottom:20px;padding:12px 18px;border-radius:12px;border:1px solid var(--line);background:#2563EB;color:#fff;font-weight:600;cursor:pointer;z-index:1000;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    #exam-submit-sticky[disabled]{opacity:.6;cursor:not-allowed}

    /* Dropdown-Readability */
    select, option {background-color:#1e1e1e !important;color:#fff !important;border:1px solid #444;padding:6px 10px;font-size:14px;border-radius:8px}
    select:hover, option:hover { background-color:#2a2a2a !important }
    select[multiple]{ min-height:260px }
    select[multiple] option:checked{ background-color:#2563EB !important;color:#fff !important }
    select::-webkit-scrollbar{width:10px}
    select::-webkit-scrollbar-thumb{background:#2a2f45;border-radius:8px}
    select::-webkit-scrollbar-thumb:hover{background:#3a4161}

    /* Admin Area polish */
    #view-admin .panel{ background:var(--panel-strong) }
    #view-admin h4{ margin:0 0 8px;font-size:16px }
    #view-admin .card{ background:rgba(255,255,255,.03) }
    #admin-cat-old{ min-width:420px }
    #admin-cat-new{ min-width:320px }
    .admin-section{ margin-bottom:14px }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <b>Lernapp Lagerlogistik</b>
        <div style="font-size:12px;color:var(--muted)">Supabase • Login • Cloud</div>
      </div>
    </div>
    <div class="nav">
      <button data-view="login" id="tab-login">Login</button>
      <button data-view="flashcards" id="tab-flash" class="hide">Lernkarten</button>
      <button data-view="train" id="tab-train" class="hide">Adaptiv</button>
      <button data-view="exam" id="tab-exam" class="hide">Prüfung</button>
      <button data-view="progress" id="tab-progress" class="hide">Fortschritt</button>
      <!-- Admin/Settings standardmäßig versteckt; JS blendet für Admins ein -->
      <button data-view="admin" id="tab-admin" class="hide">Admin</button>
      <button id="btn-settings" class="hide">Einstellungen</button>
    </div>
  </header>

  <div class="container">
    <!-- Einstellungen -->
    <div id="settings-modal" class="modal">
      <div class="backdrop"></div>
      <div class="box">
        <h3>Supabase & Branding</h3>
        <div class="row">
          <label style="flex:1">Project URL<br/><input id="cfg-url" /></label>
          <label style="flex:1">Anon public key<br/><input id="cfg-key" /></label>
        </div>
        <label>Logo URL / Data‑URI<br/><input id="cfg-logo" placeholder="https://... oder data:image/png;base64,..."/></label>
        <div class="row" style="margin-top:8px">
          <button id="cfg-save" class="btn primary">Speichern</button>
          <button id="cfg-close" class="btn">Schließen</button>
          <span id="cfg-state" class="muted"></span>
        </div>
      </div>
    </div>

    <!-- Ergebnis-Modal -->
    <div id="result-modal" class="modal">
      <div class="backdrop"></div>
      <div class="box">
        <h3>Prüfungsergebnis</h3>
        <div class="stat-grid">
          <div class="stat"><div>Gesamt richtig</div><div class="val" id="res-total">–</div></div>
          <div class="stat"><div>Quote</div><div class="val" id="res-quote">–</div></div>
          <div class="stat"><div>Erstellt</div><div class="val" id="res-date">–</div></div>
        </div>
        <div class="card"><div style="font-weight:700;margin-bottom:6px">Nach Kategorie</div><div id="res-cats"></div></div>
        <div class="cards" id="res-items" style="margin-top:10px"></div>
        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <button id="res-new" class="btn">Neue Prüfung</button>
          <button id="res-close" class="btn">Schließen</button>
          <button id="result-pdf" class="btn primary">PDF herunterladen</button>
        </div>
      </div>
    </div>

    <!-- Login -->
    <section id="view-login" class="view active">
      <div class="panel">
        <h3>Anmelden</h3>
        <div class="muted" style="margin-bottom:8px">
          Du bist nicht eingeloggt. Bitte melde dich an, um Lernkarten, Training und Prüfungen zu nutzen.
        </div>
        <div class="row">
          <input id="email" type="email" placeholder="dein.name@example.com"/>
          <input id="password" type="password" placeholder="••••••••"/>
          <button id="btn-signup" class="btn">Registrieren</button>
          <button id="btn-login" class="btn primary">Einloggen</button>
          <button id="btn-logout" class="btn" disabled>Abmelden</button>
          <span id="auth-state" class="muted"></span>
        </div>
        <div id="login-empty-info" class="alert" style="display:none;margin-top:10px"></div>
      </div>
    </section>

    <!-- Lernkarten (klassisch) -->
    <section id="view-flashcards" class="view">
      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <h3>Lernkarten</h3>
          <div class="row">
            <select id="fc-category"></select>
            <button id="fc-load" class="btn primary">Laden</button>
            <span id="fc-stats" class="muted"></span>
          </div>
        </div>
        <div id="fc-area" class="cards"></div>
        <div id="fc-empty" class="alert" style="display:none;margin-top:10px"></div>
      </div>
    </section>

    <!-- Adaptives Training -->
    <section id="view-train" class="view">
      <div class="panel">
        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <div>
            <h3>Adaptiv trainieren</h3>
            <div class="muted" style="max-width:720px">
              Wiederholt Fragen mit niedriger Quote häufiger. Ab 3× korrekt in Folge → „gelernt“ und ausgeblendet (mit Cooldown).
            </div>
          </div>
          <div class="row">
            <select id="train-category"><option value="">Alle Kategorien</option></select>
            <label class="row"><input type="checkbox" id="train-weak"/> <span>Nur Schwächen</span></label>
            <label class="row"><input type="checkbox" id="train-hide-learned" checked/> <span>Gelernt ausblenden</span></label>
            <button id="train-next" class="btn primary">Nächste Karte</button>
          </div>
        </div>
        <div id="train-area" class="cards" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- Prüfung (IHK 2.0) -->
    <section id="view-exam" class="view">
      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <h3>Prüfungssimulation (IHK‑Stil)</h3>
          <div class="row">
            <select id="exam-categories" multiple></select>
            <input id="exam-count" type="number" value="40" min="5" max="100" style="width:90px"/>
            <input id="exam-minutes" type="number" value="60" min="5" max="180" style="width:90px"/>
            <button id="exam-start" class="btn primary">Start</button>
            <button id="exam-submit" class="btn" disabled>Abgeben</button>
            <button id="exam-reset" class="btn">Reset</button>
          </div>
        </div>
        <div id="exam-meta" class="muted" style="margin:8px 0"></div>
        <div id="exam-area" class="cards"></div>
      </div>
    </section>

    <!-- Fortschritt -->
    <section id="view-progress" class="view">
      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <h3>Dein Fortschritt</h3>
          <button id="reset-progress" class="btn">Lokalen Fortschritt zurücksetzen</button>
        </div>
        <div id="progress-summary" class="cards"></div>
      </div>
    </section>

    <!-- Admin -->
    <section id="view-admin" class="view">
      <div class="panel">
        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <h3>Admin</h3>
          <div class="row">
            <button id="admin-export" class="btn">Export JSON</button>
            <input type="file" id="admin-import" accept="application/json" multiple/>
          </div>
        </div>

        <div class="card admin-section">
          <h4>Kategorie verwalten</h4>
          <div class="row">
            <select id="admin-cat-old"></select>
            <input id="admin-cat-new" placeholder="Neue Kategorie (umbenennen/zusammenführen)"/>
            <button id="admin-cat-apply" class="btn primary">Anwenden</button>
            <span id="admin-cat-state" class="muted"></span>
          </div>
        </div>

        <div class="card admin-section">
          <h4>Duplikate scannen & bereinigen</h4>
          <div class="row">
            <button id="admin-scan-dup" class="btn">Scan starten</button>
            <button id="admin-fix-dups" class="btn">Duplikate fixen (Auto)</button>
            <button id="admin-migrate-cats" class="btn">Kategorien bereinigen (Auto)</button>
          </div>
          <div class="row" style="gap:16px;margin-top:6px">
            <span id="admin-fix-state" class="muted"></span>
            <span id="admin-migrate-state" class="muted"></span>
          </div>
          <div id="admin-dup-list" class="cards" style="margin-top:10px"></div>
        </div>

        <form id="admin-form" onsubmit="return false;" class="card admin-section">
          <h4>Neue Frage</h4>
          <input id="ad-category" placeholder="z.B. LL01/2 – Güter kontrollieren" required/>
          <textarea id="ad-question" rows="2" placeholder="Frage" required></textarea>
          <textarea id="ad-options" rows="4" placeholder="***Korrekt
Falsch 1
Falsch 2" required></textarea>
          <textarea id="ad-expl" rows="2" placeholder="Erklärung (optional)"></textarea>
          <div class="row"><button id="admin-save" class="btn primary">Speichern (DB)</button></div>
        </form>

        <div id="admin-list" class="cards"></div>
      </div>
    </section>
  </div>

<script>
/* ====== Utilities / Setup ====== */
const views=['login','flashcards','train','exam','progress','admin'];
document.querySelectorAll('.nav button[data-view]').forEach(b=>b.onclick=()=>{
  const v=b.dataset.view;
  // Blocke Navigation, wenn nicht eingeloggt
  if (!window.__IS_LOGGED_IN__ && v!=='login') return;
  // Blocke Admin-View, wenn kein Admin
  if (v==='admin' && !window.__IS_ADMIN__) return;
  views.forEach(x=>document.getElementById('view-'+x).classList.toggle('active',x===v));
});
const shuffle=a=>{const b=a.slice();for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]];}return b;};

const KEY_URL='supabase_url', KEY_ANON='supabase_anon', KEY_LOGO='app_logo_url';
let supa=null;

// Defaults fest eingebaut
window.__APP_CONFIG__ = {
  SUPABASE_URL: "https://ebqfupcivmkbuadbbnwg.supabase.co",
  SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVicWZ1cGNpdm1rYnVhZGJibndnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MDA5ODIsImV4cCI6MjA3MDQ3Njk4Mn0.P6IiwjFSpqVmObRbvxvY46l6vJlPsxPAc-wbr15Dhl0",
  LOGO_URL: "https://ebqfupcivmkbuadbbnwg.supabase.co/storage/v1/object/public/app-assets/logo.png"
};

/* --- Admin-Definition (Whitelist) --- */
const ADMIN_EMAILS = ["mario1986ac@hotmail.de"]; // lowercase
const ADMIN_DOMAIN = ""; // leer lassen

/* ====== Rollen-/UI-Flags ====== */
window.__IS_ADMIN__ = false;
window.__IS_LOGGED_IN__ = false;

function isAdmin(user){
  if(!user) return false;
  const email = (user.email || "").toLowerCase().trim();
  const wl = ADMIN_EMAILS.map(e => e.toLowerCase().trim());
  const domain = (ADMIN_DOMAIN || "").toLowerCase().trim();
  // Supabase Metadaten berücksichtigen (optional)
  const app = user.app_metadata || {};
  const um  = user.user_metadata || {};
  const rolesStr = (
    Array.isArray(app.roles) ? app.roles.join(",") :
    app.roles || app.role || um.roles || um.role || ""
  ).toString().toLowerCase();
  const metaFlag = app.is_admin ?? app.admin ?? um.is_admin ?? um.admin;

  if (email && wl.includes(email)) return true;
  if (email && domain && email.endsWith('@'+domain)) return true;
  if (rolesStr.includes('admin')) return true;
  if (metaFlag === true || String(metaFlag).toLowerCase()==='true') return true;
  return false;
}

function setNavVisibility({loggedIn, admin}){
  const ids = {
    login: document.getElementById('tab-login'),
    flash: document.getElementById('tab-flash'),
    train: document.getElementById('tab-train'),
    exam: document.getElementById('tab-exam'),
    progress: document.getElementById('tab-progress'),
    admin: document.getElementById('tab-admin'),
    settings: document.getElementById('btn-settings')
  };
  // alles verstecken außer Login
  if (ids.flash) ids.flash.classList.add('hide');
  if (ids.train) ids.train.classList.add('hide');
  if (ids.exam) ids.exam.classList.add('hide');
  if (ids.progress) ids.progress.classList.add('hide');
  if (ids.admin) ids.admin.classList.add('hide');
  if (ids.settings) ids.settings.classList.add('hide');
  if (loggedIn){
    if (ids.flash) ids.flash.classList.remove('hide');
    if (ids.train) ids.train.classList.remove('hide');
    if (ids.exam) ids.exam.classList.remove('hide');
    if (ids.progress) ids.progress.classList.remove('hide');
    if (admin){
      if (ids.admin) ids.admin.classList.remove('hide');
      if (ids.settings) ids.settings.classList.remove('hide');
    }
  }
}

function enforceViewForAuth(){
  const loginView = document.getElementById('view-login');
  const active = document.querySelector('.view.active');
  if (!window.__IS_LOGGED_IN__){
    views.forEach(x=>document.getElementById('view-'+x).classList.remove('active'));
    if (loginView) loginView.classList.add('active');
  } else if (!active || active.id==='view-login'){
    const first = document.getElementById('view-flashcards');
    if (first){ first.classList.add('active'); }
  }
}

function updateRoleFlagsAndUI(user){
  window.__IS_LOGGED_IN__ = !!user;
  window.__IS_ADMIN__ = isAdmin(user);
  setNavVisibility({loggedIn: window.__IS_LOGGED_IN__, admin: window.__IS_ADMIN__});
  enforceViewForAuth();
  console.log("[auth] loggedIn:", !!user, "admin:", window.__IS_ADMIN__, "email:", (user?.email||""));
}

/* Logo */
function applyBranding(){
  const logo = localStorage.getItem(KEY_LOGO);
  const el = document.querySelector('.brand .logo');
  if (logo && el){ el.style.background='none'; el.style.backgroundImage=`url(${logo})`; el.style.backgroundSize='cover'; el.style.backgroundPosition='center'; el.style.border='1px solid var(--line)'; }
}

/* ====== Normalisierung & Darstellung ====== */
function normalizeBasic(cat){
  if (!cat) return '';
  return String(cat)
    .normalize('NFKC')
    .replace(/[\u200B-\u200D\uFEFF\u2060]/g,'')
    .replace(/\u00A0/g,' ')
    .replace(/[\u2012-\u2015\u2212\uFE58\uFE63\uFF0D]/g,'-')
    .replace(/\s*\/\s*/g,'/')
    .replace(/\s*-\s*/g,' - ')
    .replace(/\s*:\s*/g,': ')
    .replace(/\s+/g,' ')
    .trim();
}
function normalizeCategory(cat, { aggressive = true } = {}){
  let s = normalizeBasic(cat);
  if (!aggressive) return s;
  // Spezielle Heuristik für LL02/1-3
  const m = s.match(/^LL0?2\/([1-3])(?:\s*[-–:]?\s*)?(?:G[üu]ter\s+lagern)?(?:\s*[-–:]?\s*)?(?:Teil\s*(\d))?(?:\s*[-–:]\s*)?(.*)$/i);
  if (m){
    const k = m[1]; const t = m[2] || k; const tail = (m[3]||'').toLowerCase().trim();
    let title = '';
    if (tail.includes('grundlagen')) title='Grundlagen';
    else if (tail.includes('lagereinrichtungen')) title='Lagereinrichtungen';
    else if (tail.includes('gefähr') || tail.includes('gefaehr')) title='Gefährliche Stoffe';
    else if (t==='1') title='Grundlagen';
    else if (t==='2') title='Lagereinrichtungen';
    else if (t==='3') title='Gefährliche Stoffe';
    s = `LL02/${k} Güter lagern - Teil ${t}: ${title}`;
  }
  return s;
}
function prettyCategory(name){
  const s = normalizeBasic(name || '');
  const m = s.match(/^LL0?2\/([1-3])\s+G[üu]ter\s+lagern\s*-\s*Teil\s*(\d)\s*:\s*(.+)$/i);
  if (m){
    const title = m[3].trim();
    return `LL02/${m[1]} - Güter lagern Teil ${m[2]}: ${title}`;
  }
  return s;
}
function compareCategoryCode(aName, bName){
  const a = aName.match(/^LL(\d{2})\/(\d)/i);
  const b = bName.match(/^LL(\d{2})\/(\d)/i);
  if (a && b){ if (a[1]!==b[1]) return +a[1]-+b[1]; return +a[2]-+b[2]; }
  return aName.localeCompare(bName,'de');
}

/* ====== Einstellungen ====== */
document.getElementById('btn-settings').onclick=()=>{
  if(!window.__IS_ADMIN__) return; // Schutz
  const modal=document.getElementById('settings-modal');
  modal.classList.add('show');
  document.getElementById('cfg-url').value=localStorage.getItem(KEY_URL)||'';
  document.getElementById('cfg-key').value=localStorage.getItem(KEY_ANON)||'';
  document.getElementById('cfg-logo').value=localStorage.getItem(KEY_LOGO)||'';
};
document.getElementById('cfg-close').onclick=()=>document.getElementById('settings-modal').classList.remove('show');
document.getElementById('cfg-save').onclick=()=>{localStorage.setItem(KEY_URL, document.getElementById('cfg-url').value.trim());
  localStorage.setItem(KEY_ANON, document.getElementById('cfg-key').value.trim());
  const logo=document.getElementById('cfg-logo').value.trim();
  if(logo) localStorage.setItem(KEY_LOGO, logo); else localStorage.removeItem(KEY_LOGO);
  applyBranding(); document.getElementById('cfg-state').textContent='Gespeichert. Seite lädt neu...';
  setTimeout(()=>location.reload(),400);
};

/* ====== Supabase Init ====== */
async function initClient(){
  const params = new URLSearchParams(location.search);
  const cfg = window.__APP_CONFIG__ || {};
  const url  = localStorage.getItem(KEY_URL)  || cfg.SUPABASE_URL      || params.get('url')  || '';
  const anon = localStorage.getItem(KEY_ANON) || cfg.SUPABASE_ANON_KEY || params.get('key')  || '';
  const logo = localStorage.getItem(KEY_LOGO) || cfg.LOGO_URL          || params.get('logo') || '';
  if (!localStorage.getItem(KEY_URL)  && url)  localStorage.setItem(KEY_URL,  url);
  if (!localStorage.getItem(KEY_ANON) && anon) localStorage.setItem(KEY_ANON, anon);
  if (!localStorage.getItem(KEY_LOGO) && logo) localStorage.setItem(KEY_LOGO, logo);

  if(!url || !anon){
    const i=document.getElementById('login-empty-info');
    if(i){ i.style.display='block'; i.textContent='Bitte unter Einstellungen Project URL & Anon Key eintragen.'; }
    applyBranding();
    updateRoleFlagsAndUI(null);
    return;
  }

  supa = supabase.createClient(url, anon);
  applyBranding();

  // Auth-Status
  try {
    const { data:{ user } = {} } = await supa.auth.getUser();
    updateRoleFlagsAndUI(user);
  } catch {
    updateRoleFlagsAndUI(null);
  }
  supa.auth.onAuthStateChange((_e, session) => updateRoleFlagsAndUI(session?.user || null));

  renderProgress();
  await refreshAuthUI();
  await refreshSelectors();
  await refreshTrainSelectors();
  await refreshExamCategories();
  await renderAdminList();
  await showEmptyHints();
  await fillAdminCatSelect();

  const AUTO_FIX_KNOWN_CATEGORIES = true;
  if (AUTO_FIX_KNOWN_CATEGORIES) { try { await autoFixKnownCats(); } catch {} }
}

/* ====== Auth ====== */
const email=document.getElementById('email'), password=document.getElementById('password');
const btnSignup=document.getElementById('btn-signup'), btnLogin=document.getElementById('btn-login'), btnLogout=document.getElementById('btn-logout');
const authState=document.getElementById('auth-state');

async function refreshAuthUI(){
  if(!supa){ authState.textContent='Konfiguration fehlt'; updateRoleFlagsAndUI(null); return; }
  const {data:{user}}=await supa.auth.getUser();
  if(user){btnLogout.disabled=false;btnLogin.disabled=true;btnSignup.disabled=true;authState.textContent=`Eingeloggt: ${user.email}`;}
  else {btnLogout.disabled=true;btnLogin.disabled=false;btnSignup.disabled=false;authState.textContent='Nicht eingeloggt';}
  updateRoleFlagsAndUI(user);
}
btnSignup.onclick=async()=>{if(!supa) return; const {error}=await supa.auth.signUp({email:email.value,password:password.value}); if(error) alert(error.message); else alert('Registriert. Prüfe dein Postfach.'); refreshAuthUI();};
btnLogin.onclick=async()=>{if(!supa) return; const {error}=await supa.auth.signInWithPassword({email:email.value,password:password.value}); if(error) alert(error.message); await refreshAuthUI();};
btnLogout.onclick=async()=>{if(!supa) return; await supa.auth.signOut(); await refreshAuthUI();};

/* ====== Data helpers ====== */
async function fetchQuestions(){
  if(!supa) return [];
  const {data,error}=await supa.from('questions').select('*').order('category',{ascending:true});
  if(error){console.warn(error); return [];}
  return (data||[]).map(q => ({ ...q, category: normalizeCategory(q.category) })); // aggressiv
}
async function fetchCategories(){ const q=await fetchQuestions(); return [...new Set(q.map(x=>x.category))].sort(compareCategoryCode); }
async function fetchCategoriesWithCounts(){
  const all = await fetchQuestions();
  const map = {};
  for (const q of all) map[q.category] = (map[q.category]||0) + 1;
  return Object.entries(map).map(([name,count])=>({name,count})).sort((a,b)=>compareCategoryCode(a.name,b.name));
}

/* ====== Lernkarten ====== */
const fcCategory=document.getElementById('fc-category'), fcArea=document.getElementById('fc-area'), fcStats=document.getElementById('fc-stats'), fcEmpty=document.getElementById('fc-empty');
document.getElementById('fc-load').onclick=loadFlashcards;
async function refreshSelectors(){
  const cats=await fetchCategoriesWithCounts();
  fcCategory.innerHTML=cats.map(c=>`<option value="${c.name}" title="${c.name}">${prettyCategory(c.name)} (${c.count})</option>`).join('');
}
async function loadFlashcards(){
  if(!window.__IS_LOGGED_IN__) return;
  const all=await fetchQuestions(); const cat=fcCategory.value; const cards=all.filter(x=>x.category===cat);
  fcArea.innerHTML=''; if(cards.length===0){ fcEmpty.style.display='block'; fcEmpty.textContent='Keine Fragen in dieser Kategorie. Admin → Import nutzen.'; fcStats.textContent='0 Karten'; return;} else fcEmpty.style.display='none';
  let n=0; cards.forEach(card=>{ const wrap=document.createElement('div'); wrap.className='card';
    const opts=card.options.map((t,i)=>({text:t,correct:i===card.correct_index}));
    wrap.innerHTML=`<div class="row" style="justify-content:space-between"><div><span class="chip">${prettyCategory(card.category)}</span></div><div class="muted">ID: ${card.id}</div></div>
      <div><b>${card.question}</b></div><div class="options"></div>
      <div class="row" style="margin-top:8px"><span class="muted">Klick zum Markieren, Lösung wird angezeigt.</span></div>
      <div class="reveal" style="display:none"></div>`;
    const box=wrap.querySelector('.options');
    opts.forEach((o,i)=>{ const d=document.createElement('div'); d.className='option'; d.innerHTML=`<input type="radio"/><span>${o.text}</span>`;
      d.onclick=async()=>{ [...box.children].forEach(c=>c.classList.remove('selected')); d.classList.add('selected');
        const ok=(i===opts.findIndex(z=>z.correct)); const rev=wrap.querySelector('.reveal'); rev.style.display='block';
        rev.textContent = ok? '✅ Richtig!' : `❌ Falsch. Richtig: ${opts.find(o=>o.correct)?.text}`;
        bumpProgress(1, ok?1:0);
        const {data:{user}}=await supa.auth.getUser(); if(user) await supa.from('reviews').insert({user_id:user.id,question_id:card.id,correct:ok});
      };
      box.appendChild(d);
    });
    fcArea.appendChild(wrap); n++;
  }); fcStats.textContent=`${n} Karten`;
}

/* ====== Adaptives Training ====== */
const trCategory=document.getElementById('train-category'), trWeak=document.getElementById('train-weak'), trHideLearned=document.getElementById('train-hide-learned');
const trNext=document.getElementById('train-next'), trArea=document.getElementById('train-area'), trEmpty=document.getElementById('train-empty');

async function refreshTrainSelectors(){
  const cats=await fetchCategoriesWithCounts();
  trCategory.innerHTML='<option value="">Alle Kategorien</option>'+cats.map(c=>`<option value="${c.name}" title="${c.name}">${prettyCategory(c.name)} (${c.count})</option>`).join('');
}
async function getUser(){ try{ const {data:{user}}=await supa.auth.getUser(); return user||null; }catch{return null;} }

async function fetchStatsMap(userId){
  const map={}; if(!userId) return map;
  const { data } = await supa.from('reviews').select('question_id,ts,correct').eq('user_id',userId).order('ts',{ascending:true});
  (data||[]).forEach(r=>{
    const m = map[r.question_id] ||= { seen:0, correct:0, streak:0, last:false, lastTs:null };
    m.seen++; if(r.correct){ m.correct++; m.streak = (m.last===true)?(m.streak+1):1; } else { m.streak = 0; }
    m.last = r.correct; m.lastTs = r.ts;
  });
  return map;
}
function cooldownDaysForStreak(s){ if(s>=5) return 14; if(s>=4) return 7; if(s>=3) return 3; if(s>=2) return 1; return 0; }
function isInCooldown(entry){ if(!entry||!entry.lastTs) return false; const d=cooldownDaysForStreak(entry.streak||0); if(d<=0) return false; const next=new Date(entry.lastTs); next.setDate(next.getDate()+d); return (new Date()<next); }

async function pickAdaptiveCard(categoryFilter, onlyWeak, hideLearned){
  const all=await fetchQuestions();
  const user=await getUser();
  const stats = await fetchStatsMap(user?.id);
  let pool = all.filter(q => !categoryFilter || q.category===categoryFilter).map(q=>{
    const s = stats[q.id] || { seen:0, correct:0, last:false, streak:0, lastTs:null };
    const acc = s.seen ? s.correct/s.seen : 0;
    const wrongBias = (s.last===false) ? 0.2 : 0;
    const seenPenalty = Math.min(s.seen*0.02, 0.2);
    const streak = s.streak||0;
    const learned = (streak>=3);
    const cooldown = isInCooldown(s);
    let weight = (1-acc) + wrongBias - seenPenalty;
    if(learned && hideLearned) weight -= 1.5;
    if(cooldown) weight -= 0.8;
    return { q, s, acc, learned, cooldown, weight };
  });
  if(onlyWeak) pool = pool.filter(x => (x.acc<0.7) || (x.s.last===false));
  pool = pool.filter(x=>x.weight> -0.3);
  if(pool.length===0) return null;
  const minW = Math.min(...pool.map(x=>x.weight));
  const normalized = pool.map(p=>({ ...p, w: p.weight - minW + 0.001 }));
  const sum = normalized.reduce((a,b)=>a+b.w,0);
  let r = Math.random()*sum; for(const p of normalized){ r-=p.w; if(r<=0) return p.q; }
  return normalized[normalized.length-1].q;
}
function renderTrainCard(card){
  trArea.innerHTML=''; if(!card){ trEmpty.style.display='block'; trEmpty.textContent='Keine geeignete Karte gefunden. Passe Filter an (z. B. „Gelernt ausblenden“ deaktivieren).'; return; }
  trEmpty.style.display='none';
  const opts=card.options.map((t,i)=>({text:t,correct:i===card.correct_index}));
  const wrap=document.createElement('div'); wrap.className='card';
  wrap.innerHTML = `
    <div class="row" style="justify-content:space-between">
      <div><span class="chip">${prettyCategory(card.category)}</span></div>
      <div class="muted">ID: ${card.id}</div>
    </div>
    <div style="margin-top:6px"><b>${card.question}</b></div>
    <div class="options" style="margin-top:6px"></div>
    <div class="reveal" style="display:none;margin-top:8px"></div>`;
  const box=wrap.querySelector('.options');
  opts.forEach((o,i)=>{ const d=document.createElement('div'); d.className='option';
    d.innerHTML=`<input type="radio"/> <span>${o.text}</span>`;
    d.onclick=async()=>{ [...box.children].forEach(c=>c.classList.remove('selected')); d.classList.add('selected');
      const ok = (i===opts.findIndex(z=>z.correct)); const rev=wrap.querySelector('.reveal'); rev.style.display='block';
      rev.textContent = ok? '✅ Richtig!' : `❌ Falsch. Richtig: ${opts.find(o=>o.correct)?.text}`;
      bumpProgress(1, ok?1:0);
      const {data:{user}}=await supa.auth.getUser(); if(user) await supa.from('reviews').insert({user_id:user.id,question_id:card.id,correct:ok});
    };
    box.appendChild(d);
  });
  trArea.appendChild(wrap);
}
trNext.onclick=async()=>{ if(!window.__IS_LOGGED_IN__) return; const card = await pickAdaptiveCard(trCategory.value||null, trWeak.checked, trHideLearned.checked); renderTrainCard(card); };

/* ====== IHK-Prüfungsmodus ====== */
const examCategories=document.getElementById('exam-categories'), examCount=document.getElementById('exam-count'), examMinutes=document.getElementById('exam-minutes');
const examStart=document.getElementById('exam-start'), examSubmit=document.getElementById('exam-submit'), examReset=document.getElementById('exam-reset');
const examArea=document.getElementById('exam-area'), examMeta=document.getElementById('exam-meta');

let ihkRunning=false, timerId=null, timeLeft=0;
let examPool=[], selections={}, session=null;

function ensureStickySubmit(){ let b=document.getElementById('exam-submit-sticky'); if(!b){ b=document.createElement('button'); b.id='exam-submit-sticky'; b.textContent='Abgeben'; b.onclick=()=>examSubmit.click(); document.body.appendChild(b); } b.disabled=!ihkRunning; updateStickySubmitLabel(); return b; }
function removeStickySubmit(){ const b=document.getElementById('exam-submit-sticky'); if(b) b.remove(); }
function updateStickySubmitLabel(){ const b=document.getElementById('exam-submit-sticky'); if(!b) return; const total=examPool.length||0; const answered=Object.values(selections).filter(v=>v!=null).length; b.textContent = total? `Abgeben (${answered}/${total})`:'Abgeben'; b.disabled=!ihkRunning; }

async function refreshExamCategories(){
  const cats=await fetchCategoriesWithCounts();
  examCategories.innerHTML=cats.map(c=>`<option value="${c.name}" selected title="${c.name}">${prettyCategory(c.name)} (${c.count})</option>`).join('');
}
function pickN(a,n){ const b=shuffle(a); return b.slice(0,Math.max(0,Math.min(n,b.length))); }
function renderMeta(){ const total=examPool.length; const answered=Object.values(selections).filter(v=>v!=null).length; const mm=String(Math.max(0,Math.floor(timeLeft/60))).padStart(2,'0'); const ss=String(Math.max(0,timeLeft%60)).padStart(2,'0'); examMeta.textContent=`Fragen: ${answered}/${total} • Restzeit ${mm}:${ss}`; updateStickySubmitLabel(); }

examStart.onclick=async()=>{ if(!window.__IS_LOGGED_IN__) return alert('Bitte zuerst einloggen.');
  const all=await fetchQuestions(); const chosen=[...examCategories.selectedOptions].map(o=>o.value);
  const pool=all.filter(q=>chosen.includes(q.category)); if(!pool.length) return alert('Keine Fragen in den gewählten Kategorien.');
  const n=Math.max(5,Math.min(Number(examCount.value||40),100));
  examPool = pickN(pool,n); selections={}; examArea.innerHTML=''; ihkRunning=true; examSubmit.disabled=false;
  timeLeft=(Number(examMinutes.value||60))*60; renderMeta();
  if(timerId) clearInterval(timerId);
  timerId=setInterval(()=>{ timeLeft--; renderMeta(); if(timeLeft<=0){ clearInterval(timerId); finishExam(true); } },1000);
  examPool.forEach((q,idx)=>{ const el=document.createElement('div'); el.className='card';
    const opts=q.options.map((t,i)=>({text:t,correct:i===q.correct_index}));
    el.innerHTML=`<div class="row" style="justify-content:space-between"><div><span class="chip">${prettyCategory(q.category)}</span></div><div class="muted">Frage ${idx+1}/${n}</div></div>
      <div style="margin-top:4px"><b>${q.question}</b></div><div class="options"></div>`;
    const box=el.querySelector('.options');
    opts.forEach((o,i)=>{ const d=document.createElement('label'); d.className='option'; d.innerHTML=`<input type="radio" name="q_${q.id}"/> <span>${o.text}</span>`;
      d.onclick=()=>{ selections[q.id]=i; [...box.children].forEach(c=>c.classList.remove('selected')); d.classList.add('selected'); renderMeta(); };
      box.appendChild(d);
    });
    examArea.appendChild(el);
  });
  session = { items:[], total:n, correct:0, startedAt:new Date().toISOString() };
  ensureStickySubmit();
};
examSubmit.onclick=()=>{ if(!ihkRunning) return; finishExam(false); };
examReset.onclick=()=>{ ihkRunning=false; clearInterval(timerId); examArea.innerHTML=''; examMeta.textContent=''; examSubmit.disabled=true; removeStickySubmit(); };

async function finishExam(auto=false){
  ihkRunning=false; clearInterval(timerId); examSubmit.disabled=true; removeStickySubmit();
  session.items = examPool.map(q=>{ const chosenIndex=selections[q.id]; const correctIndex=q.correct_index; const correct=chosenIndex===correctIndex;
    return { id:q.id, category:q.category, question:q.question, selectedText:(q.options[chosenIndex]??''), correctText:q.options[correctIndex], explanation:q.explanation||'', correct }; });
  session.correct = session.items.filter(x=>x.correct).length; session.finishedAt=new Date().toISOString();

  const {data:{user}}=await supa.auth.getUser();
  if(user){
    try { await supa.from('exam_sessions').insert({ user_id:user.id, total:session.total, correct:session.correct, detail:session.items }); } catch(e){ console.warn('exam_sessions insert', e); }
    try { for(const it of session.items){ await supa.from('reviews').insert({user_id:user.id,question_id:it.id,correct:it.correct}); } } catch(e){ console.warn('reviews insert', e); }
  }
  showResult(session, auto);
}

/* ====== Ergebnis-Panel + PDF ====== */
function showResult(session){
  const modal=document.getElementById('result-modal');
  document.getElementById('res-total').textContent = `${session.correct} / ${session.total}`;
  document.getElementById('res-quote').textContent = `${session.total?Math.round(100*session.correct/session.total):0}%`;
  document.getElementById('res-date').textContent = new Date().toLocaleString();

  const byCat={}; session.items.forEach(it=>{ const c=it.category||'–'; byCat[c]=byCat[c]||{total:0,correct:0}; byCat[c].total++; byCat[c].correct+=it.correct?1:0; });
  const cats = Object.entries(byCat).map(([c,s])=>{ const pct=s.total? Math.round(100*s.correct/s.total):0;
    return `<div class="row" style="justify-content:space-between;border-bottom:1px dashed var(--line);padding:6px 0"><div>${prettyCategory(c)}</div><div class="muted">${s.correct}/${s.total} (${pct}%)</div></div>`; }).join('');
  document.getElementById('res-cats').innerHTML=cats||'<div class="muted">Keine Daten.</div>';

  const items=document.getElementById('res-items');
  items.innerHTML = session.items.map((it,i)=>`
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div><span class="chip">${prettyCategory(it.category||'')}</span></div>
        <div class="chip" style="border-color:${it.correct?'var(--success)':'var(--danger)'};color:${it.correct?'var(--success)':'var(--danger)'}">${it.correct?'Richtig':'Falsch'}</div>
      </div>
      <div style="margin-top:6px"><b>${i+1}. ${it.question}</b></div>
      <div style="margin-top:6px"><b>Deine Antwort:</b> ${it.selectedText||''}</div>
      <div><b>Richtige Lösung:</b> ${it.correctText||''}</div>
      ${it.explanation?`<div><b>Erklärung:</b> ${it.explanation}</div>`:''}
    </div>`).join('');

  document.getElementById('res-new').onclick=()=>{ modal.classList.remove('show'); examReset.click(); };
  document.getElementById('res-close').onclick=()=> modal.classList.remove('show');
  document.getElementById('result-pdf').onclick = async () => {
    const { data:{user} = {} } = await supa.auth.getUser();
    const logo = localStorage.getItem(KEY_LOGO) || null;
    await generateExamPDF({ session, userEmail: user?.email || "", logoUrlOrDataUri: logo });
  };

  modal.classList.add('show');
}

/* ====== Fortschritt (lokal) ====== */
function bumpProgress(seenDelta, correctDelta){
  const p = JSON.parse(localStorage.getItem('progress_local') || '{"seen":0,"correct":0}');
  p.seen += seenDelta; p.correct += correctDelta;
  localStorage.setItem('progress_local', JSON.stringify(p));
  renderProgress();
}
function renderProgress(){
  const p = JSON.parse(localStorage.getItem('progress_local') || '{"seen":0,"correct":0}');
  const acc = p.seen ? Math.round(p.correct/p.seen*100) : 0;
  document.getElementById('progress-summary').innerHTML = `
    <div class="card"><b>Letzte Sitzung</b>
    <div>Beantwortet: <b>${p.seen}</b> • Richtig: <b>${p.correct}</b> • Quote: <b>${acc}%</b></div></div>`;
}
document.getElementById('reset-progress').onclick=()=>{localStorage.removeItem('progress_local'); renderProgress();}

/* ====== Admin ====== */
const adminList=document.getElementById('admin-list');
async function renderAdminList(){ const q=await fetchQuestions();
  adminList.innerHTML=q.map(x=>`<div class="card"><div class="row" style="justify-content:space-between">
  <div><span class="chip">${prettyCategory(x.category)}</span></div><button data-del="${x.id}" class="btn">Löschen</button></div>
  <div><b>${x.question}</b></div></div>`).join('');
  adminList.querySelectorAll('button[data-del]').forEach(btn=>btn.onclick=async()=>{const id=btn.getAttribute('data-del'); const {error}=await supa.from('questions').delete().eq('id',id); if(error) alert(error.message); else renderAdminList();});
}

document.getElementById('admin-export').onclick=async()=>{const q=await fetchQuestions(); const blob=new Blob([JSON.stringify(q,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='fragen_export_supabase.json'; a.click(); URL.revokeObjectURL(url);};

document.getElementById('admin-import').onchange=async(e)=>{
  const files=[...(e.target.files||[])]; if(!files.length) return;
  const allItems=[];
  for(const f of files){
    try{
      const text=await f.text(); const arr=JSON.parse(text);
      if(Array.isArray(arr)) allItems.push(...arr);
      else if(arr && typeof arr==='object') allItems.push(arr);
    }catch(err){ alert(`Fehler in ${f.name}: ${err.message}`); }
  }
  if(!allItems.length){ alert('Keine gültigen Fragen gefunden.'); return; }

  const cleaned = allItems
    .map(x=>{
      const { deck, correctIndex, ...rest } = x || {};
      const cat = normalizeCategory(rest.category || rest.category_name || ''); // aggressiv
      return { ...rest, category: cat, correct_index: rest.correct_index ?? correctIndex };
    })
    .filter(x=>x && x.id && Array.isArray(x.options) && Number.isInteger(x.correct_index));

  let okCount=0, errCount=0;
  for(const item of cleaned){
    const {error}=await supa.from('questions').upsert(item,{onConflict:'id'});
    if(error){ errCount++; console.warn('Fehler',item.id,error.message); } else okCount++;
  }
  alert(`Import fertig. Erfolgreich: ${okCount} • Fehler: ${errCount}`);
  await renderAdminList(); await refreshSelectors(); await refreshTrainSelectors(); await refreshExamCategories(); await showEmptyHints(); await fillAdminCatSelect();
};

async function fillAdminCatSelect(){
  const cats=await fetchCategories();
  document.getElementById('admin-cat-old').innerHTML = cats.map(c=>`<option value="${c}">${prettyCategory(c)}</option>`).join('');
}
document.getElementById('admin-cat-apply').onclick=async()=>{
  const oldVal=document.getElementById('admin-cat-old').value;
  const newRaw=(document.getElementById('admin-cat-new').value||'').trim();
  const newVal=normalizeCategory(newRaw,{aggressive:false}); // SAFE

  if(!oldVal || !newVal) return alert('Bitte alte Kategorie wählen und neue Kategorie eintragen.');
  const { error, count } = await supa.from('questions').update({category:newVal}).eq('category',oldVal).select('id',{count:'exact'});
  document.getElementById('admin-cat-state').textContent = error? ('Fehler: '+error.message) : (`Geändert: ${count||0}`);
  await renderAdminList(); await refreshSelectors(); await refreshTrainSelectors(); await refreshExamCategories(); await fillAdminCatSelect();
};

document.getElementById('admin-scan-dup').onclick=async()=>{
  const list=document.getElementById('admin-dup-list'); list.innerHTML='Suche…';
  const q=await fetchQuestions(); if(!q.length){ list.innerHTML='<div class="card muted">Keine Fragen.</div>'; return; }
  const byText={};
  for(const it of q){
    const key=(it.question||'').trim().toLowerCase();
    (byText[key] ||= []).push(it);
  }
  const groups=Object.values(byText).filter(arr=>arr.length>1);
  if(!groups.length){ list.innerHTML='<div class="card">Keine Duplikate per Fragentext gefunden.</div>'; return; }
  list.innerHTML = groups.map(arr=>{
    const head=arr[0].question.slice(0,120);
    const rows=arr.map(x=>`<div class="row" style="justify-content:space-between"><div><span class="chip">${prettyCategory(x.category)}</span></div><div class="muted">${x.id}</div></div>`).join('');
    return `<div class="card"><div><b>${head}</b></div>${rows}</div>`;
  }).join('');
};

/* Auto-Fix: Kategorien mit gleicher Normalisierung zusammenführen */
document.getElementById('admin-fix-dups').onclick = async () => {
  const state = document.getElementById('admin-fix-state');
  state.textContent = 'Suche Duplikate…';
  const { data, error } = await supa.from('questions').select('id,category');
  if (error) { state.textContent = 'Fehler: '+error.message; return; }

  const groups = {}; // canon -> Set(raw)
  for (const row of (data||[])) {
    const raw = row.category || '';
    const canon = normalizeCategory(raw); // aggressiv
    (groups[canon] ||= new Set()).add(raw);
  }
  const dups = Object.entries(groups).filter(([, raws]) => raws.size > 1);
  if (!dups.length) { state.textContent = 'Keine Duplikate gefunden.'; return; }

  let totalChanged = 0;
  for (const [canon, raws] of dups) {
    const rawList = [...raws];
    const counts = {};
    for (const row of data) if (raws.has(row.category)) counts[row.category] = (counts[row.category]||0) + 1;
    const canonicalRaw = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0] || canon;

    const targets = rawList.filter(r => r !== canonicalRaw);
    if (targets.length) {
      const { error: updErr, count } = await supa
        .from('questions')
        .update({ category: normalizeCategory(canonicalRaw) })
        .in('category', targets)
        .select('id', { count: 'exact' });
      if (!updErr) totalChanged += (count||0);
    }
  }

  state.textContent = `Fertig. Geänderte Einträge: ${totalChanged}`;
  await renderAdminList(); await refreshSelectors(); await refreshTrainSelectors(); await refreshExamCategories(); await fillAdminCatSelect();
};

/* Vollmigration */
async function autoFixKnownCats(){
  const { data, error } = await supa.from('questions').select('id, category');
  if (error) return;
  const toUpdate=[];
  for (const row of data || []) {
    const canon = normalizeCategory(row.category || '');
    if (canon && canon !== row.category) toUpdate.push({ id: row.id, category: canon });
  }
  let changed=0; const batchSize=500;
  for (let i=0; i<toUpdate.length; i+=batchSize){
    const chunk=toUpdate.slice(i,i+batchSize);
    const { error:updErr, count } = await supa.from('questions').upsert(chunk,{onConflict:'id'}).select('id',{count:'exact'});
    if (!updErr) changed += (count||0);
  }
  const el=document.getElementById('admin-migrate-state');
  if (el) el.textContent=`Auto-Fix ausgeführt: ${changed} aktualisiert`;
}
document.getElementById('admin-migrate-cats').onclick = autoFixKnownCats;

document.getElementById('admin-save').onclick=async()=>{
  if(!window.__IS_ADMIN__) return;
  const id='q_'+Math.random().toString(36).slice(2,10);
  const categoryRaw=document.getElementById('ad-category').value.trim();
  const category=normalizeCategory(categoryRaw);
  const question=document.getElementById('ad-question').value.trim();
  const lines=document.getElementById('ad-options').value.split('\n').map(s=>s.trim()).filter(Boolean);
  if(!category || !question || lines.length<2) return alert('Bitte Kategorie, Frage und mind. 2 Antworten angeben. Markiere die richtige mit *** am Anfang.');
  const options=[], correctIndexRaw=lines.findIndex(l=>l.startsWith('***'));
  lines.forEach(l=>options.push(l.replace(/^\*{3}\s?/,'')));
  const correct_index = correctIndexRaw>=0 ? correctIndexRaw : 0;
  const explanation=document.getElementById('ad-expl').value.trim();
  const obj={id,category,question,options,correct_index,explanation};
  const {error}=await supa.from('questions').upsert(obj,{onConflict:'id'});
  if(error) alert(error.message); else { alert('Gespeichert.'); renderAdminList(); await refreshSelectors(); await refreshTrainSelectors(); await refreshExamCategories(); }
};

/* ====== Empty DB Hinweis ====== */
async function showEmptyHints(){ const all=await fetchQuestions(); const hint=document.getElementById('login-empty-info'); if(!all.length){ hint.style.display='block'; hint.innerHTML='Noch keine Fragen in der Datenbank. Admin → Import nutzen.'; } else hint.style.display='none'; }

/* ====== PDF ====== */
async function generateExamPDF({ session, userEmail, logoUrlOrDataUri=null }) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "mm", format: "a4" });
  const left = 20, right = 190; let y = 20;
  const set=(size=11,bold=false,color=20)=>{doc.setFont("helvetica",bold?"bold":"normal");doc.setFontSize(size);doc.setTextColor(color)};
  const addY=h=>{y+=h;if(y>280){doc.addPage();y=20}}
  const hr=()=>{doc.setDrawColor(220);doc.line(left,y,right,y);addY(4)}
  const wrap=t=>doc.splitTextToSize(t||"", right-left)
  try{
    if (logoUrlOrDataUri){
      const img=await fetch(logoUrlOrDataUri).then(r=>r.blob()).then(b=>new Promise(res=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.readAsDataURL(b)}));
      doc.addImage(img,'PNG', right-20-16, 10, 16, 16);
    }
  }catch(e){}
  set(18,true); doc.text("Prüfungsergebnis – Lernapp Lagerlogistik", left, y); addY(10);
  const created=new Date().toLocaleString();
  set(10,true,120); doc.text("Erstellt:", left, y); set(12,false,20); doc.text(created, left, y+6);
  set(10,true,120); doc.text("Prüfling:", left+90, y); set(12,false,20); doc.text(`E‑Mail: ${userEmail||"-"}`, left+90, y+6); addY(16);
  hr();
  set(10,true,120); doc.text("Gesamt richtig:", left, y); set(12,false); doc.text(`${session.correct} / ${session.total}`, left, y+6);
  set(10,true,120); doc.text("Quote:", left+90, y); set(12,false); doc.text(`${session.total?Math.round(100*session.correct/session.total):0}%`, left+90, y+6); addY(16); hr();
  set(13,true); doc.text("Nach Kategorie:", left, y); addY(7);
  const byCat={}; (session.items||[]).forEach(it=>{const c=it.category||"–"; byCat[c]=byCat[c]||{total:0,correct:0}; byCat[c].total++; byCat[c].correct+=it.correct?1:0;});
  Object.entries(byCat).forEach(([c,s])=>{ const pct=s.total?Math.round(100*s.correct/s.total):0; set(12,false); doc.text(`• ${prettyCategory(c)}: ${s.correct}/${s.total} (${pct}%)`, left, y); addY(6); });
  addY(4); hr();
  set(13,true); doc.text("Einzelaufstellung (Fragen & Antworten)", left, y); addY(8);
  (session.items||[]).forEach((it, idx) => {
    set(12,true); doc.text(`${idx+1}. ${prettyCategory(it.category||'')}`, left, y); addY(6);
    wrap(it.question).forEach(row=>{ set(12,false); doc.text(row,left,y); addY(5); });
    set(10,true,120); doc.text("Deine Antwort:", left, y); addY(5);
    wrap(it.selectedText).forEach(row=>{ set(11,false); doc.text(row,left,y); addY(5); });
    set(10,true,120); doc.text("Richtige Lösung:", left, y); addY(5);
    wrap(it.correctText).forEach(row=>{ set(11,false); doc.text(row,left,y); addY(5); });
    if (it.explanation){ set(10,true,120); doc.text("Erklärung:", left, y); addY(5); wrap(it.explanation).forEach(row=>{ set(11,false); doc.text(row,left,y); addY(5); }); }
    set(11,true, it.correct?20:180); doc.text(`Bewertung: ${it.correct?'RICHTIG':'FALSCH'}`, left, y); addY(7); hr();
  });
  const stamp=new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  doc.save(`pruefungsbericht_${stamp}.pdf`);
}

/* ====== Boot ====== */
window.addEventListener('DOMContentLoaded', initClient);
</script>
</body>
</html>
