<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Lernapp Lagerlogistik</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- jsPDF (optional; bleibt drin für Prüfungs-PDFs) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{--line:rgba(255,255,255,.12);--text:#E5E7EB;--muted:#A7B0C3;--primary:#60A5FA;--panel:rgba(255,255,255,.06)}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:#0b1020;color:var(--text)}
    .topbar{position:sticky;top:0;display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--line);background:rgba(10,14,28,.85);backdrop-filter:blur(8px);z-index:5}
    .brand{display:flex;gap:10px;align-items:center}
    .brand .logo{height:36px;width:36px;border-radius:8px;background:conic-gradient(from 0deg,#60A5FA,#F59E0B,#60A5FA)}
    .nav{display:flex;gap:8px;flex-wrap:wrap}
    .nav button{background:transparent;color:var(--text);border:1px solid var(--line);padding:6px 10px;border-radius:10px;cursor:pointer}
    .container{max-width:1000px;margin:0 auto;padding:20px}
    .view{display:none}.view.active{display:block}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
    .cards{display:grid;gap:14px}
    .card{border:1px solid var(--line);border-radius:12px;padding:12px;background:rgba(255,255,255,.04)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select,textarea{background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line);border-radius:10px;padding:8px 10px}
    .btn{border-radius:10px;padding:8px 12px;cursor:pointer;border:1px solid var(--line);background:transparent;color:var(--text)}
    .btn.primary{background:#2563EB;border-color:#2563EB;color:#fff}
    .chip{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04)}
    .option{display:grid;grid-template-columns:18px 1fr;gap:8px;padding:8px;border:1px solid var(--line);border-radius:8px;background:rgba(255,255,255,.02);cursor:pointer}
    .option.selected{outline:2px solid var(--primary);background:rgba(96,165,250,.10)}
    .muted{color:var(--muted)}

    /* Modal (Einstellungen) */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:20}
    .modal.show{display:flex}
    .modal .backdrop{position:absolute;inset:0;background:#0b1020e6;backdrop-filter:blur(6px)}
    .modal .box{position:relative;width:min(980px,calc(100% - 32px));max-height:90vh;overflow:auto;background:#0f1427;border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 22px 70px rgba(0,0,0,.55)}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo" id="brand-logo"></div>
      <div>
        <b>Lernapp Lagerlogistik</b>
        <div style="font-size:12px;color:var(--muted)">Supabase • Login • Cloud</div>
      </div>
    </div>
    <div class="nav">
      <button data-view="login">Login</button>
      <button data-view="flashcards">Lernkarten</button>
      <button data-view="train">Adaptiv</button>
      <button data-view="exam">Prüfung</button>
      <button data-view="progress">Fortschritt</button>
      <button data-view="admin">Admin</button>
      <button id="btn-settings">Einstellungen</button>
    </div>
  </header>

  <div class="container">
    <!-- Einstellungen -->
    <div id="settings-modal" class="modal">
      <div class="backdrop"></div>
      <div class="box">
        <h3>Supabase & Branding</h3>
        <div class="row">
          <label style="flex:1">Project URL<br/><input id="cfg-url" /></label>
          <label style="flex:1">Anon public key<br/><input id="cfg-key" /></label>
        </div>
        <label>Logo URL / Data‑URI<br/><input id="cfg-logo" placeholder="https://... oder data:image/png;base64,..."/></label>
        <div class="row" style="margin-top:8px">
          <button id="cfg-save" class="btn primary">Speichern</button>
          <button id="cfg-close" class="btn">Schließen</button>
          <span id="cfg-state" class="muted"></span>
        </div>
      </div>
    </div>

    <!-- Login -->
    <section id="view-login" class="view active">
      <div class="panel">
        <h3>Anmelden</h3>
        <div class="row">
          <input id="email" type="email" placeholder="dein.name@example.com"/>
          <input id="password" type="password" placeholder="••••••••"/>
          <button id="btn-signup" class="btn">Registrieren</button>
          <button id="btn-login" class="btn primary">Einloggen</button>
          <button id="btn-logout" class="btn" disabled>Abmelden</button>
          <span id="auth-state" class="muted"></span>
        </div>
        <div id="login-empty-info" class="card" style="display:none;margin-top:10px"></div>
      </div>
    </section>

    <!-- Lernkarten -->
    <section id="view-flashcards" class="view">
      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <h3>Lernkarten</h3>
          <div class="row">
            <select id="fc-category"></select>
            <button id="fc-load" class="btn primary">Laden</button>
            <span id="fc-stats" class="muted"></span>
          </div>
        </div>
        <div id="fc-area" class="cards"></div>
        <div id="fc-empty" class="card" style="display:none;margin-top:10px"></div>
      </div>
    </section>

    <!-- Adaptives Training -->
    <section id="view-train" class="view">
      <div class="panel">
        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <div>
            <h3>Adaptiv trainieren</h3>
            <div class="muted" style="max-width:720px">
              Wiederholt Fragen mit niedriger Quote häufiger. Ab 3× korrekt in Folge → „gelernt“ (Cooldown).
            </div>
          </div>
          <div class="row">
            <select id="train-category"><option value="">Alle Kategorien</option></select>
            <label class="row"><input type="checkbox" id="train-weak"/> <span>Nur Schwächen</span></label>
            <label class="row"><input type="checkbox" id="train-hide-learned" checked/> <span>Gelernt ausblenden</span></label>
            <button id="train-next" class="btn primary">Nächste Karte</button>
          </div>
        </div>
        <div id="train-area" class="cards" style="margin-top:10px"></div>
        <div id="train-empty" class="card" style="display:none;margin-top:10px"></div>
      </div>
    </section>

    <!-- Prüfung -->
    <section id="view-exam" class="view">
      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <h3>Prüfungssimulation</h3>
          <div class="row">
            <select id="exam-categories" multiple></select>
            <input id="exam-count" type="number" value="40" min="5" max="100" style="width:90px"/>
            <input id="exam-minutes" type="number" value="60" min="5" max="180" style="width:90px"/>
            <button id="exam-start" class="btn primary">Start</button>
          </div>
        </div>
        <div id="exam-meta" class="muted" style="margin:8px 0"></div>
        <div id="exam-area" class="cards"></div>
      </div>
    </section>

    <!-- Fortschritt -->
    <section id="view-progress" class="view">
      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <h3>Dein Fortschritt</h3>
          <button id="reset-progress" class="btn">Lokalen Fortschritt zurücksetzen</button>
        </div>
        <div id="progress-summary" class="cards"></div>
      </div>
    </section>

    <!-- Admin -->
    <section id="view-admin" class="view">
      <div class="panel">
        <h3>Admin</h3>

        <div class="card">
          <h4>Export / Import</h4>
          <div class="row">
            <button id="admin-export" class="btn">Export JSON</button>
            <input type="file" id="admin-import" accept="application/json" multiple/>
          </div>
        </div>

        <div class="card">
          <h4>Kategorie verwalten</h4>
          <div class="row">
            <select id="admin-cat-old"></select>
            <input id="admin-cat-new" placeholder="Neue Kategorie (umbenennen/zusammenführen)"/>
            <button id="admin-cat-apply" class="btn primary">Anwenden</button>
            <span id="admin-cat-state" class="muted"></span>
          </div>
        </div>

        <div class="card">
          <h4>Duplikate scannen</h4>
          <div class="row">
            <button id="admin-scan-dup" class="btn">Scan starten</button>
            <span class="muted">Scannt gleiche <b>ID</b> oder gleiche <b>Fragentexte</b>.</span>
          </div>
          <div id="admin-dup-list" class="cards" style="margin-top:10px"></div>
        </div>

        <div class="card">
          <h4>Kategorien zusammenführen (ohne SQL)</h4>
          <div class="row">
            <button id="admin-merge-cats" class="btn">Zusammenführen starten</button>
            <span id="admin-merge-state" class="muted"></span>
          </div>
          <div class="muted">Führt Schreibweisen zusammen (z. B. „LL01/1 …“ vs „ll01/1 …“, unterschiedliche Bindestriche/Spaces).</div>
        </div>

        <form id="admin-form" onsubmit="return false;" class="card">
          <h4>Neue Frage</h4>
          <input id="ad-category" placeholder="z.B. LL01/2 – Güter kontrollieren" required/>
          <textarea id="ad-question" rows="2" placeholder="Frage" required></textarea>
          <textarea id="ad-options" rows="4" placeholder="***Korrekt
Falsch 1
Falsch 2" required></textarea>
          <textarea id="ad-expl" rows="2" placeholder="Erklärung (optional)"></textarea>
          <div class="row"><button id="admin-save" class="btn primary">Speichern (DB)</button></div>
        </form>

        <div id="admin-list" class="cards"></div>
      </div>
    </section>
  </div>

<script>
/* ====== Basis-Konstanten (Default-Konfig) ====== */
const KEY_URL='supabase_url', KEY_ANON='supabase_anon', KEY_LOGO='app_logo_url';
// Optional: Defaults eintragen, damit neue User nichts tippen müssen:
const DEFAULT_URL  = localStorage.getItem(KEY_URL)  || '';
const DEFAULT_ANON = localStorage.getItem(KEY_ANON) || '';
const DEFAULT_LOGO = localStorage.getItem(KEY_LOGO) || 'https://ebqfupcivmkbuadbbnwg.supabase.co/storage/v1/object/public/app-assets/logo.png';

let supa=null;

/* ====== Branding ====== */
function applyBranding(){
  try{
    const el = document.getElementById('brand-logo');
    const logo = localStorage.getItem(KEY_LOGO) || DEFAULT_LOGO;
    if(el && logo){
      el.style.background='none';
      el.style.backgroundImage=`url(${logo})`;
      el.style.backgroundSize='cover';
      el.style.backgroundPosition='center';
      el.style.border='1px solid var(--line)';
    }
  }catch{}
}

/* ====== Navigation ====== */
const views=['login','flashcards','train','exam','progress','admin'];
document.querySelectorAll('.nav button[data-view]').forEach(b=>b.onclick=()=>views.forEach(v=>document.getElementById('view-'+v).classList.toggle('active',v===b.dataset.view)));

/* ====== Einstellungen ====== */
document.getElementById('btn-settings').onclick=()=>{
  const m=document.getElementById('settings-modal');
  document.getElementById('cfg-url').value=localStorage.getItem(KEY_URL)||DEFAULT_URL;
  document.getElementById('cfg-key').value=localStorage.getItem(KEY_ANON)||DEFAULT_ANON;
  document.getElementById('cfg-logo').value=localStorage.getItem(KEY_LOGO)||DEFAULT_LOGO;
  m.classList.add('show');
};
document.getElementById('cfg-close').onclick=()=>document.getElementById('settings-modal').classList.remove('show');
document.getElementById('cfg-save').onclick=()=>{
  const url=document.getElementById('cfg-url').value.trim();
  const anon=document.getElementById('cfg-key').value.trim();
  const logo=document.getElementById('cfg-logo').value.trim();
  if(url) localStorage.setItem(KEY_URL,url);
  if(anon) localStorage.setItem(KEY_ANON,anon);
  if(logo) localStorage.setItem(KEY_LOGO,logo);
  document.getElementById('cfg-state').textContent='Gespeichert. Seite lädt neu…';
  setTimeout(()=>location.reload(),400);
};

/* ====== Supabase Init ====== */
async function initClient(){
  const url = localStorage.getItem(KEY_URL)  || DEFAULT_URL;
  const anon= localStorage.getItem(KEY_ANON) || DEFAULT_ANON;
  if(!url || !anon){
    const hint=document.getElementById('login-empty-info');
    hint.style.display='block';
    hint.textContent='Bitte unter Einstellungen Project URL & Anon Key eintragen.';
    applyBranding();
    return;
  }
  supa = supabase.createClient(url, anon);
  applyBranding();
  renderProgress();
  refreshAuthUI();
  await refreshSelectors();
  await refreshTrainSelectors();
  await refreshExamCategories();
  await renderAdminList();
  await fillAdminCatSelect();
  await showEmptyHints();
}

/* ====== Normalisierung für Kategorien (Kern der Duplikat-Lösung) ====== */
function normalizeCategoryName(s){
  if(!s) return '';
  return String(s)
    .replace(/[\u2010-\u2015\u2212\-]+/g,'-') // verschiedene Gedankenstriche → "-"
    .replace(/\s+/g,' ')
    .trim()
    .toLowerCase();
}

/* ====== Auth ====== */
const email=document.getElementById('email'), password=document.getElementById('password');
const btnSignup=document.getElementById('btn-signup'), btnLogin=document.getElementById('btn-login'), btnLogout=document.getElementById('btn-logout');
const authState=document.getElementById('auth-state');

async function refreshAuthUI(){
  if(!supa) return;
  const {data:{user}}=await supa.auth.getUser();
  if(user){btnLogout.disabled=false;btnLogin.disabled=true;btnSignup.disabled=true;authState.textContent=`Eingeloggt: ${user.email}`;}
  else {btnLogout.disabled=true;btnLogin.disabled=false;btnSignup.disabled=false;authState.textContent='Nicht eingeloggt';}
}
btnSignup.onclick=async()=>{const {error}=await supa.auth.signUp({email:email.value,password:password.value}); if(error) alert(error.message); else alert('Registriert. Prüfe dein Postfach.'); refreshAuthUI();};
btnLogin.onclick=async()=>{const {error}=await supa.auth.signInWithPassword({email:email.value,password:password.value}); if(error) alert(error.message); await refreshAuthUI();};
btnLogout.onclick=async()=>{await supa.auth.signOut(); await refreshAuthUI();};

/* ====== Daten-Helper ====== */
async function fetchQuestions(){
  if(!supa) return [];
  const {data,error}=await supa.from('questions').select('*').order('category',{ascending:true});
  if(error){console.warn(error.message); return [];}
  return data||[];
}

/* => WICHTIG: deduplizierte Kategorien */
async function fetchCategories(){
  const q = await fetchQuestions();
  const seen = new Map();
  for(const it of q){
    const raw = it.category || '';
    const key = normalizeCategoryName(raw);
    if(!seen.has(key)) seen.set(key, raw); // "schönste" Schreibweise bewahren
  }
  return Array.from(seen.values()).sort((a,b)=>a.localeCompare(b,'de'));
}

/* ====== Lernkarten ====== */
const fcCategory=document.getElementById('fc-category'), fcArea=document.getElementById('fc-area'), fcStats=document.getElementById('fc-stats'), fcEmpty=document.getElementById('fc-empty');
document.getElementById('fc-load').onclick=loadFlashcards;
async function refreshSelectors(){ const cats=await fetchCategories(); fcCategory.innerHTML=cats.map(c=>`<option>${c}</option>`).join(''); }
async function loadFlashcards(){
  const all=await fetchQuestions(); const cat=fcCategory.value; const cards=all.filter(x=>x.category===cat);
  fcArea.innerHTML=''; if(cards.length===0){ fcEmpty.style.display='block'; fcEmpty.textContent='Keine Fragen in dieser Kategorie.'; fcStats.textContent='0 Karten'; return;} else fcEmpty.style.display='none';
  let n=0; cards.forEach(card=>{
    const wrap=document.createElement('div'); wrap.className='card';
    const opts = (card.options||[]).map((t,i)=>({text:t,correct:i===card.correct_index}));
    wrap.innerHTML=`<div class="row" style="justify-content:space-between"><div><span class="chip">${card.category}</span></div><div class="muted">ID: ${card.id}</div></div>
      <div><b>${card.question||card.question_text||''}</b></div><div class="options"></div><div class="reveal" style="display:none;margin-top:8px"></div>`;
    const box=wrap.querySelector('.options');
    opts.forEach((o,i)=>{
      const d=document.createElement('div'); d.className='option'; d.innerHTML=`<input type="radio"/> <span>${o.text}</span>`;
      d.onclick=async()=>{
        [...box.children].forEach(c=>c.classList.remove('selected')); d.classList.add('selected');
        const ok=(i===opts.findIndex(z=>z.correct));
        const reveal=wrap.querySelector('.reveal'); reveal.style.display='block';
        reveal.textContent = ok? '✅ Richtig!' : `❌ Falsch. Richtig: ${opts.find(o=>o.correct)?.text||''}`;
        bumpProgress(1, ok?1:0);
        const {data:{user}}=await supa.auth.getUser(); if(user) await supa.from('reviews').insert({user_id:user.id,question_id:card.id,correct:ok});
      };
      box.appendChild(d);
    });
    fcArea.appendChild(wrap); n++;
  }); fcStats.textContent=`${n} Karten`;
}

/* ====== Adaptives Training ====== */
const trCategory=document.getElementById('train-category'), trWeak=document.getElementById('train-weak'), trHideLearned=document.getElementById('train-hide-learned');
const trNext=document.getElementById('train-next'), trArea=document.getElementById('train-area'), trEmpty=document.getElementById('train-empty');

async function refreshTrainSelectors(){ const cats=await fetchCategories(); trCategory.innerHTML='<option value="">Alle Kategorien</option>'+cats.map(c=>`<option>${c}</option>`).join(''); }

async function getUser(){ try{ const {data:{user}}=await supa.auth.getUser(); return user||null; }catch{return null;} }

function cooldownDaysForStreak(s){ if(s>=5) return 14; if(s>=4) return 7; if(s>=3) return 3; if(s>=2) return 1; return 0; }
function isInCooldown(entry){
  if(!entry||!entry.lastTs) return false;
  const d=cooldownDaysForStreak(entry.streak||0); if(d<=0) return false;
  const next=new Date(entry.lastTs); next.setDate(next.getDate()+d);
  return (new Date()<next);
}
async function fetchStatsMap(userId){
  const map={}; if(!userId) return map;
  const { data } = await supa.from('reviews').select('question_id,ts,correct').eq('user_id',userId).order('ts',{ascending:true});
  (data||[]).forEach(r=>{
    const m = map[r.question_id] ||= {seen:0,correct:0,streak:0,last:false,lastTs:null};
    m.seen++; if(r.correct){ m.correct++; m.streak=(m.last===true)?(m.streak+1):1; } else { m.streak=0; }
    m.last=r.correct; m.lastTs=r.ts;
  }); return map;
}
async function pickAdaptiveCard(categoryFilter, onlyWeak, hideLearned){
  const all=await fetchQuestions();
  const user=await getUser();
  const stats = await fetchStatsMap(user?.id);
  let pool = all.filter(q=>!categoryFilter || q.category===categoryFilter).map(q=>{
    const s=stats[q.id]||{seen:0,correct:0,streak:0,last:false,lastTs:null};
    const acc = s.seen ? s.correct/s.seen : 0;
    const wrongBias = (s.last===false)?0.2:0;
    const seenPenalty = Math.min(s.seen*0.02,0.2);
    const learned=(s.streak||0)>=3;
    const cooldown=isInCooldown(s);
    let weight=(1-acc)+wrongBias-seenPenalty;
    if(learned && hideLearned) weight-=1.5;
    if(cooldown) weight-=0.8;
    return {q,s,acc,learned,cooldown,weight};
  });
  if(onlyWeak) pool=pool.filter(x=>(x.acc<0.7)||(x.s.last===false));
  pool=pool.filter(x=>x.weight>-0.3);
  if(!pool.length) return null;
  const minW=Math.min(...pool.map(x=>x.weight));
  const norm=pool.map(p=>({...p,w:p.weight-minW+0.001}));
  const sum=norm.reduce((a,b)=>a+b.w,0);
  let r=Math.random()*sum; for(const p of norm){ r-=p.w; if(r<=0) return p.q; }
  return norm[norm.length-1].q;
}
function renderTrainCard(card){
  trArea.innerHTML='';
  if(!card){ trEmpty.style.display='block'; trEmpty.textContent='Keine geeignete Karte gefunden.'; return; }
  trEmpty.style.display='none';
  const opts=(card.options||[]).map((t,i)=>({text:t,correct:i===card.correct_index}));
  const wrap=document.createElement('div'); wrap.className='card';
  wrap.innerHTML=`<div class="row" style="justify-content:space-between"><div><span class="chip">${card.category}</span></div><div class="muted">ID: ${card.id}</div></div>
    <div style="margin-top:6px"><b>${card.question||card.question_text||''}</b></div>
    <div class="options" style="margin-top:6px"></div><div class="reveal" style="display:none;margin-top:8px"></div>`;
  const box=wrap.querySelector('.options');
  opts.forEach((o,i)=>{
    const d=document.createElement('div'); d.className='option'; d.innerHTML=`<input type="radio"/> <span>${o.text}</span>`;
    d.onclick=async()=>{
      [...box.children].forEach(c=>c.classList.remove('selected')); d.classList.add('selected');
      const ok=(i===opts.findIndex(z=>z.correct));
      const rev=wrap.querySelector('.reveal'); rev.style.display='block';
      rev.textContent = ok? '✅ Richtig!' : `❌ Falsch. Richtig: ${opts.find(o=>o.correct)?.text||''}`;
      bumpProgress(1, ok?1:0);
      const {data:{user}}=await supa.auth.getUser(); if(user) await supa.from('reviews').insert({user_id:user.id,question_id:card.id,correct:ok});
    };
    box.appendChild(d);
  });
  trArea.appendChild(wrap);
}
trNext.onclick=async()=>{ const card=await pickAdaptiveCard(trCategory.value||null, trWeak.checked, trHideLearned.checked); renderTrainCard(card); };

/* ====== Prüfung (vereinfachte Version ohne PDF-Auto) ====== */
const examCategories=document.getElementById('exam-categories'), examCount=document.getElementById('exam-count'), examMinutes=document.getElementById('exam-minutes');
const examStart=document.getElementById('exam-start'), examArea=document.getElementById('exam-area'), examMeta=document.getElementById('exam-meta');

function shuffle(a){const b=a.slice();for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]];}return b;}
function pickN(a,n){const b=shuffle(a); return b.slice(0,Math.max(0,Math.min(n,b.length)));}

async function refreshExamCategories(){ const cats=await fetchCategories(); examCategories.innerHTML=cats.map(c=>`<option value="${c}" selected>${c}</option>`).join(''); }

examStart.onclick=async()=>{
  const all=await fetchQuestions(); const chosen=[...examCategories.selectedOptions].map(o=>o.value);
  const pool=all.filter(q=>chosen.includes(q.category)); if(!pool.length) return alert('Keine Fragen in den gewählten Kategorien.');
  const n=Math.max(5,Math.min(Number(examCount.value||40),100));
  const sel=pickN(pool,n); examArea.innerHTML='';
  sel.forEach((q,i)=>{
    const el=document.createElement('div'); el.className='card';
    const opts=(q.options||[]).map((t,idx)=>({text:t,correct:idx===q.correct_index}));
    el.innerHTML=`<div class="row" style="justify-content:space-between"><div><span class="chip">${q.category}</span></div><div class="muted">Frage ${i+1}/${n}</div></div>
      <div style="margin-top:4px"><b>${q.question||q.question_text||''}</b></div><div class="options"></div>`;
    const box=el.querySelector('.options');
    opts.forEach((o,idx)=>{ const d=document.createElement('label'); d.className='option';
      d.innerHTML=`<input type="radio" name="q_${q.id}"/> <span>${o.text}</span>`; box.appendChild(d); });
    examArea.appendChild(el);
  });
  examMeta.textContent = `Fragen: ${n}`;
};

/* ====== Fortschritt (lokal) ====== */
function bumpProgress(seenDelta, correctDelta){
  const p = JSON.parse(localStorage.getItem('progress_local') || '{"seen":0,"correct":0}');
  p.seen += seenDelta; p.correct += correctDelta;
  localStorage.setItem('progress_local', JSON.stringify(p));
  renderProgress();
}
function renderProgress(){
  const p = JSON.parse(localStorage.getItem('progress_local') || '{"seen":0,"correct":0}');
  const acc = p.seen ? Math.round(p.correct/p.seen*100) : 0;
  document.getElementById('progress-summary').innerHTML =
    `<div class="card"><b>Letzte Sitzung</b><div>Beantwortet: <b>${p.seen}</b> • Richtig: <b>${p.correct}</b> • Quote: <b>${acc}%</b></div></div>`;
}
document.getElementById('reset-progress').onclick=()=>{localStorage.removeItem('progress_local'); renderProgress();};

/* ====== Admin (Export/Import/Listen) ====== */
const adminList=document.getElementById('admin-list');
async function renderAdminList(){ const q=await fetchQuestions();
  adminList.innerHTML=q.map(x=>`<div class="card"><div class="row" style="justify-content:space-between">
  <div><span class="chip">${x.category}</span></div><button data-del="${x.id}" class="btn">Löschen</button></div>
  <div><b>${x.question||x.question_text||''}</b></div></div>`).join('');
  adminList.querySelectorAll('button[data-del]').forEach(btn=>btn.onclick=async()=>{
    const id=btn.getAttribute('data-del'); const {error}=await supa.from('questions').delete().eq('id',id);
    if(error) alert(error.message); else renderAdminList();
  });
}
document.getElementById('admin-export').onclick=async()=>{
  const q=await fetchQuestions();
  const blob=new Blob([JSON.stringify(q,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='fragen_export_supabase.json'; a.click(); URL.revokeObjectURL(url);
};
document.getElementById('admin-import').onchange=async(e)=>{
  const files=[...(e.target.files||[])]; if(!files.length) return;
  const allItems=[];
  for(const f of files){ try{ const text=await f.text(); const arr=JSON.parse(text); if(Array.isArray(arr)) allItems.push(...arr); else if(arr && typeof arr==='object') allItems.push(arr); }catch(err){ alert(`Fehler in ${f.name}: ${err.message}`); } }
  if(!allItems.length){ alert('Keine gültigen Fragen gefunden.'); return; }
  // Minimal-Validierung
  const cleaned = allItems.filter(x=>x && x.id && Array.isArray(x.options) && (x.question || x.question_text) != null);
  let ok=0, fail=0;
  for(const item of cleaned){ const {error}=await supa.from('questions').upsert(item,{onConflict:'id'}); if(error) fail++; else ok++; }
  alert(`Import fertig. Erfolgreich: ${ok} • Fehler: ${fail}`);
  await renderAdminList(); await refreshSelectors(); await refreshTrainSelectors(); await refreshExamCategories();
};

/* Kategorie-Tools */
async function fillAdminCatSelect(){ const cats=await fetchCategories(); document.getElementById('admin-cat-old').innerHTML=cats.map(c=>`<option>${c}</option>`).join(''); }
document.getElementById('admin-cat-apply').onclick=async()=>{
  const oldVal=document.getElementById('admin-cat-old').value;
  const newVal=(document.getElementById('admin-cat-new').value||'').trim();
  if(!oldVal||!newVal) return alert('Bitte alte & neue Kategorie befüllen.');
  const { error, count } = await supa.from('questions').update({category:newVal}).eq('category',oldVal).select('id',{count:'exact'});
  document.getElementById('admin-cat-state').textContent = error? ('Fehler: '+error.message) : (`Geändert: ${count||0}`);
  await renderAdminList(); await fillAdminCatSelect(); await refreshSelectors(); await refreshTrainSelectors(); await refreshExamCategories();
};
document.getElementById('admin-scan-dup').onclick=async()=>{
  const list=document.getElementById('admin-dup-list'); list.innerHTML='Suche…';
  const q=await fetchQuestions(); if(!q.length){ list.innerHTML='<div class="card muted">Keine Fragen.</div>'; return; }
  const byText={}; q.forEach(it=>{ const key=(it.question||it.question_text||'').trim().toLowerCase(); (byText[key] ||= []).push(it); });
  const groups=Object.values(byText).filter(arr=>arr.length>1);
  if(!groups.length){ list.innerHTML='<div class="card">Keine Duplikate per Fragentext.</div>'; return; }
  list.innerHTML = groups.map(arr=>{
    const head=(arr[0].question||arr[0].question_text||'').slice(0,120);
    const rows=arr.map(x=>`<div class="row" style="justify-content:space-between"><div><span class="chip">${x.category}</span></div><div class="muted">${x.id}</div></div>`).join('');
    return `<div class="card"><div><b>${head}</b></div>${rows}</div>`;
  }).join('');
};

/* ====== NEU: Kategorien zusammenführen (ohne SQL) ====== */
document.getElementById('admin-merge-cats').onclick = adminMergeDuplicateCategories;

async function adminMergeDuplicateCategories(){
  const state=document.getElementById('admin-merge-state');
  try{
    state.textContent='Analysiere…';
    const all = await fetchQuestions();
    if(!all.length){ state.textContent='Keine Fragen gefunden.'; return; }

    // 1) Kanon je Normalform bestimmen (erste gefundene Schreibweise)
    const canonicalByKey = new Map();
    for(const q of all){
      const raw=q.category||'';
      const key=normalizeCategoryName(raw);
      if(!canonicalByKey.has(key)) canonicalByKey.set(key, raw);
    }

    // 2) Updates sammeln
    const updates=[];
    for(const q of all){
      const raw=q.category||'';
      const key=normalizeCategoryName(raw);
      const canon=canonicalByKey.get(key)||raw;
      if(raw!==canon) updates.push({ id:q.id, category:canon });
    }
    if(!updates.length){ state.textContent='Nichts zu tun – alles einheitlich.'; return; }

    state.textContent=`Führe zusammen… (${updates.length} Updates)`;

    // 3) In Batches updaten
    const BATCH=150; let ok=0, fail=0;
    for(let i=0;i<updates.length;i+=BATCH){
      const slice=updates.slice(i,i+BATCH);
      await Promise.all(slice.map(async u=>{
        const {error}=await supa.from('questions').update({category:u.category}).eq('id',u.id);
        if(error) fail++; else ok++;
      }));
      state.textContent=`Aktualisiert: ${ok} • Fehler: ${fail}`;
    }
    state.textContent=`Fertig. Erfolgreich: ${ok} • Fehler: ${fail}`;

    // UI neu laden
    await renderAdminList(); await fillAdminCatSelect(); await refreshSelectors(); await refreshTrainSelectors(); await refreshExamCategories();
  }catch(e){
    console.error(e);
    state.textContent='Fehler: '+(e?.message||e);
  }
}

/* ====== Hinweis: leere DB ====== */
async function showEmptyHints(){
  const all=await fetchQuestions();
  const hint=document.getElementById('login-empty-info');
  if(!all.length){ hint.style.display='block'; hint.innerHTML='Noch keine Fragen in der Datenbank. Admin → Import nutzen.'; }
  else hint.style.display='none';
}

/* ====== Boot ====== */
window.addEventListener('DOMContentLoaded', initClient);
</script>
</body>
</html>
