<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Lernapp Lagerlogistik</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- jsPDF für den PDF-Export -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --line:rgba(255,255,255,.12);
      --text:#E5E7EB; --muted:#A7B0C3; --primary:#60A5FA; --panel:rgba(255,255,255,.06);
      --bg:#0b1020; --bg-2:#0f1427; --ok:#22c55e; --mid:#eab308; --low:#ef4444;
      --panel-strong:#111735; --panel-contrast:#0e1430;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg),var(--panel-contrast) 60%, var(--bg));color:var(--text)}
    .topbar{position:sticky;top:0;display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--line);background:rgba(10,14,28,.85);backdrop-filter:blur(8px);z-index:5}
    .brand{display:flex;gap:10px;align-items:center}
    .brand .logo{height:36px;width:36px;border-radius:8px;background:conic-gradient(from 0deg,#60A5FA,#F59E0B,#60A5FA)}
    .nav{display:flex;gap:8px;flex-wrap:wrap}
    .nav button{background:transparent;color:var(--text);border:1px solid var(--line);padding:6px 10px;border-radius:10px;cursor:pointer}
    .nav button.active{outline:2px solid var(--primary)}
    .nav button[hidden]{display:none !important}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    .view{display:none}.view.active{display:block}
    .panel{background:linear-gradient(180deg, var(--panel), var(--panel-strong));border:1px solid var(--line);border-radius:12px;padding:14px}
    .cards{display:grid;gap:14px}
    .card{border:1px solid var(--line);border-radius:12px;padding:12px;background:rgba(255,255,255,.04)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select,textarea{background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line);border-radius:10px;padding:8px 10px}
    input::placeholder, textarea::placeholder{color:#98a2b3}
    .btn{border-radius:10px;padding:8px 12px;cursor:pointer;border:1px solid var(--line);background:transparent;color:var(--text)}
    .btn.primary{background:#2563EB;border-color:#2563EB;color:#fff}
    .btn.ghost{background:rgba(255,255,255,.04)}
    .chip{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04)}
    .option{display:grid;grid-template-columns:18px 1fr;gap:8px;padding:8px;border:1px solid var(--line);border-radius:8px;background:rgba(255,255,255,.02);cursor:pointer}
    .option.selected{outline:2px solid var(--primary);background:rgba(96,165,250,.10)}
    .muted{color:var(--muted)}
    .alert{border:1px dashed var(--line);background:rgba(255,255,255,.03);padding:10px;border-radius:10px}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:20}
    .modal.show{display:flex}
    .modal .backdrop{position:absolute;inset:0;background:#0b1020e6;backdrop-filter:blur(6px)}
    .modal .box{position:relative;width:min(980px,calc(100% - 32px));max-height:90vh;overflow:auto;background:var(--bg-2);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 22px 70px rgba(0,0,0,.55)}

    .stat-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin:8px 0 10px}
    .stat{border:1px solid var(--line);border-radius:10px;padding:10px;background:rgba(255,255,255,.03)}
    .stat .val{font-size:22px;font-weight:800;margin-top:4px}

    /* Sticky-Abgeben-Button (IHK-Modus) */
    #exam-submit-sticky{
      position: fixed; right: 20px; bottom: 20px;
      padding: 12px 18px; border-radius: 12px;
      border: 1px solid var(--line);
      background: #2563EB; color: #fff; font-weight: 600;
      cursor: pointer; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    #exam-submit-sticky[disabled]{ opacity:.6; cursor:not-allowed; }

    /* Fortschritt-Balken */
    .progress-row{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:8px 0;border-bottom:1px dashed var(--line)}
    .progress-meta{min-width:170px}
    .progress-bar{flex:1;height:10px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;border:1px solid var(--line)}
    .progress-fill{height:100%;width:0%}
    .progress-fill.ok{background:var(--ok)}
    .progress-fill.mid{background:var(--mid)}
    .progress-fill.low{background:var(--low)}
    .progress-pill{font-size:12px;border:1px solid var(--line);border-radius:999px;padding:2px 8px;background:rgba(255,255,255,.04)}

    /* Selects besser lesbar */
    select{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.18)}
    option{background:#0f1427;color:#E5E7EB}

    /* Fachrechnen – Eingabeprüfung & Notes */
    .calc-ok{ color:#22c55e; font-weight:700; }
    .calc-bad{ color:#ef4444; font-weight:700; }
    #calc-answer.valid{ outline:2px solid #22c55e; }
    #calc-answer.invalid{ outline:2px solid #ef4444; }
    .notes-box{display:grid; grid-template-columns:1fr auto; gap:8px; align-items:start}
    .notes-area{min-height:100px}

    /* === Simulationen (UI) === */
    .sim-wrap{display:grid;gap:12px}
    .sim-header{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;justify-content:space-between}
    .sim-area{display:grid;grid-template-columns:1fr;gap:12px}
    .sim-pool,.sim-queue{border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.04);padding:10px}
    .sim-title{font-weight:700;margin-bottom:6px}
    .step{display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:10px;padding:8px;background:rgba(255,255,255,.03);cursor:pointer}
    .step[disabled]{opacity:.55;cursor:not-allowed}
    .step.correct{outline:2px solid var(--ok);background:rgba(34,197,94,.12)}
    .step.wrong{outline:2px solid var(--low);background:rgba(239,68,68,.12)}
    .queue-chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;margin:4px;background:rgba(255,255,255,.05)}
    .badge{font-size:12px;border:1px solid var(--line);border-radius:999px;padding:2px 8px;background:rgba(255,255,255,.04)}
    .score{font-weight:800}
    .hint{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo" id="brand-logo"></div>
      <div>
        <b>Lernapp Lagerlogistik</b>
        <div style="font-size:12px;color:var(--muted)">Supabase • Login • Cloud</div>
      </div>
    </div>
    <div class="nav">
      <button data-view="login" id="nav-login" class="active">Login</button>
      <button data-view="flashcards" id="nav-flash" hidden>Lernkarten</button>
      <button data-view="train" id="nav-train" hidden>Adaptiv</button>
      <button data-view="exam" id="nav-exam" hidden>Prüfung</button>
      <button data-view="progress" id="nav-progress" hidden>Fortschritt</button>
      <button data-view="calc" id="nav-calc" hidden>Fachrechnen</button>
      <button data-view="sim" id="nav-sim" hidden>Simulationen</button>
      <button data-view="admin" id="nav-admin" hidden>Admin</button>
      <button id="btn-settings" hidden>Einstellungen</button>
    </div>
  </header>

  <div class="container">
    <!-- Einstellungen -->
    <div id="settings-modal" class="modal">
      <div class="backdrop"></div>
      <div class="box">
        <h3>Supabase & Branding</h3>
        <div class="row">
          <label style="flex:1">Project URL<br/><input id="cfg-url" /></label>
          <label style="flex:1">Anon public key<br/><input id="cfg-key" /></label>
        </div>
        <label>Logo URL / Data‑URI<br/><input id="cfg-logo" placeholder="https://... oder data:image/png;base64,..."/></label>
        <div class="row" style="margin-top:8px">
          <button id="cfg-save" class="btn primary">Speichern</button>
          <button id="cfg-close" class="btn">Schließen</button>
          <span id="cfg-state" class="muted"></span>
        </div>
      </div>
    </div>

    <!-- Ergebnis-Modal -->
    <div id="result-modal" class="modal">
      <div class="backdrop"></div>
      <div class="box">
        <h3>Prüfungsergebnis</h3>
        <div class="stat-grid">
          <div class="stat"><div>Gesamt richtig</div><div class="val" id="res-total">–</div></div>
          <div class="stat"><div>Quote</div><div class="val" id="res-quote">–</div></div>
          <div class="stat"><div>Erstellt</div><div class="val" id="res-date">–</div></div>
        </div>
        <div class="card"><div style="font-weight:700;margin-bottom:6px">Nach Kategorie</div><div id="res-cats"></div></div>
        <div class="cards" id="res-items" style="margin-top:10px"></div>
        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <button id="res-new" class="btn">Neue Prüfung</button>
          <button id="res-close" class="btn">Schließen</button>
          <button id="result-pdf" class="btn primary">PDF herunterladen</button>
        </div>
      </div>
    </div>

    <!-- Login -->
    <section id="view-login" class="view active">
      <div class="panel">
        <h3>Anmelden</h3>
        <div class="row">
          <input id="email" type="email" placeholder="dein.name@example.com"/>
          <input id="password" type="password" placeholder="••••••••"/>
          <button id="btn-signup" class="btn">Registrieren</button>
          <button id="btn-login" class="btn primary">Einloggen</button>
          <button id="btn-logout" class="btn" disabled>Abmelden</button>
          <span id="auth-state" class="muted"></span>
        </div>
        <div id="login-empty-info" class="alert" style="display:none;margin-top:10px"></div>
      </div>
    </section>

    <!-- Lernkarten -->
    <section id="view-flashcards" class="view">
      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <h3>Lernkarten</h3>
          <div class="row">
            <select id="fc-category"></select>
            <button id="fc-load" class="btn primary">Laden</button>
            <span id="fc-stats" class="muted"></span>
          </div>
        </div>
        <div id="fc-area" class="cards"></div>
        <div id="fc-empty" class="alert" style="display:none;margin-top:10px"></div>
      </div>
    </section>

    <!-- Adaptives Training -->
    <section id="view-train" class="view">
      <div class="panel">
        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <div>
            <h3>Adaptiv trainieren</h3>
            <div class="muted" style="max-width:720px">
              Wiederholt Fragen mit niedriger Quote häufiger. Ab 3× korrekt in Folge → „gelernt“ und ausgeblendet (mit Cooldown).
            </div>
          </div>
          <div class="row">
            <select id="train-category"><option value="">Alle Kategorien</option></select>
            <label class="row"><input type="checkbox" id="train-weak"/> <span>Nur Schwächen</span></label>
            <label class="row"><input type="checkbox" id="train-hide-learned" checked/> <span>Gelernt ausblenden</span></label>
            <button id="train-next" class="btn primary">Nächste Karte</button>
          </div>
        </div>
        <div id="train-area" class="cards" style="margin-top:10px"></div>
        <div id="train-empty" class="alert" style="display:none;margin-top:10px"></div>
      </div>
    </section>

    <!-- Prüfung (IHK 2.0) -->
    <section id="view-exam" class="view">
      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <h3>Prüfungssimulation (IHK‑Stil)</h3>
          <div class="row">
            <select id="exam-categories" multiple></select>
            <input id="exam-count" type="number" value="40" min="5" max="100" style="width:90px"/>
            <input id="exam-minutes" type="number" value="60" min="5" max="180" style="width:90px"/>
            <button id="exam-start" class="btn primary">Start</button>
            <button id="exam-submit" class="btn" disabled>Abgeben</button>
            <button id="exam-reset" class="btn">Reset</button>
          </div>
        </div>
        <div id="exam-meta" class="muted" style="margin:8px 0"></div>
        <div id="exam-area" class="cards"></div>
      </div>
    </section>

    <!-- Fortschritt -->
    <section id="view-progress" class="view">
      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <h3>Dein Fortschritt</h3>
          <div class="row">
            <button id="reset-progress" class="btn">Lokalen Fortschritt zurücksetzen</button>
            <select id="reset-cat-select" style="min-width:260px"></select>
            <button id="reset-cat" class="btn ghost" title="Server‑Fortschritt für diese Kategorie löschen (nur deine Antworten)">Kategorie-Fortschritt löschen</button>
          </div>
        </div>
        <!-- Gesamt lokal -->
        <div id="progress-summary" class="cards" style="margin-bottom:10px"></div>

        <!-- Pro Kategorie -->
        <div class="card">
          <div class="row" style="justify-content:space-between;align-items:center">
            <b>Nach Kategorie (dein Account)</b>
            <span id="progress-user-label" class="muted">Nicht eingeloggt</span>
          </div>
          <div id="progress-cats" style="margin-top:8px"></div>
        </div>
      </div>
    </section>

    <!-- Fachrechnen -->
    <section id="view-calc" class="view">
      <div class="panel">
        <div class="row" style="justify-content:space-between; align-items:flex-end">
          <div>
            <h3>Fachrechnen</h3>
            <div class="muted" style="max-width:720px">
              Bruch‑, Prozent‑, Dreisatz, Lagerkennzahlen, Andler u.a. Mit Lösungswegen & Notizen.
            </div>
          </div>
          <div class="row">
            <select id="calc-type">
              <option value="percent">Prozentrechnen (Rabatt/Skonto/Bestand)</option>
              <option value="rule3">Dreisatz (proportional)</option>
              <option value="rule3anti">Dreisatz (antiproportional)</option>
              <option value="fraction">Bruchrechnen (vollständig)</option>
              <option value="andler">Optimale Bestellmenge (Andler)</option>
              <option value="turnover">Umschlagshäufigkeit</option>
              <option value="coverage">Lagerreichweite</option>
            </select>
            <button id="calc-new" class="btn primary">Aufgabe erzeugen</button>
          </div>
        </div>

        <div class="card">
          <div id="calc-question" style="font-weight:700; margin-bottom:8px">—</div>

          <div class="row calc-actions" style="margin-top:8px">
            <input id="calc-answer" placeholder="Deine Lösung (z. B. 1.234,56 / 3/4 / 1 3/4 / 12 %)" />
            <button id="calc-check" class="btn primary">Prüfen</button>
            <span id="calc-feedback" class="muted"> </span>
            <button id="calc-solution" class="btn">Lösungsschritte</button>
            <button id="calc-next" class="btn">Nächste</button>
            <button id="calc-reset" class="btn">Zurücksetzen</button>
          </div>

          <div id="calc-solution-box" class="alert" style="display:none; margin-top:10px"></div>

          <div class="card" style="margin-top:10px">
            <b>Notizen / Lösungsweg</b>
            <div class="notes-box" style="margin-top:6px">
              <textarea id="calc-notes" class="notes-area" placeholder="Rechenschritte, Skizzen, Merksätze …"></textarea>
              <div class="row" style="flex-direction:column; gap:8px">
                <button id="calc-notes-save" class="btn">Notizen speichern</button>
                <button id="calc-notes-clear" class="btn ghost">Notizen löschen</button>
              </div>
            </div>
            <div id="calc-notes-state" class="muted" style="margin-top:6px"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Simulationen -->
    <section id="view-sim" class="view">
      <div class="panel sim-wrap">
        <div class="sim-header">
          <div>
            <h3>Simulationen</h3>
            <div class="hint">Wähle die <b>richtige Reihenfolge</b> der Arbeitsschritte. Falsche Klicks kosten Leben.</div>
          </div>
          <div class="row">
            <select id="sim-sel"></select>
            <button id="sim-start" class="btn primary">Start</button>
            <span class="badge">💙 <span id="sim-lives">3</span> Leben</span>
            <span class="badge">🏁 <span id="sim-progress">0/0</span></span>
            <span class="badge">⭐ <span id="sim-score">0</span> Punkte</span>
          </div>
        </div>

        <div class="sim-area">
          <div class="sim-pool">
            <div class="sim-title">Verfügbare Schritte (gemischt)</div>
            <div id="sim-steps" class="cards"></div>
          </div>
          <div class="sim-queue">
            <div class="sim-title">Deine Reihenfolge</div>
            <div id="sim-picked"></div>
            <div class="row" style="margin-top:8px;justify-content:flex-end">
              <button id="sim-undo" class="btn">Letzten Schritt zurück</button>
              <button id="sim-reset" class="btn">Zurücksetzen</button>
              <button id="sim-check" class="btn primary">Prüfen & Abschließen</button>
            </div>
          </div>
          <div id="sim-result" class="alert" style="display:none"></div>
        </div>
      </div>
    </section>

    <!-- Admin -->
    <section id="view-admin" class="view">
      <div class="panel">
        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <h3>Admin</h3>
          <div class="row">
            <button id="admin-export" class="btn">Export JSON</button>
            <input type="file" id="admin-import" accept="application/json" multiple/>
          </div>
        </div>

        <div class="card">
          <h4>Kategorie verwalten</h4>
          <div class="row">
            <select id="admin-cat-old"></select>
            <input id="admin-cat-new" placeholder="Neue Kategorie (umbenennen/zusammenführen)"/>
            <button id="admin-cat-apply" class="btn primary">Anwenden</button>
            <span id="admin-cat-state" class="muted"></span>
          </div>
        </div>

        <div class="card">
          <h4>Duplikate scannen</h4>
          <div class="row">
            <button id="admin-scan-dup" class="btn">Scan starten</button>
            <span class="muted">Scannt gleiche <b>ID</b> oder sehr ähnliche <b>Fragentexte</b>.</span>
          </div>
          <div id="admin-dup-list" class="cards" style="margin-top:10px"></div>
        </div>

        <form id="admin-form" onsubmit="return false;" class="card">
          <h4>Neue Frage</h4>
          <input id="ad-category" placeholder="z.B. LL01/2 – Güter kontrollieren" required/>
          <textarea id="ad-question" rows="2" placeholder="Frage" required></textarea>
          <textarea id="ad-options" rows="4" placeholder="***Korrekt
Falsch 1
Falsch 2" required></textarea>
          <textarea id="ad-expl" rows="2" placeholder="Erklärung (optional)"></textarea>
          <div class="row"><button id="admin-save" class="btn primary">Speichern (DB)</button></div>
        </form>

        <div id="admin-list" class="cards"></div>
      </div>
    </section>
  </div>

<script>
/* ====== Admin-Definition & Defaults ====== */
const ADMINS = ['mario1986ac@hotmail.de']; // case-insensitiv prüfen
const DEFAULT_URL = 'https://ebqfupcivmkbuadbbnwg.supabase.co';
const DEFAULT_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVicWZ1cGNpdm1rYnVhZGJibndnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MDA5ODIsImV4cCI6MjA3MDQ3Njk4Mn0.P6IiwjFSpqVmObRbvxvY46l6vJlPsxPAc-wbr15Dhl0';
const DEFAULT_LOGO = 'https://ebqfupcivmkbuadbbnwg.supabase.co/storage/v1/object/public/app-assets/logo.png';

/* ====== Utilities / Setup ====== */
const views=['login','flashcards','train','exam','progress','calc','sim','admin'];
document.querySelectorAll('.nav button[data-view]').forEach(b=>b.onclick=()=>{
  if (b.hasAttribute('hidden')) return; // nicht anklickbar wenn versteckt
  views.forEach(v=>document.getElementById('view-'+v).classList.toggle('active',v===b.dataset.view));
  document.querySelectorAll('.nav button[data-view]').forEach(btn=>btn.classList.toggle('active', btn===b));
  if (b.dataset.view==='progress') renderProgress();
});
const shuffle=a=>{const b=a.slice();for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]];}return b;};

const KEY_URL='supabase_url', KEY_ANON='supabase_anon', KEY_LOGO='app_logo_url';
let supa=null;

/* Logo */
function applyBranding(){
  const logo = localStorage.getItem(KEY_LOGO) || DEFAULT_LOGO;
  const el = document.getElementById('brand-logo');
  if (logo && el){
    el.style.background='none';
    el.style.backgroundImage=`url(${logo})`;
    el.style.backgroundSize='cover';
    el.style.backgroundPosition='center';
    el.style.border='1px solid var(--line)';
  }
}

/* Kategorie-Normalizer (defensiv) */
function normalizeCategory(cat) {
  if (!cat) return '';
  return String(cat)
    .replace(/[\u2012-\u2015\u2212\uFE58\uFE63\uFF0D]/g, '-') // Unicode Striche → '-'
    .replace(/\s+/g, ' ') // Mehrfach-Spaces
    .trim();
}

/* ====== Einstellungen (nur Admin) ====== */
document.getElementById('btn-settings').onclick=()=>{
  document.getElementById('settings-modal').classList.add('show');
  document.getElementById('cfg-url').value=localStorage.getItem(KEY_URL)||DEFAULT_URL;
  document.getElementById('cfg-key').value=localStorage.getItem(KEY_ANON)||DEFAULT_ANON;
  document.getElementById('cfg-logo').value=localStorage.getItem(KEY_LOGO)||DEFAULT_LOGO;
};
document.getElementById('cfg-close').onclick=()=>document.getElementById('settings-modal').classList.remove('show');
document.getElementById('cfg-save').onclick=()=>{
  localStorage.setItem(KEY_URL, document.getElementById('cfg-url').value.trim());
  localStorage.setItem(KEY_ANON, document.getElementById('cfg-key').value.trim());
  const logo=document.getElementById('cfg-logo').value.trim();
  if(logo) localStorage.setItem(KEY_LOGO, logo); else localStorage.removeItem(KEY_LOGO);
  applyBranding();
  document.getElementById('cfg-state').textContent='Gespeichert. Seite lädt neu...';
  setTimeout(()=>location.reload(),400);
};

/* ====== Supabase Init + Nav-Gating ====== */
function isAdminEmail(email){ return !!email && ADMINS.includes(String(email).toLowerCase()); }

function gateNavFor(user){
  const logged = !!user;
  // Sichtbarkeit
  document.getElementById('nav-flash').hidden = !logged;
  document.getElementById('nav-train').hidden = !logged;
  document.getElementById('nav-exam').hidden  = !logged;
  document.getElementById('nav-progress').hidden = !logged;
  document.getElementById('nav-calc').hidden = !logged;
  document.getElementById('nav-sim').hidden = !logged;

  const isAdmin = logged && isAdminEmail(user.email);
  document.getElementById('nav-admin').hidden = !isAdmin;
  document.getElementById('btn-settings').hidden = !isAdmin;

  // View setzen
  const current = document.querySelector('.view.active');
  if(!logged){
    views.forEach(v=>document.getElementById('view-'+v).classList.toggle('active',v==='login'));
    document.getElementById('nav-login').classList.add('active');
    document.getElementById('login-empty-info').style.display='block';
    document.getElementById('login-empty-info').textContent='Bitte zuerst einloggen.';
  }else{
    if(current && current.id==='view-login'){
      views.forEach(v=>document.getElementById('view-'+v).classList.toggle('active',v==='flashcards'));
      document.getElementById('nav-flash').classList.add('active');
    }
  }
}

async function initClient(){
  const url=localStorage.getItem(KEY_URL)||DEFAULT_URL;
  const anon=localStorage.getItem(KEY_ANON)||DEFAULT_ANON;
  supa = supabase.createClient(url, anon);
  applyBranding();

  renderProgress();
  await refreshSelectors(); await refreshTrainSelectors(); await refreshExamCategories(); await renderAdminList(); await showEmptyHints(); await fillAdminCatSelect(); await fillResetCatSelect();
  await refreshAuthUI();

  // Simulationen initialisieren
  initSimModule();
}

/* ====== Auth ====== */
const email=document.getElementById('email'), password=document.getElementById('password');
const btnSignup=document.getElementById('btn-signup'), btnLogin=document.getElementById('btn-login'), btnLogout=document.getElementById('btn-logout');
const authState=document.getElementById('auth-state');

async function refreshAuthUI(){
  if(!supa) return;
  const {data:{user}}=await supa.auth.getUser();
  if(user){
    btnLogout.disabled=false; btnLogin.disabled=true; btnSignup.disabled=true;
    authState.textContent=`Eingeloggt: ${user.email}`;
  } else {
    btnLogout.disabled=true; btnLogin.disabled=false; btnSignup.disabled=false;
    authState.textContent='Nicht eingeloggt';
  }
  gateNavFor(user||null);
}

btnSignup.onclick=async()=>{
  const {error}=await supa.auth.signUp({email:email.value,password:password.value});
  if(error) alert(error.message); else alert('Registriert. Prüfe dein Postfach.');
  refreshAuthUI();
};
btnLogin.onclick=async()=>{
  const {error}=await supa.auth.signInWithPassword({email:email.value,password:password.value});
  if(error) alert(error.message);
  await refreshAuthUI();
};
btnLogout.onclick=async()=>{ await supa.auth.signOut(); await refreshAuthUI(); };

/* ====== Data helpers ====== */
async function fetchQuestions(){
  if(!supa) return [];
  const {data,error}=await supa.from('questions').select('*').order('category',{ascending:true});
  if(error){console.warn(error); return [];}
  // Normalize & dedupe (falls Server Altlasten hat)
  return (data||[]).map(q => ({ ...q, category: normalizeCategory(q.category) }));
}
async function fetchCategories(){
  const q=await fetchQuestions();
  const set = new Set(q.map(x=>normalizeCategory(x.category)));
  return [...set].filter(Boolean).sort((a,b)=>a.localeCompare(b,'de',{numeric:true}));
}

/* ====== Lernkarten ====== */
const fcCategory=document.getElementById('fc-category'), fcArea=document.getElementById('fc-area'), fcStats=document.getElementById('fc-stats'), fcEmpty=document.getElementById('fc-empty');
document.getElementById('fc-load').onclick=loadFlashcards;
async function refreshSelectors(){ const cats=await fetchCategories(); fcCategory.innerHTML=cats.map(c=>`<option>${c}</option>`).join(''); }
async function loadFlashcards(){
  const all=await fetchQuestions(); const cat=fcCategory.value; const cards=all.filter(x=>x.category===cat);
  fcArea.innerHTML='';
  if(cards.length===0){
    fcEmpty.style.display='block'; fcEmpty.textContent='Keine Fragen in dieser Kategorie. Admin → Import nutzen.'; fcStats.textContent='0 Karten'; return;
  } else fcEmpty.style.display='none';
  let n=0;
  cards.forEach(card=>{
    const wrap=document.createElement('div'); wrap.className='card';
    const opts=card.options.map((t,i)=>({text:t,correct:i===card.correct_index}));
    wrap.innerHTML=`<div class="row" style="justify-content:space-between"><div><span class="chip">${card.category}</span></div><div class="muted">ID: ${card.id}</div></div>
      <div><b>${card.question}</b></div><div class="options"></div>
      <div class="row" style="margin-top:8px"><span class="muted">Klick zum Markieren, Lösung wird angezeigt.</span></div>
      <div class="reveal" style="display:none"></div>`;
    const box=wrap.querySelector('.options');
    opts.forEach((o,i)=>{ const d=document.createElement('div'); d.className='option'; d.innerHTML=`<input type="radio"/><span>${o.text}</span>`;
      d.onclick=async()=>{
        [...box.children].forEach(c=>c.classList.remove('selected')); d.classList.add('selected');
        const solution=opts.find(o=>o.correct)?.text; const reveal=wrap.querySelector('.reveal');
        const ok=(i===opts.findIndex(z=>z.correct));
        reveal.style.display='block'; reveal.textContent = ok ? '✅ Richtig!' : `❌ Falsch. Richtig: ${solution}`;
        bumpProgress(1, ok?1:0);
        const {data:{user}}=await supa.auth.getUser();
        if(user) await supa.from('reviews').insert({user_id:user.id,question_id:card.id,correct:ok});
      };
      box.appendChild(d);
    });
    fcArea.appendChild(wrap); n++;
  });
  fcStats.textContent=`${n} Karten`;
}

/* ====== Adaptives Training ====== */
const trCategory=document.getElementById('train-category'), trWeak=document.getElementById('train-weak'), trHideLearned=document.getElementById('train-hide-learned');
const trNext=document.getElementById('train-next'), trArea=document.getElementById('train-area'), trEmpty=document.getElementById('train-empty']);

async function refreshTrainSelectors(){ const cats=await fetchCategories(); trCategory.innerHTML='<option value="">Alle Kategorien</option>'+cats.map(c=>`<option>${c}</option>`).join(''); }
async function getUser(){ try{ const {data:{user}}=await supa.auth.getUser(); return user||null; }catch{return null;} }

async function fetchStatsMap(userId){
  const map={}; if(!userId) return map;
  const { data } = await supa.from('reviews').select('question_id,ts,correct').eq('user_id',userId).order('ts',{ascending:true});
  (data||[]).forEach(r=>{
    const m = map[r.question_id] ||= { seen:0, correct:0, streak:0, last:false, lastTs:null };
    m.seen++; if(r.correct){ m.correct++; m.streak = (m.last===true)?(m.streak+1):1; } else { m.streak = 0; }
    m.last = r.correct; m.lastTs = r.ts;
  });
  return map;
}
function cooldownDaysForStreak(s){ if(s>=5) return 14; if(s>=4) return 7; if(s>=3) return 3; if(s>=2) return 1; return 0; }
function isInCooldown(entry){ if(!entry||!entry.lastTs) return false; const d=cooldownDaysForStreak(entry.streak||0); if(d<=0) return false; const next=new Date(entry.lastTs); next.setDate(next.getDate()+d); return (new Date()<next); }

async function pickAdaptiveCard(categoryFilter, onlyWeak, hideLearned){
  const all=await fetchQuestions();
  const user=await getUser();
  const stats = await fetchStatsMap(user?.id);
  let pool = all.filter(q => !categoryFilter || q.category===categoryFilter).map(q=>{
    const s = stats[q.id] || { seen:0, correct:0, last:false, streak:0, lastTs:null };
    const acc = s.seen ? s.correct/s.seen : 0;
    const wrongBias = (s.last===false) ? 0.2 : 0;
    const seenPenalty = Math.min(s.seen*0.02, 0.2);
    const streak = s.streak||0;
    const learned = (streak>=3);
    const cooldown = isInCooldown(s);
    let weight = (1-acc) + wrongBias - seenPenalty;
    if(learned && hideLearned) weight -= 1.5;
    if(cooldown) weight -= 0.8;
    return { q, s, acc, learned, cooldown, weight };
  });
  if(onlyWeak) pool = pool.filter(x => (x.acc<0.7) || (x.s.last===false));
  pool = pool.filter(x=>x.weight> -0.3);
  if(pool.length===0) return null;
  const minW = Math.min(...pool.map(x=>x.weight));
  const normalized = pool.map(p=>({ ...p, w: p.weight - minW + 0.001 }));
  const sum = normalized.reduce((a,b)=>a+b.w,0);
  let r = Math.random()*sum; for(const p of normalized){ r-=p.w; if(r<=0) return p.q; }
  return normalized[normalized.length-1].q;
}
function renderTrainCard(card){
  trArea.innerHTML='';
  if(!card){ trEmpty.style.display='block'; trEmpty.textContent='Keine geeignete Karte gefunden. Passe Filter an (z. B. „Gelernt ausblenden“ deaktivieren).'; return; }
  trEmpty.style.display='none';
  const opts=card.options.map((t,i)=>({text:t,correct:i===card.correct_index}));
  const wrap=document.createElement('div'); wrap.className='card';
  wrap.innerHTML = `
    <div class="row" style="justify-content:space-between">
      <div><span class="chip">${card.category}</span></div>
      <div class="muted">ID: ${card.id}</div>
    </div>
    <div style="margin-top:6px"><b>${card.question}</b></div>
    <div class="options" style="margin-top:6px"></div>
    <div class="reveal" style="display:none;margin-top:8px"></div>`;
  const box=wrap.querySelector('.options');
  opts.forEach((o,i)=>{ const d=document.createElement('div'); d.className='option';
    d.innerHTML=`<input type="radio"/> <span>${o.text}</span>`;
    d.onclick=async()=>{
      [...box.children].forEach(c=>c.classList.remove('selected')); d.classList.add('selected');
      const ok = (i===opts.findIndex(z=>z.correct)); const rev=wrap.querySelector('.reveal'); rev.style.display='block';
      rev.textContent = ok? '✅ Richtig!' : `❌ Falsch. Richtig: ${opts.find(o=>o.correct)?.text}`;
      bumpProgress(1, ok?1:0);
      const {data:{user}}=await supa.auth.getUser(); if(user) await supa.from('reviews').insert({user_id:user.id,question_id:card.id,correct:ok});
    };
    box.appendChild(d);
  });
  trArea.appendChild(wrap);
}
trNext.onclick=async()=>{ const card = await pickAdaptiveCard(trCategory.value||null, trWeak.checked, trHideLearned.checked); renderTrainCard(card); };

/* ====== IHK-Prüfungsmodus ====== */
const examCategories=document.getElementById('exam-categories'), examCount=document.getElementById('exam-count'), examMinutes=document.getElementById('exam-minutes');
const examStart=document.getElementById('exam-start'), examSubmit=document.getElementById('exam-submit'), examReset=document.getElementById('exam-reset');
const examArea=document.getElementById('exam-area'), examMeta=document.getElementById('exam-meta');

let ihkRunning=false, timerId=null, timeLeft=0;
let examPool=[], selections={}, session=null;

function ensureStickySubmit(){ let b=document.getElementById('exam-submit-sticky'); if(!b){ b=document.createElement('button'); b.id='exam-submit-sticky'; b.textContent='Abgeben'; b.onclick=()=>examSubmit.click(); document.body.appendChild(b); } b.disabled=!ihkRunning; updateStickySubmitLabel(); return b; }
function removeStickySubmit(){ const b=document.getElementById('exam-submit-sticky'); if(b) b.remove(); }
function updateStickySubmitLabel(){ const b=document.getElementById('exam-submit-sticky'); if(!b) return; const total=examPool.length||0; const answered=Object.values(selections).filter(v=>v!=null).length; b.textContent = total? `Abgeben (${answered}/${total})`:'Abgeben'; b.disabled=!ihkRunning; }
async function refreshExamCategories(){ const cats=await fetchCategories(); examCategories.innerHTML=cats.map(c=>`<option value="${c}" selected>${c}</option>`).join(''); }
function pickN(a,n){ const b=shuffle(a); return b.slice(0,Math.max(0,Math.min(n,b.length))); }
function renderMeta(){ const total=examPool.length; const answered=Object.values(selections).filter(v=>v!=null).length; const mm = String(Math.max(0, Math.floor(timeLeft/60))).padStart(2,'0'); const ss = String(Math.max(0, timeLeft%60)).padStart(2,'0'); examMeta.textContent=`Fragen: ${answered}/${total} • Restzeit ${mm}:${ss}`; updateStickySubmitLabel(); }

examStart.onclick=async()=>{
  const {data:{user}}=await supa.auth.getUser(); if(!user) return alert('Bitte zuerst einloggen.');
  const all=await fetchQuestions(); const chosen=[...examCategories.selectedOptions].map(o=>o.value);
  const pool=all.filter(q=>chosen.includes(q.category)); if(!pool.length) return alert('Keine Fragen in den gewählten Kategorien.');
  const n=Math.max(5,Math.min(Number(examCount.value||40),100));
  examPool = pickN(pool,n); selections={}; examArea.innerHTML=''; ihkRunning=true; examSubmit.disabled=false;
  timeLeft = (Number(examMinutes.value||60))*60; renderMeta();
  if(timerId) clearInterval(timerId);
  timerId=setInterval(()=>{ timeLeft--; renderMeta(); if(timeLeft<=0){ clearInterval(timerId); finishExam(true); } },1000);
  examPool.forEach((q,idx)=>{ const el=document.createElement('div'); el.className='card';
    const opts = q.options.map((t,i)=>({text:t,correct:i===q.correct_index}));
    el.innerHTML=`<div class="row" style="justify-content:space-between"><div><span class="chip">${q.category}</span></div><div class="muted">Frage ${idx+1}/${n}</div></div>
      <div style="margin-top:4px"><b>${q.question}</b></div><div class="options"></div>`;
    const box=el.querySelector('.options');
    opts.forEach((o,i)=>{ const d=document.createElement('label'); d.className='option'; d.innerHTML=`<input type="radio" name="q_${q.id}"/> <span>${o.text}</span>`;
      d.onclick=()=>{ selections[q.id]=i; [...box.children].forEach(c=>c.classList.remove('selected')); d.classList.add('selected'); renderMeta(); };
      box.appendChild(d);
    });
    examArea.appendChild(el);
  });
  session = { items:[], total:n, correct:0, startedAt:new Date().toISOString() };
  ensureStickySubmit();
};
examSubmit.onclick=()=>{ if(!ihkRunning) return; finishExam(false); };
examReset.onclick=()=>{ ihkRunning=false; clearInterval(timerId); examArea.innerHTML=''; examMeta.textContent=''; examSubmit.disabled=true; removeStickySubmit(); };

async function finishExam(auto=false){
  ihkRunning=false; clearInterval(timerId); examSubmit.disabled=true; removeStickySubmit();
  session.items = examPool.map(q=>{ const chosenIndex = selections[q.id]; const correctIndex = q.correct_index; const correct = chosenIndex===correctIndex;
    return { id:q.id, category:q.category, question:q.question, selectedText:(q.options[chosenIndex]??''), correctText:q.options[correctIndex], explanation:q.explanation||'', correct }; });
  session.correct = session.items.filter(x=>x.correct).length; session.finishedAt=new Date().toISOString();

  const {data:{user}}=await supa.auth.getUser();
  if(user){
    try { await supa.from('exam_sessions').insert({ user_id:user.id, total:session.total, correct:session.correct, detail:session.items }); } catch(e){ console.warn('exam_sessions insert', e); }
    try { for(const it of session.items){ await supa.from('reviews').insert({user_id:user.id,question_id:it.id,correct:it.correct}); } } catch(e){ console.warn('reviews insert', e); }
  }
  showResult(session, auto);
}

/* ====== Ergebnis-Panel + PDF ====== */
function showResult(session){
  const modal=document.getElementById('result-modal');
  document.getElementById('res-total').textContent = `${session.correct} / ${session.total}`;
  document.getElementById('res-quote').textContent = `${session.total?Math.round(100*session.correct/session.total):0}%`;
  document.getElementById('res-date').textContent = new Date().toLocaleString();

  const byCat={}; session.items.forEach(it=>{ const c=it.category||'–'; byCat[c]=byCat[c]||{total:0,correct:0}; byCat[c].total++; byCat[c].correct+=it.correct?1:0; });
  const cats = Object.entries(byCat).map(([c,s])=>{ const pct = s.total? Math.round(100*s.correct/s.total):0;
    return `<div class="row" style="justify-content:space-between;border-bottom:1px dashed var(--line);padding:6px 0"><div>${c}</div><div class="muted">${s.correct}/${s.total} (${pct}%)</div></div>`; }).join('');
  document.getElementById('res-cats').innerHTML=cats||'<div class="muted">Keine Daten.</div>';

  const items=document.getElementById('res-items');
  items.innerHTML = session.items.map((it,i)=>`
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div><span class="chip">${it.category||''}</span></div>
        <div class="chip" style="border-color:${it.correct?'#34d399':'#ef4444'};color:${it.correct?'#34d399':'#ef4444'}">${it.correct?'Richtig':'Falsch'}</div>
      </div>
      <div style="margin-top:6px"><b>${i+1}. ${it.question}</b></div>
      <div style="margin-top:6px"><b>Deine Antwort:</b> ${it.selectedText||''}</div>
      <div><b>Richtige Lösung:</b> ${it.correctText||''}</div>
      ${it.explanation?`<div><b>Erklärung:</b> ${it.explanation}</div>`:''}
    </div>`).join('');

  document.getElementById('res-new').onclick=()=>{ modal.classList.remove('show'); examReset.click(); };
  document.getElementById('res-close').onclick=()=> modal.classList.remove('show');
  document.getElementById('result-pdf').onclick = async () => {
    const { data:{user} = {} } = await supa.auth.getUser();
    const logo = localStorage.getItem(KEY_LOGO) || DEFAULT_LOGO;
    await generateExamPDF({ session, userEmail: user?.email || "", logoUrlOrDataUri: logo });
  };

  modal.classList.add('show');
}

/* ====== Fortschritt (lokal + pro Kategorie) ====== */
function bumpProgress(seenDelta, correctDelta){
  const p = JSON.parse(localStorage.getItem('progress_local') || '{"seen":0,"correct":0}');
  p.seen += seenDelta; p.correct += correctDelta;
  localStorage.setItem('progress_local', JSON.stringify(p));
  renderProgress();
}

// Helfer
function pct(n,d){ return d? Math.round((n/d)*100):0; }
function barClass(p){ if(p>=80) return 'ok'; if(p>=50) return 'mid'; return 'low'; }

async function computeCategoryStats(){
  if(!supa) return { user:null, rows:[] };
  let user=null;
  try { const r=await supa.auth.getUser(); user=r?.data?.user||null; } catch{}
  if(!user) return { user:null, rows:[] };

  const qs = await fetchQuestions();
  const byCat = {};
  qs.forEach(q=>{
    const c=q.category||'–';
    (byCat[c] ||= { cat:c, totalQuestions:0, seen:0, correct:0 });
    byCat[c].totalQuestions++;
  });

  const { data:revs } = await supa.from('reviews').select('question_id, correct').eq('user_id', user.id);
  const qById = Object.fromEntries(qs.map(q=>[q.id,q]));
  (revs||[]).forEach(r=>{
    const q = qById[r.question_id];
    if(!q) return;
    const c = q.category||'–';
    const row = byCat[c] ||= { cat:c, totalQuestions:0, seen:0, correct:0 };
    row.seen++;
    if(r.correct) row.correct++;
  });

  const rows = Object.values(byCat).sort((a,b)=> a.cat.localeCompare(b.cat,'de',{numeric:true}));
  return { user, rows };
}

async function renderProgress(){
  const p = JSON.parse(localStorage.getItem('progress_local') || '{"seen":0,"correct":0}');
  const acc = p.seen ? Math.round(p.correct/p.seen*100) : 0;
  document.getElementById('progress-summary').innerHTML = `
    <div class="card"><b>Letzte Sitzung (lokal)</b>
    <div>Beantwortet: <b>${p.seen}</b> • Richtig: <b>${p.correct}</b> • Quote: <b>${acc}%</b></div></div>`;

  const { user, rows } = await computeCategoryStats();
  document.getElementById('progress-user-label').textContent = user ? `Eingeloggt: ${user.email}` : 'Nicht eingeloggt';
  const list=document.getElementById('progress-cats');
  if(!user){ list.innerHTML='<div class="muted">Bitte anmelden, um deinen Fortschritt pro Kategorie zu sehen.</div>'; return; }
  if(!rows.length){ list.innerHTML='<div class="muted">Noch keine Antworten gespeichert. Starte ein Training oder eine Prüfung.</div>'; return; }

  list.innerHTML = rows.map(r=>{
    const a = pct(r.correct, r.seen);
    const cov = pct(r.seen, r.totalQuestions);
    const cls = barClass(a);
    return `
      <div class="progress-row">
        <div class="progress-meta">
          <div><b>${r.cat}</b></div>
          <div class="muted" style="font-size:12px">
            Gesehen: ${r.seen}/${r.totalQuestions} • Quote: ${a}% • Abdeckung: ${cov}%
          </div>
        </div>
        <div class="progress-bar" title="Quote richtig">
          <div class="progress-fill ${cls}" style="width:${a}%"></div>
        </div>
        <div class="progress-pill">${a}%</div>
      </div>`;
  }).join('');
}
document.getElementById('reset-progress').onclick=()=>{localStorage.removeItem('progress_local'); renderProgress();};

/* Server-Fortschritt (User) je Kategorie löschen */
async function fillResetCatSelect(){
  const cats=await fetchCategories();
  const sel=document.getElementById('reset-cat-select');
  sel.innerHTML = '<option value="">Kategorie wählen…</option>' + cats.map(c=>`<option>${c}</option>`).join('');
}
document.getElementById('reset-cat').onclick=async ()=>{
  const sel=document.getElementById('reset-cat-select');
  const cat=sel.value;
  if(!cat) return alert('Bitte eine Kategorie wählen.');
  const { data:{user} } = await supa.auth.getUser();
  if(!user) return alert('Bitte einloggen.');
  // hole alle Fragen der Kategorie
  const qs = await supa.from('questions').select('id,category').eq('category', cat);
  const ids = (qs.data||[]).map(q=>q.id);
  if(!ids.length) return alert('Keine Fragen in dieser Kategorie.');
  if(!confirm(`Deine gespeicherten Antworten in "${cat}" wirklich löschen?`)) return;
  const { error } = await supa.from('reviews').delete().eq('user_id', user.id).in('question_id', ids);
  if(error){ alert('Fehler beim Löschen: '+error.message); return; }
  alert('Kategorie-Fortschritt gelöscht.');
  renderProgress();
};

/* ====== Admin ====== */
const adminList=document.getElementById('admin-list');
async function renderAdminList(){
  const q=await fetchQuestions();
  adminList.innerHTML=q.map(x=>`<div class="card"><div class="row" style="justify-content:space-between">
  <div><span class="chip">${x.category}</span></div><button data-del="${x.id}" class="btn">Löschen</button></div>
  <div><b>${x.question}</b></div></div>`).join('');
  adminList.querySelectorAll('button[data-del]').forEach(btn=>btn.onclick=async()=>{
    const id=btn.getAttribute('data-del'); const {error}=await supa.from('questions').delete().eq('id',id);
    if(error) alert(error.message); else renderAdminList();
  });
}

document.getElementById('admin-export').onclick=async()=>{
  const q=await fetchQuestions(); const blob=new Blob([JSON.stringify(q,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='fragen_export_supabase.json'; a.click(); URL.revokeObjectURL(url);
};

document.getElementById('admin-import').onchange=async(e)=>{
  const files=[...(e.target.files||[])]; if(!files.length) return;
  const allItems=[];
  for(const f of files){
    try{
      const text=await f.text(); const arr=JSON.parse(text);
      if(Array.isArray(arr)) allItems.push(...arr);
      else if(arr && typeof arr==='object') allItems.push(arr);
    }catch(err){ alert(`Fehler in ${f.name}: ${err.message}`); }
  }
  if(!allItems.length){ alert('Keine gültigen Fragen gefunden.'); return; }

  // Normalisierung der Kategorien beim Import
  const cleaned = allItems
    .map(x=>{
      const { deck, correctIndex, ...rest } = x || {};
      const cat = normalizeCategory(rest.category || rest.category_name || '');
      return { ...rest, category: cat, correct_index: rest.correct_index ?? correctIndex };
    })
    .filter(x=>x && x.id && Array.isArray(x.options) && Number.isInteger(x.correct_index));

  let okCount=0, errCount=0;
  for(const item of cleaned){
    const {error}=await supa.from('questions').upsert(item,{onConflict:'id'});
    if(error){ errCount++; console.warn('Fehler',item.id,error.message); } else okCount++;
  }
  alert(`Import fertig. Erfolgreich: ${okCount} • Fehler: ${errCount}`);
  await renderAdminList(); await refreshSelectors(); await refreshTrainSelectors(); await refreshExamCategories(); await showEmptyHints(); await fillAdminCatSelect(); await fillResetCatSelect();
};

async function fillAdminCatSelect(){
  const cats=await fetchCategories();
  document.getElementById('admin-cat-old').innerHTML = cats.map(c=>`<option>${c}</option>`).join('');
}
document.getElementById('admin-cat-apply').onclick=async()=>{
  const oldVal=document.getElementById('admin-cat-old').value;
  const newVal=normalizeCategory((document.getElementById('admin-cat-new').value||'').trim());
  if(!oldVal || !newVal) return alert('Bitte alte Kategorie wählen und neue Kategorie eintragen.');
  const { error, count } = await supa.from('questions').update({category:newVal}).eq('category',oldVal).select('id',{count:'exact'});
  document.getElementById('admin-cat-state').textContent = error? ('Fehler: '+error.message) : (`Geändert: ${count||0}`);
  await renderAdminList(); await refreshSelectors(); await refreshTrainSelectors(); await refreshExamCategories(); await fillAdminCatSelect(); await fillResetCatSelect();
};

document.getElementById('admin-scan-dup').onclick=async()=>{
  const list=document.getElementById('admin-dup-list'); list.innerHTML='Suche…';
  const q=await fetchQuestions(); if(!q.length){ list.innerHTML='<div class="card muted">Keine Fragen.</div>'; return; }
  const byText={}, byId={};
  for(const it of q){
    const key=(it.question||'').trim().toLowerCase();
    (byText[key] ||= []).push(it);
    (byId[it.id] ||= []).push(it);
  }
  const groupsTxt=Object.values(byText).filter(arr=>arr.length>1);
  const groupsId =Object.values(byId).filter(arr=>arr.length>1);
  if(!groupsTxt.length && !groupsId.length){ list.innerHTML='<div class="card">Keine Duplikate gefunden.</div>'; return; }

  // Rendern mit Direkt-Löschen
  const renderGroup = (title, groups) => `
    <div class="card">
      <b>${title}</b>
      ${groups.map(arr=>{
        const head=(arr[0].question||'').slice(0,120);
        const rows=arr.map(x=>`<div class="row" style="justify-content:space-between;align-items:center">
          <div><span class="chip">${x.category}</span> <span class="muted">${x.id}</span></div>
          <button class="btn ghost btn-del-one" data-id="${x.id}">Löschen</button>
        </div>`).join('');
        return `<div class="card" style="margin-top:8px"><div><b>${head}</b></div>${rows}
          <div class="row" style="justify-content:flex-end; margin-top:8px">
            <button class="btn primary btn-del-all" data-ids="${arr.map(x=>x.id).join(',')}">Alle in dieser Gruppe löschen</button>
          </div>
        </div>`;
      }).join('')}
    </div>`;

  list.innerHTML = (groupsId.length?renderGroup('Duplikate per ID',groupsId):'') + (groupsTxt.length?renderGroup('Duplikate per Fragentext',groupsTxt):'');

  list.querySelectorAll('.btn-del-one').forEach(btn=>{
    btn.onclick=async()=>{
      const id=btn.getAttribute('data-id');
      if(!confirm(`Frage ${id} wirklich löschen?`)) return;
      const {error}=await supa.from('questions').delete().eq('id',id);
      if(error) alert(error.message); else document.getElementById('admin-scan-dup').click();
    };
  });
  list.querySelectorAll('.btn-del-all').forEach(btn=>{
    btn.onclick=async()=>{
      const ids=(btn.getAttribute('data-ids')||'').split(',').filter(Boolean);
      if(!ids.length) return;
      if(!confirm(`Alle ${ids.length} Fragen dieser Gruppe löschen?`)) return;
      const {error}=await supa.from('questions').delete().in('id',ids);
      if(error) alert(error.message); else document.getElementById('admin-scan-dup').click();
    };
  });
};

/* ====== Empty DB Hinweis ====== */
async function showEmptyHints(){
  const all=await fetchQuestions();
  const hint=document.getElementById('login-empty-info');
  if(!all.length){ hint.style.display='block'; hint.innerHTML='Noch keine Fragen in der Datenbank. Admin → Import nutzen.'; } else hint.style.display='none';
}

/* ====== PDF (ausführlich, mit Logo auf Seite 1) ====== */
async function generateExamPDF({ session, userEmail, logoUrlOrDataUri=null }) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "mm", format: "a4" });
  const left = 20, right = 190; let y = 20;

  const set = (size=11, bold=false, color=20) => {
    doc.setFont("helvetica", bold? "bold":"normal");
    doc.setFontSize(size);
    doc.setTextColor(color);
  };
  const addY = (h) => { y += h; if (y > 280){ doc.addPage(); y = 20; } };
  const hr = () => { doc.setDrawColor(220); doc.line(left, y, right, y); addY(4); };
  const wrap = (text) => doc.splitTextToSize(text||"", right-left);

  try {
    if (logoUrlOrDataUri) {
      const img = await fetch(logoUrlOrDataUri).then(r=>r.blob()).then(b=>new Promise((res) => {
        const fr = new FileReader(); fr.onload = () => res(fr.result); fr.readAsDataURL(b);
      }));
      doc.addImage(img, 'PNG', right-20-16, 10, 16, 16);
    }
  } catch(e) {}

  set(18,true); doc.text("Prüfungsergebnis – Lernapp Lagerlogistik", left, y); addY(10);

  const created = new Date().toLocaleString();
  set(10,true,120); doc.text("Erstellt:", left, y); set(12,false,20); doc.text(created, left, y+6);
  set(10,true,120); doc.text("Prüfling:", left+90, y); set(12,false,20); doc.text(`E‑Mail: ${userEmail||"-"}`, left+90, y+6);
  addY(16);

  hr();
  set(10,true,120); doc.text("Gesamt richtig:", left, y); set(12,false); doc.text(`${session.correct} / ${session.total}`, left, y+6);
  set(10,true,120); doc.text("Quote:", left+90, y); set(12,false); doc.text(`${session.total?Math.round(100*session.correct/session.total):0}%`, left+90, y+6);
  addY(16); hr();

  set(13,true); doc.text("Nach Kategorie:", left, y); addY(7);
  const byCat={}; (session.items||[]).forEach(it=>{const c=it.category||"–"; byCat[c]=byCat[c]||{total:0,correct:0}; byCat[c].total++; byCat[c].correct+=it.correct?1:0;});
  Object.entries(byCat).forEach(([c,s])=>{ const pct=s.total?Math.round(100*s.correct/s.total):0; set(12,false); doc.text(`• ${c}: ${s.correct}/${s.total} (${pct}%)`, left, y); addY(6); });
  addY(4); hr();

  set(13,true); doc.text("Einzelaufstellung (Fragen & Antworten)", left, y); addY(8);
  (session.items||[]).forEach((it, idx) => {
    set(12,true); doc.text(`${idx+1}. ${it.category||''}`, left, y); addY(6);
    wrap(it.question).forEach(row=>{ set(12,false); doc.text(row,left,y); addY(5); });
    set(10,true,120); doc.text("Deine Antwort:", left, y); addY(5);
    wrap(it.selectedText).forEach(row=>{ set(11,false); doc.text(row,left,y); addY(5); });
    set(10,true,120); doc.text("Richtige Lösung:", left, y); addY(5);
    wrap(it.correctText).forEach(row=>{ set(11,false); doc.text(row,left,y); addY(5); });
    if (it.explanation){ set(10,true,120); doc.text("Erklärung:", left, y); addY(5); wrap(it.explanation).forEach(row=>{ set(11,false); doc.text(row,left,y); addY(5); }); }
    set(11,true, it.correct?20:180); doc.text(`Bewertung: ${it.correct?'RICHTIG':'FALSCH'}`, left, y); addY(7); hr();
  });

  const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  doc.save(`pruefungsbericht_${stamp}.pdf`);
}

/* ====== Fachrechnen – Generatoren & Prüfung ====== */
const calcType = document.getElementById('calc-type');
const calcQ   = document.getElementById('calc-question');
const calcAns = document.getElementById('calc-answer');
const btnNew  = document.getElementById('calc-new');
const btnSol  = document.getElementById('calc-solution');
const btnNext = document.getElementById('calc-next');
const btnReset= document.getElementById('calc-reset');
const btnCheck= document.getElementById('calc-check');
const calcSolBox = document.getElementById('calc-solution-box');
const calcFeedback = document.getElementById('calc-feedback');

// Notes
const notesArea = document.getElementById('calc-notes');
const notesSave = document.getElementById('calc-notes-save');
const notesClear= document.getElementById('calc-notes-clear');
const notesState= document.getElementById('calc-notes-state');

let currentTask=null;

function rnd(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function rndFloat(min,max,dec=2){ const v = Math.random()*(max-min)+min; return Math.round(v*10**dec)/10**dec; }

function fmt(v){
  if (!isFinite(v)) return '—';
  if (Math.abs(v - Math.round(v)) < 1e-9) return String(Math.round(v));
  return (Math.round(v * 100) / 100).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

/** Parser & Prüfer (erweitert: gemischte Zahlen & %) */
function parseNumber(raw){
  if(!raw) return NaN;
  let s = String(raw).trim();

  // Prozent?
  const isPct = /%$/.test(s.replace(/\s+/g,''));
  s = s.replace(/\s+/g,' ').trim();

  // Einheiten am Ende (€, Stk, kg, m, h, …) entfernen
  s = s.replace(/\s*[€A-Za-zÄÖÜäöüß\.]+$/,'');

  // gemischte Zahl? "a b/c" oder "-a b/c"
  const mixed = s.match(/^\s*([+-]?\d+)\s+(\d+)\s*\/\s*(\d+)\s*$/);
  if(mixed){
    const sign = Math.sign(parseInt(mixed[1],10));
    const A = parseInt(mixed[1],10);
    const b = parseInt(mixed[2],10);
    const c = parseInt(mixed[3],10);
    if(c===0) return NaN;
    let val = Math.abs(A) + b/c;
    val = sign<0 ? -val : val;
    return isPct ? val*0.01 : val;
  }

  // reiner Bruch? "a/b" oder "-a/b"
  const frac = s.match(/^\s*([+-]?\d+)\s*\/\s*(\d+)\s*$/);
  if(frac){
    const a = parseInt(frac[1],10);
    const b = parseInt(frac[2],10);
    if(b===0) return NaN;
    const val = a/b;
    return isPct ? val*0.01 : val;
  }

  // Prozentzeichen entfernen
  s = s.replace(/%$/,'').replace(/\s+/g,'');

  // deutsch 1.234,56 → 1234.56
  if (/^\d{1,3}(\.\d{3})*,\d+$/.test(s) || /^\d+,\d+$/.test(s)) {
    s = s.replace(/\./g,'').replace(',', '.');
  } else {
    // international 1,234.56 → 1234.56
    if (/^\d{1,3}(,\d{3})+\.\d+$/.test(s)) s = s.replace(/,/g,'');
    // reine Ganzzahlen mit Trennern
    if (/^\d{1,3}([.,]\d{3})+$/.test(s)) s = s.replace(/[.,]/g,'');
  }

  let val = Number(s);
  if (Number.isNaN(val)) return NaN;
  if (isPct) val = val * 0.01;
  return val;
}
function nearlyEqual(userVal, targetVal){
  if (!isFinite(userVal) || !isFinite(targetVal)) return false;
  const absTol = 0.01;
  const relTol = 0.01 * Math.max(1, Math.abs(targetVal)); // 1% oder min 1
  const tol = Math.max(absTol, relTol);
  return Math.abs(userVal - targetVal) <= tol;
}
function evaluateAnswer(){
  if(!currentTask) return;
  const userRaw = calcAns.value;
  const userVal = parseNumber(userRaw);
  const target  = Number(currentTask.a);
  if(Number.isNaN(userVal)){
    calcFeedback.textContent = 'Bitte eine Zahl angeben (z. B. 1.234,56, 3/4, 1 3/4 oder 12 %).';
    calcFeedback.className = 'calc-bad';
    calcAns.classList.remove('valid'); calcAns.classList.add('invalid');
    return;
  }
  const ok = nearlyEqual(userVal, target);
  if(ok){
    calcFeedback.innerHTML = `✅ Richtig! Erwartet: <b>${fmt(target)}</b>`;
    calcFeedback.className = 'calc-ok';
    calcAns.classList.remove('invalid'); calcAns.classList.add('valid');
  }else{
    calcFeedback.innerHTML = `❌ Falsch. Erwartet ca.: <b>${fmt(target)}</b>`;
    calcFeedback.className = 'calc-bad';
    calcAns.classList.remove('valid'); calcAns.classList.add('invalid');
  }
}

/* ===== Aufgabengeneratoren ===== */
function genPercent(){
  const price = rnd(50,400);
  const pct = [2,3,5,10,12,15,20][rnd(0,6)];
  const type = ['Rabatt','Skonto','Bestandsabweichung'][rnd(0,2)];
  const answer = (type==='Bestandsabweichung') ? price * (1 - pct/100) : price * (1 - pct/100);
  const text = (type==='Bestandsabweichung')
    ? `Inventur: Soll-Bestand ${price} Stück, Abweichung ${pct}% nach unten. Wie hoch ist der Ist‑Bestand?`
    : `${type} von ${pct}% auf ${price} € Einkaufswert. Neuer Preis?`;
  const steps = [
    `Ausgangswert: ${fmt(price)}${type==='Bestandsabweichung'?' Stk':' €'}`,
    `${pct}% von ${fmt(price)} = ${fmt(price*pct/100)}${type==='Bestandsabweichung'?' Stk':' €'}`,
    `Neuer Wert = ${fmt(price)} − ${fmt(price*pct/100)} = ${fmt(answer)}${type==='Bestandsabweichung'?' Stk':' €'}`
  ];
  return { q:text, a:Math.round(answer*100)/100, steps };
}
function genRule3(){
  const ma = rnd(3,9);
  const h  = rnd(1,4);
  const ma2= rnd(2,12);
  const text = `${ma} Mitarbeiter brauchen ${h} Stunden für einen Auftrag. Wie lange brauchen ${ma2} Mitarbeiter (proportional)?`;
  const a = h * ma / ma2;
  const steps = [
    `Leistung ∝ Mitarbeiterzahl`,
    `Zeit ~ 1/Mitarbeiter: t₂ = t₁ × (MA₁ / MA₂)`,
    `t₂ = ${h} × (${ma} / ${ma2}) = ${fmt(a)} Stunden`
  ];
  return { q:text, a:Math.round(a*100)/100, steps };
}
function genRule3Anti(){
  const st = rnd(2,6);
  const h  = rnd(3,7);
  const st2= rnd(1,5);
  const text = `${st} Stapler benötigen ${h} Stunden. Wie lange benötigen ${st2} Stapler (antiproportional)?`;
  const a = h * st / st2;
  const steps = [
    `Antiproportional: weniger Stapler ⇒ mehr Zeit`,
    `t₂ = t₁ × (St₁ / St₂)`,
    `t₂ = ${h} × (${st} / ${st2}) = ${fmt(a)} Stunden`
  ];
  return { q:text, a:Math.round(a*100)/100, steps };
}

/* === Bruch-Utils === */
function gcd(a,b){ a=Math.abs(a); b=Math.abs(b); while(b){ [a,b]=[b,a%b]; } return a||1; }
function lcm(a,b){ return Math.abs(a*b)/gcd(a,b); }
function simplify(n,d){ const g=gcd(n,d); return [n/g, d/g]; }
function toFrac(x, tol=1e-10){
  // Dezimal → Bruch (einfach): bis 3 Nachkommastellen
  const s = Math.round(x*1000);
  const n = s; const d = 1000;
  return simplify(n,d);
}

/* Bruchgeneratoren – komplett */
function genFraction(){
  const mode = ['simplify','toDecimal','toPercent','fromMixed','add','sub','mul','div'][rnd(0,7)];
  switch(mode){
    case 'simplify': {
      // Bruch kürzen
      const d= rnd(2,20), n=rnd(1,d-1)*rnd(2,5);
      const g=gcd(n,d);
      const [ns,ds]=simplify(n,d);
      const text = `Kürze den Bruch vollständig: ${n}/${d}`;
      const steps = [
        `ggT(${n}, ${d}) = ${g}`,
        `Zähler und Nenner durch ${g} teilen: ${n}:${g} = ${ns}, ${d}:${g} = ${ds}`,
        `Ergebnis: ${ns}/${ds} (= ${fmt(ns/ds)})`
      ];
      return { q:text, a:ns/ds, steps };
    }
    case 'toDecimal': {
      const den = rnd(3,20), num = rnd(1,den-1);
      const [ns,ds]=simplify(num,den);
      const text = `Wandle ${ns}/${ds} in eine Dezimalzahl um.`;
      const steps = [
        `Division: ${ns} ÷ ${ds}`,
        `≈ ${fmt(ns/ds)}`
      ];
      return { q:text, a:ns/ds, steps };
    }
    case 'toPercent': {
      const den = rnd(3,20), num = rnd(1,den-1);
      const [ns,ds]=simplify(num,den);
      const perc = (ns/ds)*100;
      const text = `Wandle ${ns}/${ds} in Prozent um. (Ergebnis in % eingeben)`;
      const steps = [
        `${ns}/${ds} × 100 = ${fmt(perc)} %`
      ];
      // Zielwert als Dezimal (weil Eingabe "12 %" zu 0.12 geparst wird)
      return { q:text, a:(perc/100), steps };
    }
    case 'fromMixed': {
      const A=rnd(1,3), num=rnd(1,3), den=rnd(2,8);
      const [ns,ds]=simplify(num,den);
      const val = A + ns/ds;
      const text = `Wandle die gemischte Zahl ${A} ${ns}/${ds} in eine Dezimalzahl um.`;
      const steps = [
        `${A} ${ns}/${ds} = ${A} + ${ns}/${ds}`,
        `= ${fmt(A + ns/ds)}`
      ];
      return { q:text, a:val, steps };
    }
    case 'add': {
      const a=rnd(1,7), b=rnd(2,9), c=rnd(1,7), d=rnd(2,9);
      const L = lcm(b,d);
      const s = a*(L/b) + c*(L/d);
      const [ns,ds]=simplify(s,L);
      const text = `Addiere die Brüche: ${a}/${b} + ${c}/${d}`;
      const steps = [
        `kgV(${b},${d}) = ${L}`,
        `Erweitern: ${a}/${b} = ${a*(L/b)}/${L}, ${c}/${d} = ${c*(L/d)}/${L}`,
        `Zähler addieren: ${(a*(L/b))} + ${(c*(L/d))} = ${s} → ${s}/${L}`,
        `Kürzen: ${s}/${L} = ${ns}/${ds} (= ${fmt(ns/ds)})`
      ];
      return { q:text, a:ns/ds, steps };
    }
    case 'sub': {
      const a=rnd(2,9), b=rnd(3,10), c=rnd(1,7), d=rnd(2,9);
      const L = lcm(b,d);
      const s = a*(L/b) - c*(L/d);
      const [ns,ds]=simplify(s,L);
      const text = `Subtrahiere die Brüche: ${a}/${b} − ${c}/${d}`;
      const steps = [
        `kgV(${b},${d}) = ${L}`,
        `Erweitern: ${a}/${b} = ${a*(L/b)}/${L}, ${c}/${d} = ${c*(L/d)}/${L}`,
        `Zähler subtrahieren: ${(a*(L/b))} − ${(c*(L/d))} = ${s} → ${s}/${L}`,
        `Kürzen: ${s}/${L} = ${ns}/${ds} (= ${fmt(ns/ds)})`
      ];
      return { q:text, a:ns/ds, steps };
    }
    case 'mul': {
      const a=rnd(1,7), b=rnd(2,9), c=rnd(1,7), d=rnd(2,9);
      const n=a*c, den=b*d;
      const [ns,ds]=simplify(n,den);
      const text = `Multipliziere die Brüche: ${a}/${b} · ${c}/${d}`;
      const steps = [
        `Zähler·Zähler: ${a}·${c} = ${n}`,
        `Nenner·Nenner: ${b}·${d} = ${den}`,
        `Kürzen: ${n}/${den} = ${ns}/${ds} (= ${fmt(ns/ds)})`
      ];
      return { q:text, a:ns/ds, steps };
    }
    default: { // 'div'
      const a=rnd(1,7), b=rnd(2,9), c=rnd(1,7), d=rnd(2,9);
      const n=a*d, den=b*c;
      const [ns,ds]=simplify(n,den);
      const text = `Dividiere die Brüche: ${a}/${b} : ${c}/${d}`;
      const steps = [
        `Durch einen Bruch teilen = mit Kehrwert multiplizieren`,
        `${a}/${b} · ${d}/${c} = ${a*d}/${b*c}`,
        `Kürzen: ${a*d}/${b*c} = ${ns}/${ds} (= ${fmt(ns/ds)})`
      ];
      return { q:text, a:ns/ds, steps };
    }
  }
}
function genAndler(){
  // C* (vereinfachte Andler)
  const B = rnd(500,5000); // Jahresbedarf
  const Kb= rnd(15,120);   // Bestellkosten
  const Kp= rnd(1,20);     // Lagerkosten je Stück/Jahr
  const a = Math.sqrt((2*B*Kb)/Kp);
  const text = `Andler-Formel: Jahresbedarf B=${B} Stück, Bestellkosten Kb=${Kb} €, Lagerkosten je Stück/Jahr Kp=${Kp} €. Optimale Bestellmenge?`;
  const steps = [
    `Formel: C* = √(2·B·Kb / Kp)`,
    `= √(2·${B}·${Kb} / ${Kp})`,
    `= √(${2*B*Kb} / ${Kp}) = ${fmt(a)} Stück`
  ];
  return { q:text, a:Math.round(a*100)/100, steps };
}
function genTurnover(){
  const avgStock = rnd(10000,80000);
  const cons = rnd(20000,120000);
  const a = cons / avgStock;
  const text = `Umschlagshäufigkeit: Jahresverbrauch = ${cons} €, durchschnittlicher Lagerbestand = ${avgStock} €. Wie hoch ist die Umschlagshäufigkeit?`;
  const steps = [
    `UH = Verbrauch / durchschnittlicher Lagerbestand`,
    `= ${cons} / ${avgStock} = ${fmt(a)}`
  ];
  return { q:text, a:Math.round(a*100)/100, steps };
}
function genCoverage(){
  const stock = rnd(500,5000);
  const daily = rnd(10,150);
  const a = stock / daily; // Tage
  const text = `Lagerreichweite: Bestand ${stock} Stück, täglicher Verbrauch ${daily} Stück. Reichweite in Tagen?`;
  const steps = [
    `Reichweite (Tage) = Bestand / Tagesverbrauch`,
    `= ${stock} / ${daily} = ${fmt(a)} Tage`
  ];
  return { q:text, a:Math.round(a*100)/100, steps };
}

function newTask(){
  const t = calcType.value;
  let obj;
  if(t==='percent') obj = genPercent();
  else if(t==='rule3') obj = genRule3();
  else if(t==='rule3anti') obj = genRule3Anti();
  else if(t==='fraction') obj = genFraction();
  else if(t==='andler') obj = genAndler();
  else if(t==='turnover') obj = genTurnover();
  else obj = genCoverage();
  currentTask = obj;
  showTask(obj);
}
function showTask(t){
  calcQ.textContent = t.q;
  calcAns.value = '';
  calcSolBox.style.display='none';
  calcSolBox.innerHTML='';
  calcFeedback.textContent=' ';
  calcFeedback.className='muted';
  calcAns.classList.remove('valid','invalid');
  calcAns.focus();

  // Enter → prüfen
  calcAns.onkeydown = (e)=>{
    if(e.key==='Enter'){ e.preventDefault(); evaluateAnswer(); }
  };

  // Notizen laden (pro Aufgaben-Hash)
  const key = 'notes_'+hashTask(t.q);
  notesArea.value = localStorage.getItem(key) || '';
  notesState.textContent = notesArea.value ? 'Notizen geladen.' : '';
}
function hashTask(s){
  let h=0; for(let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; } return 't'+Math.abs(h);
}

btnNew.onclick = newTask;
btnNext.onclick = newTask;
btnReset.onclick= ()=>{
  calcAns.value=''; calcSolBox.style.display='none'; calcSolBox.innerHTML=''; calcFeedback.textContent=' ';
  calcFeedback.className='muted'; calcAns.classList.remove('valid','invalid'); calcAns.focus();
};
btnSol.onclick = ()=>{
  if(!currentTask) return;
  calcSolBox.innerHTML = currentTask.steps.map(s=>`<div>• ${s}</div>`).join('');
  calcSolBox.style.display='block';
};
btnCheck.onclick = evaluateAnswer;

/* Notes speichern/löschen */
notesSave.onclick = ()=>{
  if(!currentTask) return;
  const key = 'notes_'+hashTask(currentTask.q);
  localStorage.setItem(key, notesArea.value||'');
  notesState.textContent = 'Notizen gespeichert.';
};
notesClear.onclick = ()=>{
  if(!currentTask) return;
  const key = 'notes_'+hashTask(currentTask.q);
  localStorage.removeItem(key);
  notesArea.value='';
  notesState.textContent = 'Notizen gelöscht.';
};

/* ====== Simulationen (Szenario: Warenannahme) ====== */
const SIM_LS_KEY = 'sim_progress';
const simSel = document.getElementById('sim-sel');
const simStepsEl = document.getElementById('sim-steps');
const simPickedEl = document.getElementById('sim-picked');
const simLivesEl = document.getElementById('sim-lives');
const simProgEl  = document.getElementById('sim-progress');
const simScoreEl = document.getElementById('sim-score');
const simResult  = document.getElementById('sim-result');
const btnSimStart= document.getElementById('sim-start');
const btnSimUndo = document.getElementById('sim-undo');
const btnSimReset= document.getElementById('sim-reset');
const btnSimCheck= document.getElementById('sim-check');

const SCENARIOS = [
  {
    id: 'warenannahme_std',
    title: 'Warenannahme – Standardprozess',
    steps: [
      'Fracht- / Begleitpapiere annehmen und prüfen',
      'Äußere Ladungssicherung und Unversehrtheit prüfen',
      'Entladen freigeben / Rampe zuweisen',
      'Ware sachgerecht entladen',
      'Stichproben / Menge / Identität prüfen',
      'Schäden dokumentieren & Abweichungen vermerken',
      'Ergebnisse im System buchen',
      'Einlagerung freigeben / Weiterleiten'
    ],
    tips: [
      'Ohne Papiere keine Freigabe.',
      'Erst Sicht‑ und Sicherungsprüfung, dann Entladen.',
      'Dokumentation vor dem Buchen spart Ärger.'
    ],
    lives: 3,
    perCorrect: 10,
    perWrong: -5
  }
];

let simState = {
  idx: 0,
  pool: [],
  target: [],
  picked: [],
  lives: 3,
  score: 0,
  locked: false
};

function loadSimProgress(){
  try{ return JSON.parse(localStorage.getItem(SIM_LS_KEY) || '{"runs":0,"wins":0,"best":0}'); }catch{ return {runs:0,wins:0,best:0}; }
}
function saveSimProgress(obj){ localStorage.setItem(SIM_LS_KEY, JSON.stringify(obj)); }

function refreshSimSelectors(){
  simSel.innerHTML = SCENARIOS.map(s => `<option value="${s.id}">${s.title}</option>`).join('');
}

function simUpdateHUD(){
  simLivesEl.textContent = simState.lives;
  simProgEl.textContent  = `${simState.picked.length}/${simState.target.length}`;
  simScoreEl.textContent = simState.score;
}

function simRenderPool(){
  simStepsEl.innerHTML = '';
  simState.pool.forEach((txt, i) => {
    const b = document.createElement('button');
    b.className = 'step';
    b.innerHTML = `<span class="badge">#${i+1}</span> <span>${txt}</span>`;
    b.onclick = () => simPick(txt, b);
    simStepsEl.appendChild(b);
  });
}

function simRenderPicked(){
  simPickedEl.innerHTML = simState.picked
    .map((t,i)=>`<span class="queue-chip"><b>${i+1}.</b> ${t}</span>`)
    .join('');
}

function simInitScenario(id){
  const sc = SCENARIOS.find(s=>s.id===id) || SCENARIOS[0];
  simState = {
    idx: 0,
    pool: shuffle(sc.steps),
    target: sc.steps.slice(),
    picked: [],
    lives: sc.lives,
    score: 0,
    locked: false,
    cfg: sc
  };
  simResult.style.display='none';
  simResult.textContent='';
  simRenderPool();
  simRenderPicked();
  simUpdateHUD();
}

async function simLogRunToSupabase({scenarioId, score, steps, wrongClicks, success}){
  if(!supa) return;
  try{
    const { data:{user} } = await supa.auth.getUser();
    if(!user) return;
    // Tabelle optional: sim_runs (user_id text, scenario_id text, score int4, steps int4, wrong int4, success bool, ts timestamptz default now())
    await supa.from('sim_runs').insert({
      user_id: user.id,
      scenario_id: scenarioId,
      score,
      steps,
      wrong: wrongClicks,
      success
    });
  }catch(e){ /* ignore if table not present */ }
}

let wrongClicksSession = 0;

function simPick(txt, btn){
  if(simState.locked || simState.lives<=0) return;
  const expect = simState.target[simState.picked.length];
  if(txt === expect){
    simState.picked.push(txt);
    btn.classList.add('correct');
    btn.setAttribute('disabled','true');
    simState.score += simState.cfg.perCorrect;
    simRenderPicked();
    simUpdateHUD();

    if(simState.picked.length === simState.target.length){
      const stats = loadSimProgress();
      stats.runs += 1; stats.wins += 1; stats.best = Math.max(stats.best, simState.score);
      saveSimProgress(stats);

      simResult.style.display='block';
      simResult.innerHTML = `✅ <b>Erfolgreich abgeschlossen!</b><br/>Punkte: <b>${simState.score}</b> • Versuche: <b>${stats.runs}</b> • Bestleistung: <b>${stats.best}</b>`;
      simState.locked = true;
      simLogRunToSupabase({scenarioId: simState.cfg.id, score: simState.score, steps: simState.target.length, wrongClicks: wrongClicksSession, success: true});
    }
  } else {
    wrongClicksSession += 1;
    simState.lives -= 1;
    simState.score = Math.max(0, simState.score + simState.cfg.perWrong);
    btn.classList.add('wrong');
    setTimeout(()=>btn.classList.remove('wrong'), 450);
    simUpdateHUD();
    if(simState.lives<=0){
      const stats = loadSimProgress(); stats.runs += 1; saveSimProgress(stats);
      simResult.style.display='block';
      simResult.innerHTML = `❌ <b>Abgebrochen</b> – keine Leben mehr.<br/>Richtige Reihenfolge wäre:<br/>• ${simState.target.join('<br/>• ')}`;
      simState.locked = true;
      simLogRunToSupabase({scenarioId: simState.cfg.id, score: simState.score, steps: simState.target.length, wrongClicks: wrongClicksSession, success: false});
    }
  }
}

btnSimStart.onclick = () => { wrongClicksSession = 0; simInitScenario(simSel.value); };
btnSimReset.onclick = () => { wrongClicksSession = 0; simInitScenario(simSel.value); };
btnSimUndo.onclick = () => {
  if(simState.locked || simState.picked.length===0) return;
  const last = simState.picked.pop();
  [...simStepsEl.querySelectorAll('.step')].forEach(b=>{
    if(b.textContent.includes(last)){ b.classList.remove('correct'); b.removeAttribute('disabled'); }
  });
  simRenderPicked(); simUpdateHUD();
};
btnSimCheck.onclick = () => {
  if(simState.locked) return;
  const ok = simState.picked.length === simState.target.length &&
             simState.picked.every((t,i)=>t===simState.target[i]);
  const stats = loadSimProgress(); stats.runs += 1; if(ok){ stats.wins += 1; stats.best = Math.max(stats.best, simState.score); }
  saveSimProgress(stats);
  simResult.style.display='block';
  if(ok){
    simResult.innerHTML = `✅ <b>Richtig!</b> Punkte: <b>${simState.score}</b> • Best: <b>${stats.best}</b>`;
    simLogRunToSupabase({scenarioId: simState.cfg.id, score: simState.score, steps: simState.target.length, wrongClicks: wrongClicksSession, success: true});
  }else{
    simResult.innerHTML = `❌ <b>Nicht ganz.</b><br/>Richtig wäre:<br/>• ${simState.target.join('<br/>• ')}`;
    simLogRunToSupabase({scenarioId: simState.cfg.id, score: simState.score, steps: simState.target.length, wrongClicks: wrongClicksSession, success: false});
  }
  simState.locked = true;
};

function initSimModule(){
  refreshSimSelectors();
  simInitScenario(SCENARIOS[0].id);
}

/* ====== Boot ====== */
window.addEventListener('DOMContentLoaded', initClient);
</script>
</body>
</html>
